# Authentication & Authorization Security Tests
# Fireside Capital Penetration Test

$supabaseUrl = "https://qqtiofdqplwycnwplmen.supabase.co"
$anonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxdGlvZmRxcGx3eWNud3BsbWVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MDY5NDIsImV4cCI6MjA4NTQ4Mjk0Mn0.Vjg7hQDPWJwmbkQccw5CXH_Npi2YJgJbt-OAEnF_P5g"

$results = @()

Write-Host "========================================" -ForegroundColor Cyan
Write-Host "Fireside Capital Penetration Test" -ForegroundColor Cyan
Write-Host "Test: Authentication & Authorization" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

# ==========================================
# Test 1: Login with SQL Injection Payloads
# ==========================================
Write-Host "[TEST 1] SQL Injection in Login Form" -ForegroundColor Yellow

$sqlPayloads = @(
    "' OR '1'='1",
    "admin'--",
    "' OR 1=1--",
    "'; DROP TABLE bills--"
)

foreach ($payload in $sqlPayloads) {
    Write-Host "  Testing payload: $payload" -ForegroundColor Gray
    
    try {
        $body = @{
            email = $payload
            password = "anything"
        } | ConvertTo-Json
        
        $headers = @{
            "apikey" = $anonKey
            "Content-Type" = "application/json"
        }
        
        $response = Invoke-WebRequest -Uri "$supabaseUrl/auth/v1/token?grant_type=password" `
            -Method POST `
            -Headers $headers `
            -Body $body `
            -ErrorAction Stop
        
        $results += @{
            TestID = "AUTH-SQLI-01"
            Severity = "CRITICAL"
            Status = "FAIL"
            Finding = "SQL Injection succeeded with payload: $payload"
            Response = $response.StatusCode
        }
        Write-Host "  ❌ VULNERABLE - Login succeeded!" -ForegroundColor Red
    }
    catch {
        Write-Host "  ✅ BLOCKED - Payload rejected" -ForegroundColor Green
    }
}

$results += @{
    TestID = "AUTH-SQLI-01"
    Severity = "CRITICAL"
    Status = "PASS"
    Finding = "SQL Injection in login form properly blocked"
}

# ==========================================
# Test 2: Weak Password Policy
# ==========================================
Write-Host "`n[TEST 2] Weak Password Policy" -ForegroundColor Yellow

$weakPasswords = @("1", "12", "123", "1234", "12345")

foreach ($pwd in $weakPasswords) {
    Write-Host "  Testing password length: $($pwd.Length)" -ForegroundColor Gray
    
    try {
        $body = @{
            email = "test-weak-pwd-$([guid]::NewGuid())@test.com"
            password = $pwd
        } | ConvertTo-Json
        
        $headers = @{
            "apikey" = $anonKey
            "Content-Type" = "application/json"
        }
        
        $response = Invoke-WebRequest -Uri "$supabaseUrl/auth/v1/signup" `
            -Method POST `
            -Headers $headers `
            -Body $body `
            -ErrorAction Stop
        
        if ($pwd.Length -lt 6) {
            $results += @{
                TestID = "AUTH-WEAK-01"
                Severity = "HIGH"
                Status = "FAIL"
                Finding = "Weak password accepted: $pwd (length: $($pwd.Length))"
            }
            Write-Host "  ❌ VULNERABLE - Weak password accepted!" -ForegroundColor Red
        }
    }
    catch {
        $error = $_.ErrorDetails.Message | ConvertFrom-Json
        if ($error.msg -like "*password*" -or $error.message -like "*password*") {
            Write-Host "  ✅ BLOCKED - Password too weak" -ForegroundColor Green
        }
        else {
            Write-Host "  ⚠️  ERROR: $($error.message)" -ForegroundColor Yellow
        }
    }
}

# ==========================================
# Test 3: Brute Force Protection
# ==========================================
Write-Host "`n[TEST 3] Brute Force Protection" -ForegroundColor Yellow

$attempts = 0
$blocked = $false

for ($i = 1; $i -le 10; $i++) {
    Write-Host "  Attempt $i/10..." -ForegroundColor Gray
    
    try {
        $body = @{
            email = "matt@firesidecloudsolutions.com"
            password = "wrong-password-$i"
        } | ConvertTo-Json
        
        $headers = @{
            "apikey" = $anonKey
            "Content-Type" = "application/json"
        }
        
        $response = Invoke-WebRequest -Uri "$supabaseUrl/auth/v1/token?grant_type=password" `
            -Method POST `
            -Headers $headers `
            -Body $body `
            -ErrorAction Stop
        
        $attempts++
    }
    catch {
        $error = $_.ErrorDetails.Message
        if ($error -like "*rate limit*" -or $error -like "*too many*") {
            $blocked = $true
            Write-Host "  ✅ BLOCKED at attempt $i - Rate limiting active" -ForegroundColor Green
            break
        }
        $attempts++
    }
    
    Start-Sleep -Milliseconds 500
}

if (-not $blocked -and $attempts -ge 10) {
    $results += @{
        TestID = "AUTH-BRUTE-01"
        Severity = "HIGH"
        Status = "FAIL"
        Finding = "No rate limiting detected after $attempts failed login attempts"
    }
    Write-Host "  ❌ VULNERABLE - No rate limiting!" -ForegroundColor Red
}
else {
    $results += @{
        TestID = "AUTH-BRUTE-01"
        Severity = "HIGH"
        Status = "PASS"
        Finding = "Rate limiting active - blocked at attempt $i"
    }
}

# ==========================================
# Test 4: Anonymous API Access
# ==========================================
Write-Host "`n[TEST 4] Anonymous Data Access (No Auth)" -ForegroundColor Yellow

try {
    $headers = @{
        "apikey" = $anonKey
    }
    
    $response = Invoke-RestMethod -Uri "$supabaseUrl/rest/v1/bills?select=*" `
        -Headers $headers `
        -ErrorAction Stop
    
    if ($response.Count -gt 0) {
        $results += @{
            TestID = "AUTH-ANON-01"
            Severity = "CRITICAL"
            Status = "FAIL"
            Finding = "Anonymous access to bills table - retrieved $($response.Count) records without authentication"
        }
        Write-Host "  ❌ CRITICAL - Anonymous data access!" -ForegroundColor Red
    }
    else {
        Write-Host "  ✅ PASS - No data returned without auth" -ForegroundColor Green
    }
}
catch {
    Write-Host "  ✅ PASS - Anonymous access blocked" -ForegroundColor Green
    $results += @{
        TestID = "AUTH-ANON-01"
        Severity = "CRITICAL"
        Status = "PASS"
        Finding = "Anonymous access properly blocked by RLS"
    }
}

# ==========================================
# Test 5: Cross-User Data Access (Horizontal Privilege Escalation)
# ==========================================
Write-Host "`n[TEST 5] Horizontal Privilege Escalation" -ForegroundColor Yellow
Write-Host "  (Manual test required - login as Matt and attempt to access Brittany's data)" -ForegroundColor Gray

# This test requires actual session tokens, which we'll document in the manual test section

$results += @{
    TestID = "AUTH-HORIZ-01"
    Severity = "CRITICAL"
    Status = "MANUAL"
    Finding = "Requires manual testing with authenticated sessions"
}

# ==========================================
# Generate Report
# ==========================================
Write-Host "`n========================================" -ForegroundColor Cyan
Write-Host "TEST RESULTS SUMMARY" -ForegroundColor Cyan
Write-Host "========================================`n" -ForegroundColor Cyan

$critical = ($results | Where-Object { $_.Severity -eq "CRITICAL" -and $_.Status -eq "FAIL" }).Count
$high = ($results | Where-Object { $_.Severity -eq "HIGH" -and $_.Status -eq "FAIL" }).Count
$passed = ($results | Where-Object { $_.Status -eq "PASS" }).Count

Write-Host "CRITICAL Issues: $critical" -ForegroundColor $(if ($critical -gt 0) { "Red" } else { "Green" })
Write-Host "HIGH Issues: $high" -ForegroundColor $(if ($high -gt 0) { "Red" } else { "Green" })
Write-Host "Tests Passed: $passed" -ForegroundColor Green

Write-Host "`n----------------------------------------`n" -ForegroundColor Gray

foreach ($result in $results) {
    $color = switch ($result.Status) {
        "FAIL" { "Red" }
        "PASS" { "Green" }
        "MANUAL" { "Yellow" }
        default { "Gray" }
    }
    
    Write-Host "[$($result.TestID)] $($result.Status)" -ForegroundColor $color
    Write-Host "  Severity: $($result.Severity)" -ForegroundColor Gray
    Write-Host "  Finding: $($result.Finding)" -ForegroundColor Gray
    Write-Host ""
}

# Export results
$results | ConvertTo-Json -Depth 3 | Out-File "pentest-workspace/auth-test-results.json"
Write-Host "Results exported to: auth-test-results.json`n" -ForegroundColor Cyan
