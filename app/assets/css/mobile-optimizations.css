/* =================================================================
   MOBILE OPTIMIZATIONS — Fix Stacking Issues
   Improves mobile UX with responsive layouts and reduced heights
   Updated: February 2025 — Brand polish enhancement
   ================================================================= */

/* =================================================================
   GLOBAL MOBILE FIXES — Prevent horizontal overflow
   ================================================================= */

@media (max-width: 767.98px) {
  /* Prevent body overflow */
  body {
    overflow-x: hidden;
    max-width: 100vw;
  }

  /* Ensure all containers fit viewport */
  /* ISSUE 2 FIX: Force row to full width with no side margins */
  .container,
  .container-fluid,
  .row {
    max-width: 100%;
    width: 100% !important;
    overflow-x: hidden;
    margin-left: 0 !important;
    margin-right: 0 !important;
  }
  
  /* CRITICAL FIX: Ensure all cards are full-width on mobile */
  /* ISSUE 2 FIX: Enhanced to prevent any card width variations */
  .card,
  .dashboard-card,
  .stat-card,
  .empty-state,
  .chart-card,
  .summary-card,
  .table-card,
  .bills-stats,
  .budget-header,
  .page-header,
  div[class*="card"],
  [class*="stat-card"],
  [class*="chart-card"] {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    flex-basis: 100% !important;
    flex: 1 1 100% !important;
  }
  
  /* ISSUE 2 FIX: Force ALL Bootstrap columns to full width on mobile */
  /* Enhanced selectors to override all possible Bootstrap grid classes */
  .row > [class*="col-"],
  .row > [class*="col"],
  .row > [class^="col-"],
  .row > div[class*="col-"],
  .row > div[class*="col"] {
    width: 100% !important;
    flex: 0 0 100% !important;
    max-width: none !important;
    min-width: 100% !important;
    flex-basis: 100% !important;
    margin-bottom: var(--space-3);
  }
  
  /* Ensure all cards inside columns are uniform width (fixes varying card widths on mobile) */
  .row > [class*="col-"] > .card,
  .row > [class*="col-"] > .dashboard-card,
  .row > [class*="col-"] > .stat-card,
  .row > [class*="col-"] > .chart-card,
  .row > [class*="col-"] .card,
  .row > [class*="col-"] .dashboard-card,
  .row > [class*="col-"] .stat-card,
  .row > [class*="col-"] .chart-card {
    width: 100% !important;
    max-width: 100% !important;
    min-width: 100% !important;
    margin-left: 0 !important;
    margin-right: 0 !important;
    flex: 1 1 100% !important;
  }
  
  /* Ensure main content uses full width with proper padding */
  /* ISSUE 1 FIX: Add safe-area-inset-top to padding */
  .main-content {
    width: 100%;
    max-width: 100%;
    padding-left: var(--space-3);
    padding-right: var(--space-3);
    padding-top: calc(76px + env(safe-area-inset-top)) !important; /* Space for fixed hamburger + bell/welcome row + notch */
  }
  
  /* Fix container widths */
  .container,
  .container-fluid {
    width: 100% !important;
    max-width: 100% !important;
    padding-left: var(--space-3);
    padding-right: var(--space-3);
  }
  
  /* Ensure card bodies use full width */
  .card-body {
    width: 100%;
    padding: var(--space-3);
  }
  
  /* Empty state cards should be centered and full-width */
  .empty-state {
    text-align: center;
    padding: var(--space-4) var(--space-3);
  }

  /* Tables must scroll horizontally */
  .table-responsive {
    display: block;
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 1rem;
  }

  .table {
    min-width: 600px; /* Force scroll for dense tables */
    margin-bottom: 0;
  }
  
  /* Budget table specific (wider columns) */
  .budget-table {
    min-width: 600px; /* Force horizontal scroll */
    font-size: 0.85rem;
  }
  
  .budget-table th,
  .budget-table td {
    padding: 8px 12px;
    white-space: nowrap;
  }

  /* Ensure modals fit on screen */
  .modal-dialog {
    margin: 0.5rem;
    max-width: calc(100vw - 1rem);
  }

  /* Button groups stack vertically */
  .page-header-actions {
    width: 100%;
    flex-direction: column !important;
  }

  .page-header-actions .btn,
  .page-header-actions .btn-group {
    width: 100%;
  }

  .btn-group-vertical {
    width: 100%;
  }

  .btn-group .btn {
    width: 100%;
  }
}

/* =================================================================
   STAT CARDS — Better Mobile Stacking
   ================================================================= */

/* Mid-range phones (480px - 768px): 2-column grid for stat cards */
@media (min-width: 480px) and (max-width: 767.98px) {
  .dashboard-card {
    padding: var(--space-4);
  }
  
  .dashboard-card h5 {
    font-size: 10px;
    margin-bottom: var(--space-1);
  }
  
  .dashboard-card p {
    font-size: 1.5rem;
    margin-top: var(--space-1);
  }
}

/* Small mobile (<480px): Reduce card padding and font sizes */
@media (max-width: 479.98px) {
  /* Extra small screens - even tighter spacing */
  .main-content {
    padding-left: var(--space-2);
    padding-right: var(--space-2);
  }
  
  .container,
  .container-fluid {
    padding-left: var(--space-2);
    padding-right: var(--space-2);
  }
  
  .dashboard-card {
    padding: var(--space-3-5);
  }
  
  .dashboard-card h5 {
    font-size: 10px;
    margin-bottom: var(--space-1);
  }
  
  .dashboard-card p {
    font-size: 1.4rem;
    margin-top: var(--space-1);
  }
  
  /* Reduce gap between cards */
  .row.g-3 {
    --bs-gutter-x: 0.75rem;
    --bs-gutter-y: 0.75rem;
  }
  
  /* Prevent awkward button text wrapping */
  .btn {
    font-size: 0.85rem;
    padding: 10px 16px;
    white-space: nowrap;
    overflow: hidden;
    text-overflow: ellipsis;
  }
  
  /* Stack buttons vertically on very small screens for better UX */
  .page-header-actions .btn {
    width: 100%;
    margin-bottom: 8px;
    white-space: normal; /* Allow wrap on full-width buttons */
    text-align: center;
  }
  
  /* Ensure button groups stack properly */
  .page-header-actions {
    display: flex;
    flex-direction: column;
    gap: 8px;
  }
}

/* =================================================================
   CHART CARDS — Responsive Heights
   ================================================================= */

/* Tablets and below: Reduce chart heights */
@media (max-width: 991.98px) {
  .chart-card {
    padding: var(--space-4);
  }
  
  .chart-card h5 {
    font-size: 11px;
    margin-bottom: var(--space-3);
  }
  
  .chart-wrapper {
    min-height: 220px !important;
  }
  
  .chart-wrapper[style*="height: 300px"] {
    height: 240px !important;
  }
  
  .chart-wrapper[style*="height: 260px"] {
    height: 220px !important;
  }
}

/* Mobile: Further reduce chart heights */
@media (max-width: 767.98px) {
  .chart-card {
    padding: var(--space-3-5);
  }
  
  .chart-wrapper {
    position: relative;
    min-height: 200px !important;
    background: transparent !important;
  }
  
  .chart-wrapper canvas {
    background: transparent !important;
    max-width: 100%;
  }
  
  .chart-wrapper[style*="height: 300px"] {
    height: 220px !important;
  }
  
  .chart-wrapper[style*="height: 260px"] {
    height: 200px !important;
  }
}

/* Small mobile: Compact chart cards */
@media (max-width: 479.98px) {
  .chart-card {
    padding: var(--space-3);
  }
  
  .chart-card h5 {
    font-size: 10px;
    margin-bottom: var(--space-2);
  }
  
  .chart-wrapper {
    min-height: 180px !important;
  }
  
  .chart-wrapper[style*="height: 300px"] {
    height: 200px !important;
  }
  
  .chart-wrapper[style*="height: 260px"] {
    height: 180px !important;
  }
  
  /* Reduce spacing between chart sections */
  .mb-4 {
    margin-bottom: var(--space-3) !important;
  }
}

/* =================================================================
   UPCOMING PAYMENTS LIST — Optimize mobile view
   ================================================================= */

@media (max-width: 767.98px) {
  #upcomingPaymentsList {
    max-height: 200px !important;
  }
}

@media (max-width: 479.98px) {
  #upcomingPaymentsList {
    max-height: 180px !important;
    font-size: 0.85rem;
  }
  
  #upcomingPaymentsList strong {
    font-size: 0.9rem;
  }
  
  #upcomingPaymentsList small {
    font-size: 0.75rem;
  }
  
  #upcomingPaymentsList > div {
    padding: var(--space-2) 0;
  }
}

/* =================================================================
   EMERGENCY FUND PROGRESS — Mobile optimization
   ================================================================= */

@media (max-width: 479.98px) {
  #emergencyFundChartWrapper {
    height: 180px !important;
    padding: var(--space-2);
  }
  
  #emergencyFundChartWrapper p,
  #emergencyFundChartWrapper .text-center {
    font-size: 0.85rem;
  }
  
  #emergencyFundChartWrapper .btn {
    font-size: 0.8rem;
    padding: var(--space-2) var(--space-3);
  }
}

/* =================================================================
   PAGE HEADER — Mobile optimization
   ================================================================= */

@media (max-width: 767.98px) {
  .main-content .d-flex.mb-4 {
    margin-bottom: var(--space-3) !important;
  }
}

@media (max-width: 479.98px) {
  .main-content .d-flex.mb-4 {
    margin-bottom: var(--space-2-5) !important;
  }
}

/* =================================================================
   BUTTON GROUPS — Stack better on mobile
   ================================================================= */

@media (max-width: 479.98px) {
  .btn-group {
    flex-wrap: wrap;
  }
  
  .btn-sm {
    font-size: 0.75rem;
    padding: var(--space-1-5) var(--space-2-5);
  }
}

/* =================================================================
   MODALS — Better mobile experience
   ================================================================= */

@media (max-width: 479.98px) {
  .modal-dialog {
    margin: var(--space-2);
  }
  
  .modal-content {
    border-radius: var(--radius-lg);
  }
  
  .modal-header,
  .modal-footer {
    padding: var(--space-3) var(--space-4);
  }
  
  .modal-body {
    padding: var(--space-4);
    font-size: 0.9rem;
  }
  
  .modal-title {
    font-size: 1.1rem;
  }
}

/* =================================================================
   FORMS — Mobile-friendly inputs
   ================================================================= */

@media (max-width: 479.98px) {
  .form-label {
    font-size: 0.85rem;
    margin-bottom: var(--space-1);
  }
  
  .form-control,
  .form-select {
    font-size: 16px; /* Prevents iOS zoom */
    padding: var(--space-2-5) var(--space-3);
  }
  
  .form-group,
  .mb-3 {
    margin-bottom: var(--space-2-5) !important;
  }
}

/* =================================================================
   HORIZONTAL SCROLL FOR DENSE CONTENT (OPTION 3)
   - For sections that shouldn't stack, use horizontal scroll
   ================================================================= */

/* Stats row: Enable horizontal scroll as alternative (disabled by default) */
.stats-scroll-mobile {
  display: none;
}

@media (max-width: 575.98px) {
  .stats-scroll-mobile {
    display: flex;
    overflow-x: auto;
    gap: var(--space-3);
    padding-bottom: var(--space-2);
    -webkit-overflow-scrolling: touch;
    scroll-snap-type: x mandatory;
  }
  
  .stats-scroll-mobile .dashboard-card {
    min-width: 280px;
    flex-shrink: 0;
    scroll-snap-align: start;
  }
}

/* =================================================================
   COLLAPSIBLE SECTIONS (OPTION 2)
   - For dense content, use expand/collapse
   ================================================================= */

.mobile-collapse {
  border: 1px solid var(--color-border-subtle);
  border-radius: var(--radius-md);
  margin-bottom: var(--space-3);
}

.mobile-collapse summary {
  padding: var(--space-3);
  cursor: pointer;
  font-weight: var(--weight-semibold);
  list-style: none;
  display: flex;
  justify-content: space-between;
  align-items: center;
  color: var(--color-text-primary);
  user-select: none;
}

.mobile-collapse summary::-webkit-details-marker {
  display: none;
}

.mobile-collapse summary::after {
  content: "▼";
  font-size: 0.8em;
  transition: transform var(--duration-normal) var(--ease-default);
}

.mobile-collapse[open] summary::after {
  transform: rotate(-180deg);
}

.mobile-collapse .collapse-content {
  padding: 0 var(--space-3) var(--space-3);
}

/* =================================================================
   RESPONSIVE TEXT SIZING
   ================================================================= */

@media (max-width: 479.98px) {
  /* Ensure readable but compact text */
  h1 { font-size: 1.75rem; }
  h2 { font-size: 1.5rem; }
  h3 { font-size: 1.25rem; }
  h4 { font-size: 1.1rem; }
  h5 { font-size: 0.95rem; }
  
  /* Body text */
  body { font-size: 0.9rem; }
  
  /* Small text even smaller */
  small, .text-muted { font-size: 0.8rem; }
}

/* =================================================================
   SCROLL LOCK UTILITY — Fix sidebar scroll lock bug
   ISSUE 3 FIX: Use CSS class instead of inline styles for reliable scroll restoration
   ================================================================= */

body.sidebar-open {
  overflow: hidden !important;
  position: fixed !important;
  width: 100% !important;
  top: var(--scroll-lock-offset, 0) !important;
  left: 0 !important;
  right: 0 !important;
}

/* =================================================================
   MOBILE TOP BAR — Bell + Welcome in same row as hamburger
   Targets #loggedInState directly so it works on ALL pages
   (dashboard, assets, bills, etc. have different HTML structures)
   ================================================================= */

@media (max-width: 991.98px) {
  /* ---- Hamburger toggle ---- */
  /* FIXED: Must be position:fixed to align with bell/welcome */
  /* ISSUE 1 FIX: Use safe-area-inset-top for iOS notch compatibility */
  .sidebar-toggle {
    position: fixed !important;
    top: max(12px, env(safe-area-inset-top)) !important;
    left: 16px !important;
    z-index: 1000 !important; /* Above sidebar so X button is always clickable */
    width: 48px;
    height: 48px;
    background: var(--color-bg-2);
    border: 1px solid var(--color-border-subtle);
    border-radius: var(--radius-md);
    display: inline-flex !important; /* FIXED: Match auth buttons for pixel-perfect vertical alignment */
    align-items: center;
    justify-content: center;
    box-sizing: border-box; /* Include border in 48px height */
    padding: 0;
    margin: 0;
    vertical-align: top !important; /* FIXED: Ensure consistent baseline alignment with auth buttons */
  }

  /* Center the hamburger/close icon properly */
  .sidebar-toggle i {
    font-size: 1.75rem;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 100%;
    height: 100%;
    line-height: 1;
  }

  /* Push sidebar content below the hamburger button */
  .sidebar {
    z-index: 900 !important; /* ABOVE overlay so menu items are clickable */
    padding-top: 72px !important;
    width: 85% !important; /* Use 85% width on mobile for better UX */
    max-width: 320px !important; /* Cap at 320px on larger phones */
  }
  
  /* Ensure proper z-index stacking:
     Hamburger/X (1000) > Sidebar (900) > Overlay (450) > Main content (1) */
  .sidebar-overlay {
    z-index: 450 !important; /* Below sidebar, above main content */
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: rgba(0, 0, 0, 0.5);
    cursor: pointer;
  }

  /* ---- Bell + Welcome OR Login + Sign Up: fixed top-right on ALL pages ---- */
  /* ISSUE 1 FIX: Use safe-area-inset-top for iOS notch compatibility */
  #loggedInState,
  #loggedOutState {
    position: fixed !important;
    top: max(12px, env(safe-area-inset-top)) !important;
    right: 16px;
    z-index: 1000; /* Same as hamburger for alignment */
    margin: 0 !important;
  }
  
  /* Only apply flex when visible (not d-none) */
  #loggedInState:not(.d-none),
  #loggedOutState:not(.d-none) {
    display: flex !important;
    align-items: center;
    gap: 8px;
  }

  /* CRITICAL: Override Bootstrap d-none so elements stay in fixed layout tree.
     display:none→block causes a 1-frame layout glitch on mobile Safari/Chrome
     where the element renders at flow position before fixed positioning applies.
     By keeping display:block + visibility:hidden, position:fixed always holds. */
  #loggedInState.d-none,
  #loggedOutState.d-none {
    display: block !important;
    visibility: hidden;
  }

  /* Prevent flash of wrong auth state — hide BOTH states until JS resolves */
  body:not(.auth-resolved) #loggedOutState,
  body:not(.auth-resolved) #loggedInState {
    opacity: 0 !important;
    pointer-events: none;
    visibility: hidden;
  }

  /* Smooth fade-in once auth resolves */
  body.auth-resolved #loggedOutState:not(.d-none),
  body.auth-resolved #loggedInState:not(.d-none) {
    opacity: 1;
    visibility: visible;
    pointer-events: auto;
    transition: opacity 0.15s ease;
  }

  /* Match button heights in the top bar */
  #loggedOutState .btn,
  #loggedInState .btn {
    height: 48px; /* Match hamburger height */
    padding-top: 0;
    padding-bottom: 0;
    display: inline-flex;
    align-items: center;
    font-size: 13px;
    box-sizing: border-box;
    margin: 0;
  }

  /* Fix icon centering in buttons on mobile */
  /* Mobile .btn padding override was breaking .btn-icon centering */
  .btn.btn-icon {
    padding: 0 !important;
    display: inline-flex !important;
    align-items: center !important;
    justify-content: center !important;
  }

  /* CRITICAL FIX: Welcome dropdown button text wrapping */
  /* The global * { max-width: 100%; } constrains the button width, causing text wrap */
  /* Target #userDropdown directly — button does NOT have .dropdown-toggle class */
  #userDropdown,
  #loggedInState .dropdown > .btn,
  #loggedInState .dropdown-toggle {
    white-space: nowrap !important;
    max-width: none !important; /* Override global * { max-width: 100% } */
    flex-shrink: 0 !important; /* Prevent flex container from shrinking the button */
    overflow: visible !important;
  }

  /* The spans inside the welcome button also need nowrap */
  #userDropdown *,
  #loggedInState .dropdown > .btn * {
    white-space: nowrap !important;
    max-width: none !important;
  }

  /* User dropdown menu: ensure it opens visibly on mobile */
  #loggedInState .dropdown-menu {
    position: fixed !important;
    top: calc(max(12px, env(safe-area-inset-top)) + 56px) !important; /* Below the welcome button */
    right: 16px !important;
    left: auto !important;
    z-index: 1001 !important;
    min-width: 200px;
  }

  /* Bigger notification bell */
  #notificationBell {
    width: 48px;
    height: 48px;
  }

  #notificationBell .bi-bell {
    font-size: 1.35rem;
  }
}

/* =================================================================
   NOTIFICATION DROPDOWN — Full-screen mobile takeover
   Covers entire viewport below top bar, solid background,
   scrolls internally. Tap the bell again to close.
   ================================================================= */

@media (max-width: 991.98px) {
  #notificationDropdown .dropdown-menu {
    position: fixed !important;
    top: 68px !important;
    left: 0 !important;
    right: 0 !important;
    bottom: 0 !important;
    width: 100% !important;
    max-width: 100% !important;
    height: auto !important;
    max-height: none !important;
    overflow-y: auto !important;
    border-radius: 0 !important;
    z-index: 499 !important;
    background-color: var(--color-bg-1) !important;
    margin: 0 !important;
    transform: none !important;
    border: none !important;
    border-top: 1px solid var(--color-border-subtle) !important;
    box-shadow: none !important;
    min-width: 0 !important;
  }

  /* Hide scrollbar but keep scroll functionality */
  #notificationDropdown .dropdown-menu {
    scrollbar-width: none;
    -ms-overflow-style: none;
  }

  #notificationDropdown .dropdown-menu::-webkit-scrollbar {
    display: none;
  }

  /* Let notification text wrap naturally — no truncation */
  #notificationDropdown .dropdown-menu * {
    white-space: normal !important;
    word-wrap: break-word !important;
    overflow-wrap: break-word !important;
  }

  /* Keep header row on one line */
  #notificationDropdown .dropdown-header {
    white-space: nowrap !important;
  }
}

/* =================================================================
   USER DROPDOWN — Better mobile positioning
   ================================================================= */

@media (max-width: 479.98px) {
  .dropdown-menu {
    font-size: 0.9rem;
  }
  
  .dropdown-item {
    padding: var(--space-2-5) var(--space-3);
  }
}

/* =================================================================
   LOADING STATES — Mobile optimization
   ================================================================= */

@media (max-width: 479.98px) {
  .spinner-border {
    width: 2rem;
    height: 2rem;
  }
  
  .spinner-border-sm {
    width: 1rem;
    height: 1rem;
  }
  
  /* Full-width sidebar on small screens to prevent content bleed */
  .sidebar {
    width: 100% !important;
    max-width: 100% !important;
  }
}

/* =================================================================
   ACCESSIBILITY — Enhanced touch targets
   ================================================================= */

@media (max-width: 767.98px) and (pointer: coarse) {
  /* Minimum 44x44px touch targets */
  .btn,
  .form-control,
  .form-select,
  a {
    min-height: 44px;
  }
  
  /* Sidebar links */
  .sidebar a {
    min-height: 48px;
    padding: var(--space-3) var(--space-5);
  }
  
  /* Table action buttons */
  .table .btn-sm {
    min-height: 40px;
    min-width: 40px;
  }
}

/* =================================================================
   ADDITIONAL RESPONSIVE FIXES — Final audit pass
   ================================================================= */

@media (max-width: 767.98px) {
  /* Ensure dropdown menus don't overflow viewport */
  .dropdown-menu {
    max-width: calc(100vw - 2rem) !important;
    max-height: 70vh;
    overflow-y: auto;
  }
  
  /* Fix page header button wrapping */
  .page-header-actions {
    width: 100%;
  }
  
  .page-header-actions .btn-group {
    width: 100%;
    flex-direction: column;
  }
  
  .page-header-actions .btn-group .btn {
    width: 100%;
    border-radius: var(--radius-md) !important;
    margin-bottom: 0.5rem;
  }
  
  /* Ensure tables scroll horizontally with visible scrollbar hint */
  .table-responsive {
    border-radius: var(--radius-md);
    box-shadow: inset 0 -1px 0 var(--color-border-subtle);
  }
  
  /* Fix long text in table cells */
  .table td {
    word-break: break-word;
  }
  
  /* Currency columns should not break */
  .table td[class*="text-end"],
  .table td.currency-value {
    white-space: nowrap;
  }
  
  /* Fix budget table overflow */
  .budget-table-wrapper {
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 1rem;
  }
  
  /* Ensure stat cards don't get too small */
  .dashboard-card {
    min-height: 120px;
  }
  
  /* Fix notification dropdown on mobile */
  #notificationDropdown .dropdown-menu {
    position: fixed !important;
    left: 0 !important;
    right: 0 !important;
    top: 76px !important; /* Below top bar */
    max-height: calc(100vh - 76px) !important;
    border-radius: 0 !important;
  }
}

/* Extra small devices - additional fixes */
@media (max-width: 374.98px) {
  /* Ensure very long names don't break layout */
  .dashboard-card p,
  .summary-card h4 {
    font-size: 1.25rem;
  }
  
  /* Compact page headers */
  .page-header h2 {
    font-size: 1.5rem;
  }
  
  /* Reduce modal padding on tiny screens */
  .modal-body {
    padding: 1rem;
  }
  
  /* Stack form groups tighter */
  .form-group,
  .mb-3 {
    margin-bottom: 0.75rem !important;
  }
}
