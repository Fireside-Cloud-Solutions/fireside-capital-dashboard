"use strict";const OPS_SAFETY_BUFFER=500;let opsCashFlowChart=null,opsCurrentDays=30,opsLastRefreshed=null,_opsTimestampInterval=null;function opsFormatCurrency(e){return"function"==typeof formatCurrency?formatCurrency(e):new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(e||0)}function opsEscape(e){if("function"==typeof escapeHtml)return escapeHtml(e);const t=document.createElement("div");return t.textContent=String(null==e?"":e),t.innerHTML}function opsFormatTimeAgo(e){if(!e)return"";const t=Date.now()-e.getTime(),n=Math.floor(t/1e3),a=Math.floor(n/60);return n<60?"just now":1===a?"1 min ago":a<60?`${a} min ago`:e.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"})}function opsTickTimestamps(){if(!opsLastRefreshed)return;const e=document.getElementById("safeToSpendUpdated");e&&(e.textContent=`Updated ${opsFormatTimeAgo(opsLastRefreshed)}`)}function getBillDueDay(e){if(e.nextDueDate){const t=new Date(e.nextDueDate+"T00:00:00");if(!isNaN(t.getTime()))return t.getDate()}return parseInt(e.due_date||e.due_day||1,10)}function normalizeIncomeToMonthly(e){const t=parseFloat(e.amount)||0;switch((e.frequency||"").toLowerCase()){case"weekly":return 52*t/12;case"bi-weekly":case"biweekly":return 26*t/12;case"semi-monthly":return 2*t;case"monthly":default:return t;case"quarterly":return t/3;case"annually":return t/12}}function opsGetBills(){return("function"==typeof isDemoMode&&isDemoMode()?DEMO_DATA.bills||[]:window.bills||[]).filter(e=>"inactive"!==e.status&&"paid_off"!==e.status&&"cancelled"!==e.status&&!e.is_paid)}function opsGetIncome(){return"function"==typeof isDemoMode&&isDemoMode()?DEMO_DATA.income||[]:window.income||[]}function daysUntilBillDue(e){const t=new Date;if(t.setHours(0,0,0,0),e.nextDueDate){const n=new Date(e.nextDueDate+"T00:00:00");if(!isNaN(n.getTime())){let a=Math.round((n-t)/864e5);if(a>=0)return a;const s=(e.frequency||"monthly").toLowerCase(),o=new Date(n);if("annually"===s)for(;o<t;)o.setFullYear(o.getFullYear()+1);else if("weekly"===s)for(;o<t;)o.setDate(o.getDate()+7);else if("bi-weekly"===s)for(;o<t;)o.setDate(o.getDate()+14);else for(;o<t;)o.setMonth(o.getMonth()+1);return Math.round((o-t)/864e5)}}const n=getBillDueDay(e),a=new Date(t.getFullYear(),t.getMonth(),n);let s=Math.round((a-t)/864e5);if(s<0){const e=new Date(t.getFullYear(),t.getMonth()+1,n);s=Math.round((e-t)/864e5)}return s}async function calculateSafeToSpend(){const e=opsGetBills(),t=opsGetIncome().reduce((e,t)=>e+normalizeIncomeToMonthly(t),0),n=e.filter(e=>{const t=daysUntilBillDue(e);return t>=0&&t<=7}),a=n.reduce((e,t)=>e+(parseFloat(t.amount)||0),0),s=t-a-500;let o;return o=s<0?"danger":s<1e3?"warning":"positive",{safeAmount:s,balance:t,billsDue7d:n,billsDue7dTotal:a,bufferAmount:500,state:o}}function renderSafeToSpend(e){const t=document.getElementById("safeToSpend");if(!t)return;const{safeAmount:n,balance:a,billsDue7d:s,billsDue7dTotal:o,bufferAmount:i,state:r}=e;let l="card h-100",c="",d="display-6 fw-bold mb-2",u="",m="text-muted",p="";"danger"===r?(l+=" bg-danger text-white",u='<i class="bi bi-exclamation-triangle me-2"></i>',m="opacity-75",p="border-white border-opacity-25"):"warning"===r?(c="safe-to-spend-warning",d+=" fw-bold"):(c="safe-to-spend-positive",d+=" text-success");const f=s.length>0?s.map(e=>`<span class="badge ${"danger"===r?"bg-light text-danger":"bg-danger-subtle text-danger"} me-1 mb-1">${opsEscape(e.name)}</span>`).join(""):"";t.innerHTML=`\n    <div class="${l} ${c}">\n      <div class="card-body d-flex flex-column">\n        <h6 class="card-subtitle mb-3 ${"danger"===r?m:"text-muted"} small text-uppercase fw-semibold letter-spacing-wide">\n          ${u}Safe to Spend\n        </h6>\n        <div class="${d} safe-amount-value">${opsFormatCurrency(n)}</div>\n        ${f?`<div class="mb-2">${f}</div>`:""}\n        <hr class="${p}">\n        <div class="small ${"danger"===r?m:"text-muted"} mt-auto">\n          <div class="d-flex justify-content-between mb-1">\n            <span>Est. Monthly Income</span>\n            <span class="${"danger"!==r?"text-success":""}">+${opsFormatCurrency(a)}</span>\n          </div>\n          <div class="d-flex justify-content-between mb-1">\n            <span>Bills â‰¤7 days <span class="badge bg-${"danger"===r?"light text-danger":"danger"} ms-1">${s.length}</span></span>\n            <span>âˆ’${opsFormatCurrency(o)}</span>\n          </div>\n          <div class="d-flex justify-content-between">\n            <span>Safety Buffer</span>\n            <span>âˆ’${opsFormatCurrency(i)}</span>\n          </div>\n        </div>\n        \x3c!-- FC-UIUX-049: data-freshness stamp --\x3e\n        <div class="mt-2 pt-2 border-top ${"danger"===r?"border-white border-opacity-25":"border-secondary-subtle"}">\n          <small id="safeToSpendUpdated" class="${"danger"===r?"opacity-75":"text-muted"} fst-italic">\n            ${opsLastRefreshed?`Updated ${opsFormatTimeAgo(opsLastRefreshed)}`:""}\n          </small>\n        </div>\n      </div>\n    </div>`}function buildCashFlowProjection(e=30){const t=opsGetBills(),n=opsGetIncome(),a=new Date;a.setHours(0,0,0,0);let s=n.reduce((e,t)=>e+normalizeIncomeToMonthly(t),0);const o=[],i=[],r=[];n.forEach(t=>{const n=(t.frequency||"").toLowerCase(),s=parseFloat(t.amount)||0,o=t.name||t.source||"Income";if("monthly"===n){let n=1;t.next_date&&(n=new Date(t.next_date+"T00:00:00").getDate());for(let t=0;t<=e;t++){const e=new Date(a);e.setDate(a.getDate()+t),e.getDate()===n&&r.push({day:t,type:"income",amount:s,name:o})}}else{const i="weekly"===n?7:"bi-weekly"===n||"biweekly"===n?14:"semi-monthly"===n?15:"quarterly"===n?91:365,l=t.next_date?new Date(t.next_date+"T00:00:00"):new Date(a);for(let t=0;t<=e;t++){const e=new Date(a);e.setDate(a.getDate()+t);const n=Math.round((e-l)/864e5);n>=0&&n%i===0&&r.push({day:t,type:"income",amount:s,name:o})}}}),t.forEach(t=>{const n=parseFloat(t.amount)||0,s=t.name||"Bill",o=(t.frequency||"monthly").toLowerCase();if(t.nextDueDate){const i=new Date(t.nextDueDate+"T00:00:00");if(!isNaN(i.getTime())){if("monthly"===o){const t=i.getDate();for(let o=0;o<=e;o++){const e=new Date(a);e.setDate(a.getDate()+o),e.getDate()===t&&r.push({day:o,type:"bill",amount:n,name:s})}}else{const t="weekly"===o?7:"bi-weekly"===o||"biweekly"===o?14:"semi-monthly"===o?15:"quarterly"===o?91:365;for(let o=0;o<=e;o++){const e=new Date(a);e.setDate(a.getDate()+o);const l=Math.round((e-i)/864e5);l>=0&&l%t===0&&r.push({day:o,type:"bill",amount:n,name:s})}}return}}const i=getBillDueDay(t);for(let t=0;t<=e;t++){const e=new Date(a);e.setDate(a.getDate()+t),e.getDate()===i&&r.push({day:t,type:"bill",amount:n,name:s})}});for(let t=0;t<=e;t++){const e=new Date(a);e.setDate(a.getDate()+t),o.push(e.toLocaleDateString("en-US",{month:"short",day:"numeric"})),r.filter(e=>e.day===t).forEach(e=>{s+="income"===e.type?e.amount:-e.amount}),i.push(parseFloat(s.toFixed(2)))}return{labels:o,balanceData:i,events:r}}async function opsLoadChartJs(){"undefined"==typeof Chart&&(void 0!==window.LazyLoader&&window.LazyLoader.loadCharts?await window.LazyLoader.loadCharts():await new Promise((e,t)=>{const n=document.createElement("script");n.src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js",n.onload=e,n.onerror=t,document.head.appendChild(n)}))}async function renderCashFlowChart(e=30){const t=document.getElementById("cashFlowCanvas");if(!t)return;const n=document.getElementById("cashFlowSubtitle");if(n){const t=opsLastRefreshed?opsLastRefreshed.toLocaleTimeString("en-US",{hour:"numeric",minute:"2-digit"}):"";n.textContent=t?`Next ${e} days Â· as of ${t}`:`Next ${e} days`}try{await opsLoadChartJs()}catch(e){const t=document.getElementById("cashFlowChartContainer");return void(t&&(t.innerHTML='<p class="text-muted text-center py-4">Chart unavailable</p>'))}const{labels:a,balanceData:s,events:o}=buildCashFlowProjection(e),i=a.map((e,t)=>{const n=o.filter(e=>e.day===t);return n.some(e=>"income"===e.type)?"#81b900":n.some(e=>"bill"===e.type)?"#dc3545":"rgba(0,0,0,0)"}),r=a.map((e,t)=>o.some(e=>e.day===t)?6:0),l=a.map((e,t)=>o.some(e=>e.day===t)?9:4);opsCashFlowChart&&(opsCashFlowChart.destroy(),opsCashFlowChart=null);const c=s.some(e=>e<0);opsCashFlowChart=new Chart(t,{type:"line",data:{labels:a,datasets:[{label:"Projected Balance",data:s,borderColor:"#01a4ef",backgroundColor:"rgba(1, 164, 239, 0.08)",fill:!0,tension:.35,pointBackgroundColor:i,pointBorderColor:i,pointRadius:r,pointHoverRadius:l,segment:c?{borderColor:e=>e.p0.parsed.y<0||e.p1.parsed.y<0?"#dc3545":"#01a4ef",backgroundColor:e=>e.p0.parsed.y<0||e.p1.parsed.y<0?"rgba(220, 53, 69, 0.08)":"rgba(1, 164, 239, 0.08)"}:void 0}]},options:{responsive:!0,maintainAspectRatio:!1,animation:{duration:400},plugins:{legend:{display:!1},tooltip:{callbacks:{label:e=>`Balance: ${opsFormatCurrency(e.raw)}`,afterBody(e){const t=e[0].dataIndex,n=o.filter(e=>e.day===t);return n.length?n.map(e=>`${"income"===e.type?"â–² In":"â–¼ Out"}: ${opsEscape(e.name)} ${opsFormatCurrency(e.amount)}`):[]}}}},scales:{x:{ticks:{maxTicksLimit:Math.min(10,e),color:"#adb5bd",font:{size:11}},grid:{color:"rgba(255,255,255,0.04)"}},y:{ticks:{color:"#adb5bd",font:{size:11},callback:e=>opsFormatCurrency(e)},grid:{color:e=>0===e.tick.value?"rgba(255,255,255,0.25)":"rgba(255,255,255,0.04)",lineWidth:e=>0===e.tick.value?2:1}}}}})}function renderBillsAging(){const e=document.getElementById("billsAging");if(!e)return;const t=opsGetBills();if(0===t.length)return void(e.innerHTML='\n      <div class="text-center py-4 text-muted">\n        <i class="bi bi-receipt fs-2 mb-2 d-block opacity-50"></i>\n        <p class="mb-0">No active bills found.</p>\n        <a href="bills.html" class="btn btn-sm btn-outline-primary mt-2">Add Bills</a>\n      </div>');const n=t.filter(e=>{const t=daysUntilBillDue(e);return t>=0&&t<=7}),a=t.filter(e=>{const t=daysUntilBillDue(e);return t>7&&t<=30}),s=t.filter(e=>{const t=daysUntilBillDue(e);return t>30&&t<=60});function o(e,t,n,a){const s=e.reduce((e,t)=>e+(parseFloat(t.amount)||0),0),o=`bucket-${t}-${Date.now()}-${Math.random().toString(36).slice(2,7)}`,i=e.length>0?e.map(e=>{const n=daysUntilBillDue(e);return`\n            <div class="d-flex justify-content-between align-items-center py-2 px-1 border-bottom border-secondary border-opacity-25">\n              <div>\n                <span class="fw-medium small">${opsEscape(e.name)}</span>\n                <span class="text-muted ms-2 small">due in ${n}d</span>\n              </div>\n              <span class="text-${t} fw-semibold small">${opsFormatCurrency(e.amount)}</span>\n            </div>`}).join(""):'<p class="text-muted small mb-0 py-2 ps-1">No bills in this range</p>';return`\n      <div class="bills-bucket card border mb-2 border-${t} border-opacity-25"\n           role="button"\n           tabindex="0"\n           aria-expanded="false"\n           aria-controls="${o}"\n           data-action="toggle-bucket"\n           aria-label="${n} â€” ${e.length} bills totalling ${opsFormatCurrency(s)}">\n        <div class="card-body py-2 px-3">\n          <div class="d-flex justify-content-between align-items-center">\n            <div class="d-flex align-items-center gap-2">\n              <span class="badge bg-${t} rounded-pill">${e.length}</span>\n              <span class="fw-medium small">${a} ${n}</span>\n            </div>\n            <div class="d-flex align-items-center gap-2">\n              <span class="fw-bold text-${t}">${opsFormatCurrency(s)}</span>\n              <i class="bi bi-chevron-down text-muted small"></i>\n            </div>\n          </div>\n          <div class="bills-bucket-list" id="${o}">\n            ${i}\n          </div>\n        </div>\n      </div>`}e.innerHTML=`\n    ${o(n,"danger","Due â‰¤7 days","ðŸ”´")}\n    ${o(a,"warning","Due 8â€“30 days","ðŸŸ¡")}\n    ${o(s,"success","Due 31â€“60 days","ðŸŸ¢")}`,e.dataset.bucketListenerAttached||(e.dataset.bucketListenerAttached="true",e.addEventListener("click",e=>{const t=e.target.closest('[data-action="toggle-bucket"]');if(!t)return;const n=t.querySelector(".bills-bucket-list");if(!n)return;const a=n.classList.toggle("expanded");t.setAttribute("aria-expanded",a)}),e.addEventListener("keydown",e=>{if("Enter"!==e.key&&" "!==e.key)return;const t=e.target.closest('[data-action="toggle-bucket"]');if(!t)return;e.preventDefault();const n=t.querySelector(".bills-bucket-list");if(!n)return;const a=n.classList.toggle("expanded");t.setAttribute("aria-expanded",a)}))}function buildBvaMonthOptions(){const e=document.getElementById("bvaMonthSelect");if(!e)return;e.innerHTML="";const t=new Date;for(let n=0;n<4;n++){const a=new Date(t.getFullYear(),t.getMonth()-n,1),s=`${a.getFullYear()}-${String(a.getMonth()+1).padStart(2,"0")}`,o=a.toLocaleDateString("en-US",{month:"long",year:"numeric"}),i=document.createElement("option");i.value=s,i.textContent=o,0===n&&(i.selected=!0),e.appendChild(i)}}function initBudgetVsActuals(){if("function"!=typeof renderBudgetVsActuals)return void setTimeout(initBudgetVsActuals,500);buildBvaMonthOptions();const e=document.getElementById("bvaMonthSelect"),t=e?e.value:null;renderBudgetVsActuals("bvaHorizontal",t),e&&e.addEventListener("change",()=>{renderBudgetVsActuals("bvaHorizontal",e.value||null)})}function renderUpcomingList(){const e=document.getElementById("upcomingTx");if(!e)return;const t=opsGetBills(),n=opsGetIncome(),a=new Date;a.setHours(0,0,0,0);let s=n.reduce((e,t)=>e+normalizeIncomeToMonthly(t),0);const o=[];if(n.forEach(e=>{const t=(e.frequency||"").toLowerCase(),n=parseFloat(e.amount)||0,s=e.name||e.source||"Income";for(let i=0;i<=14;i++){const r=new Date(a);r.setDate(a.getDate()+i);let l=!1;if("monthly"===t){const t=e.next_date?new Date(e.next_date+"T00:00:00").getDate():1;l=r.getDate()===t}else if("weekly"===t||"bi-weekly"===t){const n=e.next_date?new Date(e.next_date+"T00:00:00"):new Date(a),s="weekly"===t?7:14,o=Math.round((r-n)/864e5);l=o>=0&&o%s===0}l&&o.push({date:new Date(r),amount:n,name:s,type:"income"})}}),t.forEach(e=>{const t=parseFloat(e.amount)||0,n=e.name||"Bill",s=(e.frequency||"monthly").toLowerCase();if(e.nextDueDate){const i=new Date(e.nextDueDate+"T00:00:00");if(!isNaN(i.getTime())){if("monthly"===s){const e=i.getDate();for(let s=0;s<=14;s++){const i=new Date(a);i.setDate(a.getDate()+s),i.getDate()===e&&o.push({date:new Date(i),amount:t,name:n,type:"bill"})}}else{const e="weekly"===s?7:"bi-weekly"===s||"biweekly"===s?14:"semi-monthly"===s?15:"quarterly"===s?91:365;for(let s=0;s<=14;s++){const r=new Date(a);r.setDate(a.getDate()+s);const l=Math.round((r-i)/864e5);l>=0&&l%e===0&&o.push({date:new Date(r),amount:t,name:n,type:"bill"})}}return}}const i=getBillDueDay(e);for(let e=0;e<=14;e++){const s=new Date(a);s.setDate(a.getDate()+e),s.getDate()===i&&o.push({date:new Date(s),amount:t,name:n,type:"bill"})}}),o.sort((e,t)=>{const n=e.date-t.date;return 0!==n?n:"income"===e.type&&"income"!==t.type?-1:"income"===t.type&&"income"!==e.type?1:0}),0===o.length)return void(e.innerHTML='\n      <div class="text-center py-4 text-muted">\n        <i class="bi bi-calendar-check fs-2 mb-2 d-block opacity-50"></i>\n        <p class="mb-0">No scheduled events in the next 14 days.</p>\n        <div class="mt-2">\n          <a href="bills.html" class="btn btn-sm btn-outline-secondary me-2">Add Bills</a>\n          <a href="income.html" class="btn btn-sm btn-outline-secondary">Add Income</a>\n        </div>\n      </div>');const i=o.map(e=>{"income"===e.type?s+=e.amount:s-=e.amount;const t="income"===e.type,n=e.date.toLocaleDateString("en-US",{weekday:"short",month:"short",day:"numeric"}),o=e.date.getTime()===a.getTime(),i=t?`<span class="text-success fw-bold">+${opsFormatCurrency(e.amount)}</span>`:`<span class="text-danger fw-bold">âˆ’${opsFormatCurrency(e.amount)}</span>`,r=s<0?"text-danger":s<500?"text-warning":"text-muted",l=o?'<span class="badge bg-primary ms-2">Today</span>':"";return`\n      <div class="upcoming-item ${t?"income":"expense"} d-flex justify-content-between align-items-center border-bottom border-secondary border-opacity-25">\n        <div class="d-flex align-items-center gap-3">\n          <i class="bi ${t?"bi-arrow-down-circle text-success":"bi-arrow-up-circle text-danger"} fs-5"></i>\n          <div>\n            <div class="fw-medium small">${opsEscape(e.name)}${l}</div>\n            <div class="text-muted upcoming-meta">${n}</div>\n          </div>\n        </div>\n        <div class="text-end">\n          <div>${i}</div>\n          <div class="upcoming-balance upcoming-meta ${r}">${opsFormatCurrency(s)}</div>\n        </div>\n      </div>`});e.innerHTML=`\n    <div class="d-flex justify-content-between text-muted border-bottom border-secondary border-opacity-25 pb-2 mb-1 px-3 upcoming-header-row">\n      <span>Event / Date</span>\n      <span>Amount Â· Running Balance</span>\n    </div>\n    ${i.join("")}`}function updateRealtimeBadge(){const e=document.getElementById("realtimeStatus");if(!e)return;if("undefined"==typeof FiresideRealtime)return e.className="badge bg-secondary ms-2",void(e.innerHTML='<i class="bi bi-circle me-1 realtime-dot"></i> Unavailable');const t="function"==typeof FiresideRealtime.status?FiresideRealtime.status():null;t?t.isSubscribed&&t.channelActive?(e.className="badge bg-success ms-2",e.innerHTML='<i class="bi bi-circle-fill me-1 realtime-dot"></i> Live'):t.retryCount>0&&t.retryCount<t.maxRetries?(e.className="badge bg-warning text-dark ms-2",e.innerHTML='<i class="bi bi-circle me-1 realtime-dot"></i> Reconnecting...'):(e.className="badge bg-danger ms-2",e.innerHTML='<i class="bi bi-circle-fill me-1 realtime-dot"></i> Offline'):(e.className="badge bg-secondary ms-2",e.innerHTML='<i class="bi bi-circle me-1 realtime-dot"></i> Unavailable')}function waitForAppData(){return new Promise(e=>{if("function"==typeof isDemoMode&&isDemoMode())return void e();if(void 0!==window.bills)return void e();document.addEventListener("dataLoaded",()=>e(),{once:!0});let t=0;const n=setInterval(()=>{t++,(void 0!==window.bills||t>=30)&&(clearInterval(n),e())},200)})}async function initOperations(){try{opsLastRefreshed=new Date,renderSafeToSpend(await calculateSafeToSpend()),await renderCashFlowChart(opsCurrentDays),renderBillsAging(),initBudgetVsActuals(),renderUpcomingList(),updateRealtimeBadge(),setInterval(updateRealtimeBadge,5e3),_opsTimestampInterval&&clearInterval(_opsTimestampInterval),_opsTimestampInterval=setInterval(opsTickTimestamps,3e4),document.querySelectorAll("#cashFlowToggle button").forEach(e=>{e.addEventListener("click",async()=>{document.querySelectorAll("#cashFlowToggle button").forEach(e=>e.classList.remove("active")),e.classList.add("active"),opsCurrentDays=parseInt(e.dataset.days,10),await renderCashFlowChart(opsCurrentDays)})}),"undefined"!=typeof FiresideRealtime&&"function"==typeof FiresideRealtime.on&&(FiresideRealtime.on("bill:update",async()=>{opsLastRefreshed=new Date,renderBillsAging(),renderUpcomingList(),renderSafeToSpend(await calculateSafeToSpend()),await renderCashFlowChart(opsCurrentDays)}),FiresideRealtime.on("transaction:insert",()=>{opsLastRefreshed=new Date,renderUpcomingList()}))}catch(e){"function"==typeof showToast&&showToast("Error loading the Operations dashboard. Please refresh.","danger")}}document.addEventListener("DOMContentLoaded",async()=>{await waitForAppData(),await initOperations()});