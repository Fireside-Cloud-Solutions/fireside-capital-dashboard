const DEBUG=!1;function debugLog(...e){}async function loadChartJs(){return await window.LazyLoader.loadCharts()}window.debugBillsCalculation=function(){const e=(window.bills||[]).filter(e=>{const t=getBillFinancingInfo(e);return!(t.isFinancing&&"paid_off"===t.status)});let t=0;const n=[];return e.forEach((e,a)=>{if(!e.amount||0===e.amount||!e.frequency)return;const s=getShareInfoForBill(e.id),o=s&&"accepted"===s.status?s.owner_amount:e.amount,r=normalizeToMonthly(o,e.frequency);n.push({name:e.name,type:e.type,frequency:e.frequency,billAmount:e.amount,userAmount:o,monthlyAmount:r,isShared:!!s,shareStatus:s?.status||"N/A"}),t+=r}),{billDetails:n,totalMonthly:t}};const CACHE_DURATION=3e5,dataCache={};function getCachedData(e){const t=dataCache[e];return t?Date.now()-t.timestamp>3e5?(delete dataCache[e],null):t.data:null}function setCachedData(e,t){dataCache[e]={data:t,timestamp:Date.now()}}function clearCache(){Object.keys(dataCache).forEach(e=>delete dataCache[e])}function sanitizeHTML(e){return escapeHtml(e)}function escapeAttribute(e){return null==e?"":String(e).replace(/&/g,"&amp;").replace(/"/g,"&quot;").replace(/'/g,"&#39;").replace(/</g,"&lt;").replace(/>/g,"&gt;")}function getRaw(e){return"number"==typeof e?e:"string"==typeof e&&parseFloat(e.replace(/[^0-9.-]+/g,""))||0}function formatCurrency(e){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(getRaw(e))}function formatDate(e){return e&&e.includes("-")?new Intl.DateTimeFormat("en-US").format(new Date(e+"T00:00:00")):""}function toTitleCase(e){return e?String(e).toLowerCase().split(" ").map(e=>e.charAt(0).toUpperCase()+e.slice(1)).join(" "):""}function getNextDate(e,t){let n=new Date(e);switch((t||"").toLowerCase()){case"daily":n.setDate(n.getDate()+1);break;case"weekly":n.setDate(n.getDate()+7);break;case"bi-weekly":n.setDate(n.getDate()+14);break;case"monthly":n.setMonth(n.getMonth()+1);break;case"quarterly":n.setMonth(n.getMonth()+3);break;case"annually":n.setFullYear(n.getFullYear()+1)}return n}function getThemeColors(){return"light"===(document.documentElement.getAttribute("data-bs-theme")||document.body.getAttribute("data-theme")||"dark")?{fill:"rgba(244, 78, 36, 0.15)",text:"#1a1a1a",grid:"rgba(0, 0, 0, 0.08)"}:{fill:"rgba(244, 78, 36, 0.15)",text:"#f0f0f0",grid:"rgba(240, 240, 240, 0.08)"}}function normalizeToMonthly(e,t){const n=getRaw(e);switch((t||"").toLowerCase()){case"daily":return 30*n;case"weekly":return 52*n/12;case"bi-weekly":case"biweekly":return 26*n/12;case"twice monthly":case"semi-monthly":return 2*n;case"monthly":default:return n;case"quarterly":return n/3;case"semi-annually":return n/6;case"annually":case"annual":return n/12}}function dedupeSnapshotsByDate(e){const t={};return(e||[]).forEach(e=>{t[e.date]=e}),Object.values(t).sort((e,t)=>new Date(e.date)-new Date(t.date))}async function safeCreateChart(e,t,n){try{if(!e)return null;await loadChartJs(),window.innerWidth<768&&(Chart.defaults.font.size=11,Chart.defaults.responsive=!0,Chart.defaults.maintainAspectRatio=!1);const n="string"==typeof e?document.getElementById(e):e;if(n){n.style.backgroundColor="transparent";const e=n.getContext("2d");e&&e.clearRect(0,0,n.width,n.height);const t=n.id;t&&window.chartInstances[t]&&(window.chartInstances[t].destroy(),delete window.chartInstances[t])}const a=new Chart(e,t);if(n&&n.id&&(window.chartInstances[n.id]=a),n){const e=n.closest(".chart-card");e&&e.classList.contains("loading")&&setTimeout(()=>{e.classList.remove("loading")},100)}return a}catch(t){const n="string"==typeof e?document.getElementById(e):e;if(n&&n.parentElement){const e=document.createElement("p");e.className="text-muted text-center mt-3",e.textContent="Chart could not be loaded.",n.parentElement.replaceChildren(e)}return null}}function exportFinancialDataCSV(){if(!rateLimiters.report.allow("csvExport")){const e=rateLimiters.report.getRemainingTime("csvExport"),t=Math.ceil(e/1e3);return void alert(`Too many export requests. Please wait ${t} seconds.`)}const e=[],t=e=>`"${String(e??"").replace(/"/g,'""')}"`;e.push("BILLS"),e.push("Name,Type,Amount,Frequency,Next Due Date"),(window.bills||[]).forEach(n=>{e.push([t(n.name),t(n.type),getRaw(n.amount),t(n.frequency),t(n.nextDueDate)].join(","))}),e.push(""),e.push("DEBTS"),e.push("Name,Type,Balance,Interest Rate %,Term (months),Monthly Payment,Next Due Date"),(window.debts||[]).forEach(n=>{e.push([t(n.name),t(n.type),getRaw(n.amount),n.interestRate||0,n.term||"",getRaw(n.monthlyPayment),t(n.nextDueDate)].join(","))}),e.push(""),e.push("INCOME"),e.push("Name,Type,Amount,Frequency,Next Due Date"),(window.income||[]).forEach(n=>{e.push([t(n.name),t(n.type),getRaw(n.amount),t(n.frequency),t(n.nextDueDate)].join(","))}),e.push(""),e.push("INVESTMENTS"),e.push("Name,Type,Value,Starting Balance,Monthly Contribution,Annual Return %"),(window.investments||[]).forEach(n=>{e.push([t(n.name),t(n.type),getRaw(n.value),getRaw(n.startingBalance),getRaw(n.monthlyContribution),n.annualReturn||0].join(","))});const n=e.join("\n"),a=new Blob([n],{type:"text/csv;charset=utf-8;"}),s=URL.createObjectURL(a),o=document.createElement("a");o.href=s,o.download=`fireside-capital-export-${(new Date).toISOString().split("T")[0]}.csv`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(s)}window.chartInstances=window.chartInstances||{};const supabaseUrl="https://qqtiofdqplwycnwplmen.supabase.co",supabaseKey="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InFxdGlvZmRxcGx3eWNud3BsbWVuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk5MDY5NDIsImV4cCI6MjA4NTQ4Mjk0Mn0.Vjg7hQDPWJwmbkQccw5CXH_Npi2YJgJbt-OAEnF_P5g",sb=window.sb=window.supabase.createClient(supabaseUrl,supabaseKey,{auth:{storage:window.localStorage,storageKey:"sb-auth-token",autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0,flowType:"pkce"},global:{headers:{"X-Client-Info":"fireside-capital-web"}}});let sessionSecurity=null;const LOGGED_OUT_CTA_CONFIG={dashboard:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>',title:"Welcome to Fireside Capital",description:"Your personal finance dashboard. Track assets, manage bills, monitor investments, and achieve your financial goals."},assets:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 12l2-2m0 0l7-7 7 7M5 10v10a1 1 0 001 1h3m10-11l2 2m-2-2v10a1 1 0 01-1 1h-3m-6 0a1 1 0 001-1v-4a1 1 0 011-1h2a1 1 0 011 1v4a1 1 0 001 1m-6 0h6" /></svg>',title:"Track Your Assets",description:"Monitor real estate, vehicles, and other valuables. See your total net worth and track equity over time."},bills:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" /></svg>',title:"Manage Your Bills",description:"Never miss a payment. Track due dates, split bills with friends, and manage recurring expenses effortlessly."},budget:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 7h6m0 10v-3m-3 3h.01M9 17h.01M9 14h.01M12 14h.01M15 11h.01M12 11h.01M9 11h.01M7 21h10a2 2 0 002-2V5a2 2 0 00-2-2H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>',title:"Create Your Budget",description:"Plan your spending, allocate funds to categories, and stay on top of your monthly budget with ease."},debts:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>',title:"Conquer Your Debts",description:"Track loans, credit cards, and payment plans. See payoff timelines and plan your debt-free journey."},friends:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z" /></svg>',title:"Share with Friends",description:"Split bills and expenses with friends and roommates. Keep everyone accountable and make sharing simple."},income:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8c-1.657 0-3 .895-3 2s1.343 2 3 2 3 .895 3 2-1.343 2-3 2m0-8c1.11 0 2.08.402 2.599 1M12 8V7m0 1v8m0 0v1m0-1c-1.11 0-2.08-.402-2.599-1M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>',title:"Track Your Income",description:"Monitor all income sources from W2, 1099, side hustles, and more. See your total earnings at a glance."},investments:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 7h8m0 0v8m0-8l-8 8-4-4-6 6" /></svg>',title:"Grow Your Investments",description:"Track 401(k), IRA, brokerage accounts, and crypto. Watch your wealth compound and reach financial freedom."},reports:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" /></svg>',title:"Financial Reports",description:"Analyze your net worth trends, spending patterns, and financial health with detailed reports and charts."},settings:{icon:'<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" /><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" /></svg>',title:"Customize Your Experience",description:"Configure your preferences, emergency fund goals, and personalize your Fireside Capital dashboard."}};function getPageName(){const e=window.location.pathname.split("/").pop().replace(".html","")||"dashboard";return"index"===e?"dashboard":e}function toggleLoggedOutCTA(e){const t=document.getElementById("dataContainer");if(!t)return;let n=t.querySelector(".logged-out-cta");if(e)if(n)n.classList.add("show");else{const e=getPageName(),a=LOGGED_OUT_CTA_CONFIG[e]||LOGGED_OUT_CTA_CONFIG.dashboard;n=document.createElement("div"),n.className="logged-out-cta show",n.setAttribute("data-page",e),n.innerHTML=`\n        <div class="logged-out-cta-logo">\n          ${a.icon}\n        </div>\n        <h2>${escapeHtml(a.title)}</h2>\n        <p>${escapeHtml(a.description)}</p>\n        <div class="logged-out-cta-actions">\n          <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#loginModal">\n            <i class="bi bi-box-arrow-in-right me-2"></i>Login\n          </button>\n          <button class="btn btn-outline-secondary" data-bs-toggle="modal" data-bs-target="#signupModal">\n            <i class="bi bi-person-plus me-2"></i>Sign Up\n          </button>\n        </div>\n      `,t.prepend(n)}else n&&n.classList.remove("show")}let netWorthChart,cashFlowChart,emergencyFundChart,netWorthDeltaChartInst,spendingCategoriesChartInst,savingsRateChartInst,investmentGrowthChartInst,currentUser=null,editAssetId=null,deleteAssetId=null,editInvestmentId=null,deleteInvestmentId=null,editDebtId=null,deleteDebtId=null,editBillId=null,deleteBillId=null,editIncomeId=null,deleteIncomeId=null,currentBudgetMonth=new Date,budgetAssignments={};function showAuthAlert(e,t,n="danger"){const a=document.getElementById(e);a&&(a.className=`alert alert-${n}`,a.textContent=t,a.classList.remove("d-none"))}function hideAuthAlert(e){const t=document.getElementById(e);t&&(t.classList.add("d-none"),t.textContent="")}function setButtonLoading(e,t){const n=document.getElementById(e);n&&(t?(n.disabled=!0,n._originalText=n.textContent,n.innerHTML='<span class="spinner-border spinner-border-sm me-1" role="status"></span> Please wait...'):(n.disabled=!1,n.textContent=n._originalText||n.textContent))}function getFriendlyAuthError(e){const t=(e.message||"").toLowerCase();return t.includes("email not confirmed")?"Your email is not confirmed. Please check your inbox (and spam folder) for the confirmation link.":t.includes("invalid login credentials")||t.includes("user not found")?"Invalid email or password. Please try again.":t.includes("email rate limit exceeded")?"Too many attempts. Please wait a few minutes and try again.":t.includes("user already registered")?"An account with this email already exists. Try logging in instead.":t.includes("password")&&t.includes("at least")?e.message:t.includes("signup is disabled")?"Sign up is currently disabled. Please contact the administrator.":e.message}async function signUp(e,t,n,a){hideAuthAlert("signupAlert"),setButtonLoading("signupSubmitBtn",!0);try{const{data:s,error:o}=await sb.auth.signUp({email:e,password:t,options:{data:{first_name:n,last_name:a}}});if(o)return void showAuthAlert("signupAlert",getFriendlyAuthError(o),"danger");0===s?.user?.identities?.length?showAuthAlert("signupAlert","An account with this email already exists. Try logging in instead.","warning"):s?.user&&!s?.session?(showAuthAlert("signupAlert","✅ Account created! Please check your email (including spam folder) and click the confirmation link before logging in.","success"),document.getElementById("signupForm")?.reset()):(showAuthAlert("signupAlert","✅ Account created successfully! Logging you in...","success"),setTimeout(()=>{bootstrap.Modal.getInstance(document.getElementById("signupModal"))?.hide()},1e3))}catch(e){showAuthAlert("signupAlert","An unexpected error occurred. Please try again.","danger")}finally{setButtonLoading("signupSubmitBtn",!1)}}async function login(e,t){hideAuthAlert("loginAlert"),setButtonLoading("loginSubmitBtn",!0);try{if(sessionSecurity&&sessionSecurity.isAccountLocked())return showAuthAlert("loginAlert",`Too many failed login attempts. Please wait ${sessionSecurity.getLockoutMinutes()} minutes before trying again.`,"danger"),void setButtonLoading("loginSubmitBtn",!1);const{error:n}=await sb.auth.signInWithPassword({email:e,password:t});if(n){if(sessionSecurity){const t=sessionSecurity.recordLoginAttempt(!1,e);if(t.locked)return showAuthAlert("loginAlert",t.message,"danger"),void setButtonLoading("loginSubmitBtn",!1)}return void showAuthAlert("loginAlert",getFriendlyAuthError(n),"danger")}sessionSecurity&&sessionSecurity.recordLoginAttempt(!0,e),showAuthAlert("loginAlert","✅ Login successful!","success"),setTimeout(()=>{bootstrap.Modal.getInstance(document.getElementById("loginModal"))?.hide(),hideAuthAlert("loginAlert")},500)}catch(e){showAuthAlert("loginAlert","An unexpected error occurred. Please try again.","danger")}finally{setButtonLoading("loginSubmitBtn",!1)}}async function forgotPassword(e){if(hideAuthAlert("forgotAlert"),e)try{const{error:t}=await sb.auth.resetPasswordForEmail(e,{redirectTo:window.location.origin+window.location.pathname});if(t)return void showAuthAlert("forgotAlert",getFriendlyAuthError(t),"danger");showAuthAlert("forgotAlert","✅ Password reset link sent! Check your email (including spam folder).","success")}catch(e){showAuthAlert("forgotAlert","An unexpected error occurred. Please try again.","danger")}else showAuthAlert("forgotAlert","Please enter your email address.","warning")}async function updatePassword(e){hideAuthAlert("resetPasswordAlert"),setButtonLoading("resetPasswordBtn",!0);try{const{error:t}=await sb.auth.updateUser({password:e});if(t)return void showAuthAlert("resetPasswordAlert",getFriendlyAuthError(t),"danger");showAuthAlert("resetPasswordAlert","✅ Password updated successfully! Redirecting...","success"),setTimeout(()=>{bootstrap.Modal.getInstance(document.getElementById("resetPasswordModal"))?.hide(),window.location.hash=""},1500)}catch(e){showAuthAlert("resetPasswordAlert","An unexpected error occurred. Please try again.","danger")}finally{setButtonLoading("resetPasswordBtn",!1)}}async function logout(){try{sessionSecurity&&sessionSecurity.onLogout()}catch(e){}try{clearCache()}catch(e){}try{"undefined"!=typeof CSRF&&CSRF.clearToken()}catch(e){}try{await sb.auth.signOut()}catch(e){}currentUser=null,document.getElementById("loggedInState")?.classList.add("d-none"),document.getElementById("loggedOutState")?.classList.remove("d-none"),document.getElementById("dataContainer")&&(document.getElementById("dataContainer").style.visibility="hidden",toggleLoggedOutCTA(!0)),document.getElementById("pageActions")&&(document.getElementById("pageActions").style.display="none"),document.querySelectorAll(".auth-required").forEach(e=>{e.style.display="none"}),"/index.html"!==window.location.pathname&&"/"!==window.location.pathname&&(window.location.href="index.html")}async function checkOnboardingStatus(){if(!currentUser)return;const e=window.location.pathname.split("/").pop();if("index.html"!==e&&""!==e)return;const t=(window.assets||[]).length>0,n=(window.bills||[]).length>0,a=(window.income||[]).length>0,s=(window.investments||[]).length>0,o=(window.debts||[]).length>0,r=t||n||a||s||o,i=(window.settings||{}).onboarding_completed||!1;r||i||(debugLog("ONBOARDING: Showing wizard for new user"),setTimeout(()=>{"function"==typeof showOnboardingWizard&&showOnboardingWizard()},500))}async function fetchAllDataFromSupabase(e=!1){if(!currentUser)return;const t=`data_${currentUser.id}`;if(!e){const e=getCachedData(t);if(e)return debugLog("FETCH: Using cached data"),window.assets=e.assets||[],window.investments=e.investments||[],window.debts=e.debts||[],window.bills=e.bills||[],window.income=e.income||[],window.snapshots=e.snapshots||[],void(window.settings=e.settings||{})}try{const[e,n,a,s,o,r,i]=await Promise.all([sb.from("assets").select("*").eq("user_id",currentUser.id),sb.from("investments").select("*").eq("user_id",currentUser.id),sb.from("debts").select("*").eq("user_id",currentUser.id),sb.from("bills").select("*").eq("user_id",currentUser.id),sb.from("income").select("*").eq("user_id",currentUser.id),sb.from("snapshots").select("*").eq("user_id",currentUser.id),sb.from("settings").select("*").eq("user_id",currentUser.id).maybeSingle()]),l=[e,n,a,s,o,r];for(const e of l)if(e.error)throw new Error(`Failed to fetch data: ${e.error.message}`);i.error,window.assets=e.data||[],window.investments=n.data||[],window.debts=a.data||[],window.bills=s.data||[],window.income=o.data||[],window.snapshots=r.data||[],window.settings=i.data||{emergency_fund_goal:3},setCachedData(t,{assets:window.assets,investments:window.investments,debts:window.debts,bills:window.bills,income:window.income,snapshots:window.snapshots,settings:window.settings}),debugLog("FETCH: Data fetch successful for all tables."),document.dispatchEvent(new CustomEvent("dataLoaded"))}catch(e){alert("A critical error occurred while fetching your data. Please check the console.")}}async function renderAll(){renderAssets(),renderInvestments(),renderDebts(),renderBills(),renderFinancingCards(),renderIncome(),document.getElementById("netWorthValue")&&(updateDashboardCards(),renderUpcomingPayments(),"function"==typeof loadSubscriptionWidget&&loadSubscriptionWidget(),await renderNetWorthChart(),window.requestIdleCallback?requestIdleCallback(()=>{generateMonthlyCashFlowChart(),renderEmergencyFundChart()},{timeout:2e3}):setTimeout(()=>{generateMonthlyCashFlowChart(),renderEmergencyFundChart()},100)),document.getElementById("reportNetWorth")&&document.getElementById("netWorthTimelineChart")&&(await renderNetWorthChart(),"function"==typeof generateMonthlyCashFlowChart&&generateMonthlyCashFlowChart(),"function"==typeof renderSpendingCategoriesChart&&renderSpendingCategoriesChart(),"function"==typeof renderSavingsRateChart&&renderSavingsRateChart(),"function"==typeof renderInvestmentGrowthChart&&renderInvestmentGrowthChart());const e=document.getElementById("emergencyFundGoal"),t=document.getElementById("settingsEmptyState"),n=document.getElementById("settingsCard");e&&t&&n&&(window.settings?.emergency_fund_goal?(e.value=window.settings.emergency_fund_goal,t.classList.add("d-none"),n.classList.remove("d-none")):(t.classList.remove("d-none"),n.classList.add("d-none")));const a=document.getElementById("categoryBudgetsCard");if(a){const e=window.settings?.category_budgets||{};document.querySelectorAll(".category-budget-input").forEach(t=>{const n=t.dataset.category;n&&e[n]&&(t.value=e[n])}),updateCategoryBudgetTotal(),currentUser&&a.classList.remove("d-none")}renderReportsSummary()}function renderReportsSummary(){if(!document.getElementById("reportNetWorth")&&!document.getElementById("reportInvestments"))return;const e=window.assets&&window.assets.length>0||window.investments&&window.investments.length>0||window.debts&&window.debts.length>0||window.bills&&window.bills.length>0||window.income&&window.income.length>0;"function"==typeof toggleEmptyState&&toggleEmptyState("dataContainer","reports",e);const t=(window.investments||[]).reduce((e,t)=>e+getRaw(t.value),0),n=(window.debts||[]).reduce((e,t)=>e+getRaw(t.amount),0),a=t+(window.assets||[]).reduce((e,t)=>e+Math.max(0,getRaw(t.value)-getRaw(t.loan)),0)-n;document.getElementById("reportInvestments")&&(document.getElementById("reportInvestments").textContent=formatCurrency(t)),document.getElementById("reportDebts")&&(document.getElementById("reportDebts").textContent=formatCurrency(n)),document.getElementById("reportNetWorth")&&(document.getElementById("reportNetWorth").textContent=formatCurrency(a))}function getAssetTypeDisplayName(e){return{"real-estate":"Real Estate",vehicle:"Vehicle",other:"Other"}[e]||e}function renderAssets(){const e=document.getElementById("assetTableBody");if(!e)return;const t=window.assets||[];"function"==typeof toggleEmptyState&&toggleEmptyState("dataContainer","assets",t),e.innerHTML=t.map(e=>`\n      <tr>\n          <td>${escapeHtml(e.name)}</td><td>${escapeHtml(getAssetTypeDisplayName(e.type))}</td><td>${formatCurrency(e.value)}</td>\n          <td>${formatCurrency(e.loan)}</td><td>${formatCurrency(Math.max(getRaw(e.value)-getRaw(e.loan),0))}</td>\n          <td>${e.nextDueDate?formatDate(e.nextDueDate):"-"}</td>\n          <td>\n              <button class="btn btn-sm btn-outline-primary" onclick="openAssetModal('${e.id}')" aria-label="Edit ${escapeHtml(e.name)}"><i class="bi bi-pencil"></i></button>\n              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteAsset('${e.id}', '${escapeHtml(e.name)}')" aria-label="Delete ${escapeHtml(e.name)}"><i class="bi bi-trash"></i></button>\n          </td>\n      </tr>`).join("")}function openAssetModal(e=null){editAssetId=e;const t=document.getElementById("assetForm");if(t.reset(),document.querySelectorAll(".asset-fields").forEach(e=>e.classList.add("d-none")),e){document.getElementById("addAssetModalLabel").textContent="Edit Asset";const n=window.assets.find(t=>t.id==e);n&&(t.assetName.value=escapeHtml(n.name||""),t.assetType.value=escapeHtml(n.type||""),"real-estate"===n.type?(document.querySelector(".real-estate-fields").classList.remove("d-none"),t.propertyValue.value=n.value,t.loanAmount.value=n.loan,t.realEstateNextDueDate.value=n.nextDueDate):"vehicle"===n.type&&(document.querySelector(".vehicle-fields").classList.remove("d-none"),t.vehicleValue.value=n.value,t.vehicleLoanBalance.value=n.loan,t.vehicleNextDueDate.value=n.nextDueDate))}else document.getElementById("addAssetModalLabel").textContent="Add Asset";bootstrap.Modal.getOrCreateInstance(t.closest(".modal")).show()}async function saveAsset(){"function"==typeof setButtonLoading&&setButtonLoading("saveAssetBtn",!0);try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return"function"==typeof setButtonLoading&&setButtonLoading("saveAssetBtn",!1),void alert(e.message)}const e=editAssetId?"update_item":"add_asset";await withHybridRateLimit("save",e,async()=>{const e=document.getElementById("assetForm"),t=e.assetType.value,n={name:e.assetName.value,type:t,user_id:currentUser.id};"real-estate"===t?(n.value=getRaw(e.propertyValue.value),n.loan=getRaw(e.loanAmount.value),n.nextDueDate=e.realEstateNextDueDate.value||null):"vehicle"===t&&(n.value=getRaw(e.vehicleValue.value),n.loan=getRaw(e.vehicleLoanBalance.value),n.nextDueDate=e.vehicleNextDueDate.value||null);const{error:a}=editAssetId?await sb.from("assets").update(n).eq("id",editAssetId).eq("user_id",currentUser.id):await sb.from("assets").insert(n);if(a)return"function"==typeof setButtonLoading&&setButtonLoading("saveAssetBtn",!1),alert(a.message);bootstrap.Modal.getInstance(e.closest(".modal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()}),"function"==typeof setButtonLoading&&setButtonLoading("saveAssetBtn",!1)}function confirmDeleteAsset(e,t){deleteAssetId=e,document.getElementById("deleteAssetName").textContent=`"${t}"`,bootstrap.Modal.getOrCreateInstance(document.getElementById("confirmDeleteAssetModal")).show()}async function deleteAssetConfirmed(){if(!rateLimiters.delete.allow("deleteAsset")){const e=rateLimiters.delete.getRemainingTime("deleteAsset"),t=Math.ceil(e/1e3);return void alert(`Too many delete requests. Please wait ${t} seconds.`)}try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const{error:e}=await sb.from("assets").delete().eq("id",deleteAssetId).eq("user_id",currentUser.id);if(e)return alert(e.message);bootstrap.Modal.getInstance(document.getElementById("confirmDeleteAssetModal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()}function getInvestmentTypeDisplayName(e){return{"401k":"401(k)",ira:"Traditional IRA","roth-ira":"Roth IRA",brokerage:"Brokerage",savings:"Savings",cd:"CD",crypto:"Crypto",other:"Other"}[e]||e}function renderInvestments(){const e=document.getElementById("investmentTableBody");if(!e)return;const t=window.investments||[];"function"==typeof toggleEmptyState&&toggleEmptyState("dataContainer","investments",t),e.innerHTML=t.map(e=>`\n      <tr>\n          <td>${escapeHtml(e.name)}</td><td>${escapeHtml(getInvestmentTypeDisplayName(e.type))}</td><td>${formatCurrency(e.startingBalance)}</td>\n          <td>${formatCurrency(e.monthlyContribution)}</td><td>${escapeHtml(e.annualReturn?e.annualReturn+"%":"-")}</td>\n          <td>${e.nextContributionDate?escapeHtml(formatDate(e.nextContributionDate)):"-"}</td><td>${formatCurrency(e.value)}</td>\n          <td>\n              <button class="btn btn-sm btn-outline-primary" onclick="openInvestmentModal('${escapeAttribute(e.id)}')" aria-label="Edit ${escapeAttribute(e.name)}"><i class="bi bi-pencil"></i></button>\n              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteInvestment('${escapeAttribute(e.id)}', '${escapeAttribute(e.name)}')" aria-label="Delete ${escapeAttribute(e.name)}"><i class="bi bi-trash"></i></button>\n          </td>\n      </tr>`).join("")}function openInvestmentModal(e=null){editInvestmentId=e;const t=document.getElementById("investmentForm");if(t.reset(),e){const n=window.investments.find(t=>t.id==e);n&&(t.investmentName.value=escapeHtml(n.name||""),t.investmentType.value=n.type||"",t.investmentValue.value=n.value,t.startingBalance.value=n.startingBalance||"",t.monthlyContribution.value=n.monthlyContribution,t.annualReturn.value=n.annualReturn,t.nextContributionDate.value=n.nextContributionDate)}bootstrap.Modal.getOrCreateInstance(t.closest(".modal")).show()}async function saveInvestment(){"function"==typeof setButtonLoading&&setButtonLoading("saveInvestmentBtn",!0);try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return"function"==typeof setButtonLoading&&setButtonLoading("saveInvestmentBtn",!1),void alert(e.message)}const e=editInvestmentId?"update_item":"add_investment";await withHybridRateLimit("save",e,async()=>{const e=document.getElementById("investmentForm"),t={name:e.investmentName.value,type:e.investmentType.value,value:getRaw(e.investmentValue.value),startingBalance:getRaw(e.startingBalance.value),monthlyContribution:getRaw(e.monthlyContribution.value),annualReturn:getRaw(e.annualReturn.value),nextContributionDate:e.nextContributionDate.value||null,user_id:currentUser.id},{error:n}=editInvestmentId?await sb.from("investments").update(t).eq("id",editInvestmentId).eq("user_id",currentUser.id):await sb.from("investments").insert(t);if(editInvestmentId=null,n)return"function"==typeof setButtonLoading&&setButtonLoading("saveInvestmentBtn",!1),alert(n.message);bootstrap.Modal.getInstance(e.closest(".modal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()}),"function"==typeof setButtonLoading&&setButtonLoading("saveInvestmentBtn",!1)}function confirmDeleteInvestment(e,t){showConfirmModal("Delete Investment",`Are you sure you want to delete "${t}"?`,()=>deleteInvestmentConfirmed(e),{confirmText:"Delete",confirmClass:"btn-danger"})}async function deleteInvestmentConfirmed(e){if(!rateLimiters.delete.allow("deleteInvestment")){const e=rateLimiters.delete.getRemainingTime("deleteInvestment"),t=Math.ceil(e/1e3);return void alert(`Too many delete requests. Please wait ${t} seconds.`)}try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const{error:t}=await sb.from("investments").delete().eq("id",e).eq("user_id",currentUser.id);if(t)return alert(t.message);clearCache(),await fetchAllDataFromSupabase(!0),renderAll()}function getDebtTypeDisplayName(e){return{"credit-card":"Credit Card",mortgage:"Mortgage","student-loan":"Student Loan","auto-loan":"Auto Loan","personal-loan":"Personal Loan",other:"Other"}[e]||e}function renderDebts(){const e=document.getElementById("debtTableBody");if(!e)return;const t=window.debts||[];"function"==typeof toggleEmptyState&&toggleEmptyState("dataContainer","debts",t),e.innerHTML=t.map(e=>`\n      <tr>\n          <td>${escapeHtml(e.name)}</td><td>${escapeHtml(getDebtTypeDisplayName(e.type))}</td><td>${formatCurrency(e.amount)}</td><td>${escapeHtml(e.interestRate)}%</td>\n          <td class="hide-mobile">${escapeHtml(e.term||"-")} months</td><td>${formatCurrency(e.monthlyPayment)}</td>\n          <td class="hide-mobile">${e.nextDueDate?escapeHtml(formatDate(e.nextDueDate)):"-"}</td>\n          <td>\n              <button class="btn btn-sm btn-outline-primary" onclick="openDebtModal('${escapeAttribute(e.id)}')" aria-label="Edit ${escapeAttribute(e.name)}"><i class="bi bi-pencil"></i></button>\n              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteDebt('${escapeAttribute(e.id)}', '${escapeAttribute(e.name)}')" aria-label="Delete ${escapeAttribute(e.name)}"><i class="bi bi-trash"></i></button>\n          </td>\n      </tr>`).join("")}function openDebtModal(e=null){editDebtId=e;const t=document.getElementById("debtForm");if(t.reset(),e){const n=window.debts.find(t=>t.id==e);n&&(t.debtName.value=escapeHtml(n.name||""),t.debtType.value=escapeHtml(n.type||""),t.debtAmount.value=n.amount,t.debtInterest.value=n.interestRate,t.debtTerm.value=n.term,t.debtMonthly.value=n.monthlyPayment,t.debtNextPaymentDate.value=n.nextDueDate)}bootstrap.Modal.getOrCreateInstance(t.closest(".modal")).show()}async function saveDebt(){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const e=editDebtId?"update_item":"add_debt";await withHybridRateLimit("save",e,async()=>{const e=document.getElementById("debtForm"),t={name:e.debtName.value,type:e.debtType.value,amount:getRaw(e.debtAmount.value),interestRate:getRaw(e.debtInterest.value),term:getRaw(e.debtTerm.value),monthlyPayment:getRaw(e.debtMonthly.value),nextDueDate:e.debtNextPaymentDate.value||null,user_id:currentUser.id},{error:n}=editDebtId?await sb.from("debts").update(t).eq("id",editDebtId).eq("user_id",currentUser.id):await sb.from("debts").insert(t);if(n)return alert(n.message);bootstrap.Modal.getInstance(e.closest(".modal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()})}function confirmDeleteDebt(e){deleteDebtId=e,document.getElementById("deleteDebtName").textContent=`"${window.debts.find(t=>t.id===e).name}"`,bootstrap.Modal.getOrCreateInstance(document.getElementById("confirmDeleteDebtModal")).show()}async function deleteDebtConfirmed(){if(!rateLimiters.delete.allow("deleteDebt")){const e=rateLimiters.delete.getRemainingTime("deleteDebt"),t=Math.ceil(e/1e3);return void alert(`Too many delete requests. Please wait ${t} seconds.`)}try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const{error:e}=await sb.from("debts").delete().eq("id",deleteDebtId).eq("user_id",currentUser.id);if(e)return alert(e.message);bootstrap.Modal.getInstance(document.getElementById("confirmDeleteDebtModal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()}function getCategoryBadgeClass(e){return"bg-secondary text-white"}const FINANCING_META={"Golf Clubs":{total_amount:2501.04,payments_made:12,total_payments:12,status:"paid_off",end_date:"2025-12-01"},"Big Green Egg":{total_amount:7788.48,payments_made:8,total_payments:24,status:"active"},XGIMI:{total_amount:1636.32,payments_made:10,total_payments:12,status:"active"},"BMW Payment":{total_amount:92040,payments_made:24,total_payments:60,status:"active"},"BMW 430i":{total_amount:24660,payments_made:24,total_payments:60,status:"active"},"Chevy Tahoe":{total_amount:45855.36,payments_made:12,total_payments:72,status:"active"}};function calculateAmortization(e,t,n,a){a=a||0;const s={monthlyPayment:0,totalCost:0,totalInterest:0,interestPaidToDate:0,principalPaidToDate:0,remainingBalance:e,schedule:[]};if(!e||e<=0||!n||n<=0)return s;let o;if(!t||0===t){o=e/n,s.monthlyPayment=Math.round(100*o)/100,s.totalCost=Math.round(100*e)/100,s.totalInterest=0;let t=e;for(let e=1;e<=n;e++){const n=Math.min(o,t);t=Math.max(0,t-n);const r={payment:e,paymentAmount:Math.round(100*n)/100,principal:Math.round(100*n)/100,interest:0,balance:Math.round(100*t)/100};s.schedule.push(r),e<=a&&(s.principalPaidToDate+=n)}return s.principalPaidToDate=Math.round(100*s.principalPaidToDate)/100,s.remainingBalance=Math.round(100*Math.max(0,e-s.principalPaidToDate))/100,s}const r=t/100/12,i=n,l=Math.pow(1+r,i);o=e*(r*l)/(l-1),s.monthlyPayment=Math.round(100*o)/100,s.totalCost=Math.round(o*i*100)/100,s.totalInterest=Math.round(100*(s.totalCost-e))/100;let d=e;for(let e=1;e<=i;e++){const t=d*r,n=o-t;d=Math.max(0,d-n),e===i&&(d=0);const l={payment:e,paymentAmount:Math.round(100*o)/100,principal:Math.round(100*n)/100,interest:Math.round(100*t)/100,balance:Math.round(100*d)/100};s.schedule.push(l),e<=a&&(s.interestPaidToDate+=t,s.principalPaidToDate+=n)}return s.interestPaidToDate=Math.round(100*s.interestPaidToDate)/100,s.principalPaidToDate=Math.round(100*s.principalPaidToDate)/100,s.remainingBalance=Math.round(100*Math.max(0,e-s.principalPaidToDate))/100,s}function getBillFinancingInfo(e){if(e.total_amount&&e.total_amount>0){const t=e.payments_made||0,n=e.original_principal&&e.original_principal>0,a=e.interest_rate||0,s=e.original_principal||0,o=e.loan_term_months||0,r=e.start_date||null;let i=null;n&&o>0&&(i=calculateAmortization(s,a,o,t));const l=o>0?o:e.total_amount>0&&e.amount>0?Math.ceil(e.total_amount/e.amount):0,d=t*e.amount,c=i?i.remainingBalance:Math.max(0,e.total_amount-d),u=l>0?Math.min(100,t/l*100):0,m=Math.max(0,l-t),g=new Date;return g.setMonth(g.getMonth()+m),{isFinancing:!0,status:e.status||"active",totalAmount:e.total_amount,amountPaid:d,remainingBalance:c,percentPaid:u,paymentsMade:t,totalPayments:l,remainingPayments:m,estimatedPayoffDate:g,interestRate:a,originalPrincipal:s,loanTermMonths:o,startDate:r,hasLoanDetails:n,totalInterest:i?i.totalInterest:null,interestPaidToDate:i?i.interestPaidToDate:null,principalPaidToDate:i?i.principalPaidToDate:null,amortization:i}}const t=Object.keys(FINANCING_META).find(t=>t.toLowerCase()===(e.name||"").toLowerCase()),n=t?FINANCING_META[t]:null;if(!n)return{isFinancing:!1};const a=n.payments_made*e.amount,s=Math.max(0,n.total_amount-a),o=n.total_amount>0?Math.min(100,a/n.total_amount*100):0,r=Math.max(0,n.total_payments-n.payments_made),i=new Date;return i.setMonth(i.getMonth()+r),{isFinancing:!0,status:n.status,totalAmount:n.total_amount,amountPaid:a,remainingBalance:s,percentPaid:o,paymentsMade:n.payments_made,totalPayments:n.total_payments,remainingPayments:r,estimatedPayoffDate:n.end_date?new Date(n.end_date+"T00:00:00"):i,interestRate:null,originalPrincipal:null,loanTermMonths:null,startDate:null,hasLoanDetails:!1,totalInterest:null,interestPaidToDate:null,principalPaidToDate:null,amortization:null}}function renderBills(){const e=document.getElementById("billTableBody");if(!e)return;const t=[...window.bills||[],...window.sharedBillsForDisplay||[]];"function"==typeof toggleEmptyState&&toggleEmptyState("dataContainer","bills",t);const n=e=>"financing"===(e.type||"").toLowerCase()||getBillFinancingInfo(e).isFinancing,a=t.filter(e=>!n(e)),s=t.filter(e=>n(e)),o=(s.filter(e=>"paid_off"!==getBillFinancingInfo(e).status),s.filter(e=>"paid_off"===getBillFinancingInfo(e).status),t.filter(e=>{const t=getBillFinancingInfo(e);return!(t.isFinancing&&"paid_off"===t.status)}));if(0===o.length){e.innerHTML='\n      <tr>\n        <td colspan="6" class="text-center py-5">\n          <div class="empty-state-inline">\n            <svg xmlns="http://www.w3.org/2000/svg" class="empty-state-icon-inline" fill="none" viewBox="0 0 24 24" stroke="currentColor" width="64" height="64">\n              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2" />\n            </svg>\n            <h3 class="mt-3" style="color: var(--color-text-primary);">No Bills Yet</h3>\n            <p class="text-muted">Track your recurring expenses like rent, utilities, and subscriptions</p>\n            <div class="d-flex gap-2 justify-content-center mt-3 flex-wrap">\n              <button class="btn btn-primary" onclick="typeof openBillModal === \'function\' && openBillModal()" aria-label="Add your first bill">\n                <i class="bi bi-plus-circle"></i> Add Your First Bill\n              </button>\n              <button class="btn btn-outline-secondary" id="scanEmailFromEmpty" onclick="document.getElementById(\'scanEmailBillsBtn\')?.click()" aria-label="Scan email for bills">\n                <i class="bi bi-envelope-check"></i> Scan Email\n              </button>\n            </div>\n          </div>\n        </td>\n      </tr>\n    ';const t=document.getElementById("totalBills"),n=document.getElementById("subscriptionsCount");return t&&(t.textContent="$0.00"),void(n&&(n.textContent="0"))}e.innerHTML=o.map(e=>{if(e.isSharedWithMe){const t=`<span class="badge bg-secondary ms-1" title="Shared by ${escapeAttribute(e.sharedByName)}"><i class="bi bi-people-fill me-1"></i>${escapeHtml(e.splitLabel)}</span>`;return`\n        <tr>\n            <td>${escapeHtml(e.name)} ${t}\n              <small class="d-block" style="color: var(--color-text-tertiary);">from ${escapeHtml(e.sharedByName)}</small>\n            </td>\n            <td><span class="badge ${getCategoryBadgeClass(e.type)}">${escapeHtml(e.type)}</span></td>\n            <td><strong style="color: var(--color-primary);">${formatCurrency(e.amount)}</strong>\n              <small class="d-block" style="color: var(--color-text-tertiary);">of ${formatCurrency(e.fullAmount)}</small>\n            </td>\n            <td>${escapeHtml(e.frequency||"monthly")}</td>\n            <td>${e.nextDueDate?escapeHtml(formatDate(e.nextDueDate)):"-"}</td>\n            <td>\n              <span class="badge bg-secondary-subtle"><i class="bi bi-link-45deg me-1"></i>Shared</span>\n            </td>\n        </tr>`}const t=getShareInfoForBill(e.id),n=t?`<span class="badge bg-secondary ms-1" title="Shared with ${escapeAttribute(t.shared_user?.display_name||"someone")}"><i class="bi bi-people-fill me-1"></i>${escapeHtml("accepted"===t.status?"Shared":"Pending")}</span>`:"";return`\n      <tr>\n          <td>${escapeHtml(e.name)} ${n}</td><td><span class="badge ${getCategoryBadgeClass(e.type)}">${escapeHtml(e.type)}</span></td><td>${formatCurrency(e.amount)}${t&&"accepted"===t.status?`<small class="d-block" style="color: var(--color-text-tertiary);">Your share: ${formatCurrency(t.owner_amount)}</small>`:""}</td>\n          <td>${escapeHtml(e.frequency)}</td><td>${e.nextDueDate?escapeHtml(formatDate(e.nextDueDate)):"-"}</td>\n          <td>\n              <button class="btn btn-sm btn-outline-info" onclick="openShareBillModal('${escapeAttribute(e.id)}')" aria-label="Share ${escapeAttribute(e.name)}"><i class="bi bi-share"></i></button>\n              <button class="btn btn-sm btn-outline-primary" onclick="openBillModal('${escapeAttribute(e.id)}')" aria-label="Edit ${escapeAttribute(e.name)}"><i class="bi bi-pencil"></i></button>\n              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteBill('${escapeAttribute(e.id)}', '${escapeAttribute(e.name)}')" aria-label="Delete ${escapeAttribute(e.name)}"><i class="bi bi-trash"></i></button>\n          </td>\n      </tr>`}).join("");const r=o.reduce((e,t)=>{if(!t.amount||0===t.amount||!t.frequency)return e;if(t.isSharedWithMe)return e+normalizeToMonthly(t.amount,t.frequency);const n=getShareInfoForBill(t.id),a=n&&"accepted"===n.status?n.owner_amount:t.amount;return a&&0!==a?e+normalizeToMonthly(a,t.frequency):e},0);if(document.getElementById("billsTotal")){const e=document.getElementById("billsTotal");e.textContent=formatCurrency(r),e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}if(document.getElementById("billsRecurringCount")){const e=document.getElementById("billsRecurringCount");e.textContent=a.length,e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}const i=(window.sharedBillsForDisplay||[]).length;if(document.getElementById("billsSharedCount")){const e=document.getElementById("billsSharedCount");e.textContent=i,e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}const l=document.getElementById("billsNextDueAmount"),d=document.getElementById("billsNextDueName");if(l&&d){const e=new Date,t=new Date(e);t.setHours(0,0,0,0);const n=o.filter(e=>e.nextDueDate&&new Date(e.nextDueDate+"T00:00:00")>=t).sort((e,t)=>new Date(e.nextDueDate).getTime()-new Date(t.nextDueDate).getTime())[0];if(n){const e=Math.ceil((new Date(n.nextDueDate+"T00:00:00").getTime()-t.getTime())/864e5),a=0===e?"Today":1===e?"Tomorrow":`${e}d`;l.textContent=formatCurrency(n.amount),l.style.color=e<=3?"var(--color-danger)":e<=7?"var(--color-warning)":"",d.textContent=`${n.name} · ${a}`}else l.textContent="—",d.textContent="No upcoming bills";l.classList.remove("d-none"),d.classList.remove("d-none");const a=l.closest(".summary-card");a&&a.classList.remove("loading")}}function renderFinancingCards(){const e=document.getElementById("financingCards");if(!e)return;const t=(window.bills||[]).filter(e=>(e=>"financing"===(e.type||"").toLowerCase()||getBillFinancingInfo(e).isFinancing)(e)),n=t.filter(e=>"paid_off"!==getBillFinancingInfo(e).status).sort((e,t)=>getBillFinancingInfo(t).remainingBalance-getBillFinancingInfo(e).remainingBalance),a=t.filter(e=>"paid_off"===getBillFinancingInfo(e).status);n.length>0?e.innerHTML=n.map(e=>{const t=getBillFinancingInfo(e),n=t.percentPaid>=75?"var(--color-success)":"var(--color-primary)",a=t.estimatedPayoffDate?escapeHtml(t.estimatedPayoffDate.toLocaleDateString("en-US",{month:"short",year:"numeric"})):"N/A",s=null!==t.interestRate&&void 0!==t.interestRate?`<span class="badge ${0===t.interestRate?"bg-success":"bg-warning text-dark"} ms-1" style="font-size: 0.7rem;">${escapeHtml(t.interestRate)}% APR</span>`:"",o=t.hasLoanDetails&&null!==t.interestPaidToDate?`\n            <div class="mt-3 mb-2">\n              <div class="d-flex justify-content-between mb-1">\n                <small style="color: var(--color-text-secondary);">Principal vs Interest Paid</small>\n              </div>\n              <div class="progress" style="height: 8px; border-radius: var(--radius-full);">\n                <div class="progress-bar" role="progressbar"\n                     style="width: ${escapeAttribute(String(t.amountPaid>0?t.principalPaidToDate/(t.principalPaidToDate+t.interestPaidToDate)*100:0))}%; background-color: var(--color-primary);"\n                     title="Principal: ${escapeAttribute(formatCurrency(t.principalPaidToDate))}">\n                </div>\n                <div class="progress-bar" role="progressbar"\n                     style="width: ${escapeAttribute(String(t.amountPaid>0?t.interestPaidToDate/(t.principalPaidToDate+t.interestPaidToDate)*100:0))}%; background-color: var(--color-secondary);"\n                     title="Interest: ${escapeAttribute(formatCurrency(t.interestPaidToDate))}">\n                </div>\n              </div>\n              <div class="d-flex justify-content-between mt-1">\n                <small style="color: var(--color-primary);">Principal: ${formatCurrency(t.principalPaidToDate)}</small>\n                <small style="color: var(--color-secondary);">Interest: ${formatCurrency(t.interestPaidToDate)}</small>\n              </div>\n            </div>`:"",r=t.hasLoanDetails?`<button class="btn btn-sm btn-outline-info mt-2" onclick="showAmortizationSchedule('${escapeAttribute(e.id)}')"><i class="bi bi-table me-1"></i>View Schedule</button>`:"";return`\n      <div class="col-xl-4 col-md-6 col-12">\n        <div class="card h-100">\n          <div class="card-body p-4 d-flex flex-column">\n            <div class="financing-card-header" style="margin-bottom: 12px;">\n              \x3c!-- Name and action buttons on same line --\x3e\n              <div class="d-flex justify-content-between align-items-center mb-2">\n                <h5 class="mb-0" title="${escapeAttribute(e.name)}" style="color: var(--color-text-primary); font-size: var(--text-h5); line-height: 1.3; flex: 1; min-width: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${escapeHtml(e.name)}</h5>\n                <div class="d-flex gap-2" style="flex-shrink: 0; margin-left: 12px;">\n                  <button class="btn btn-sm btn-outline-secondary" onclick="openShareBillModal('${escapeAttribute(e.id)}')" aria-label="Share ${escapeAttribute(e.name)}"><i class="bi bi-share"></i></button>\n                  <button class="btn btn-sm btn-outline-secondary" onclick="openBillModal('${escapeAttribute(e.id)}')" aria-label="Edit ${escapeAttribute(e.name)}"><i class="bi bi-pencil"></i></button>\n                  <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteBill('${escapeAttribute(e.id)}', '${escapeAttribute(e.name)}')" aria-label="Delete ${escapeAttribute(e.name)}"><i class="bi bi-trash"></i></button>\n                </div>\n              </div>\n              \x3c!-- Badges on separate line below name --\x3e\n              <div class="d-flex gap-2 flex-wrap">\n                <span class="badge ${getCategoryBadgeClass(e.type)}">${escapeHtml(e.type)}</span>${s}\n              </div>\n            </div>\n            <div class="mb-3">\n              <div class="d-flex justify-content-between mb-1">\n                <small style="color: var(--color-text-secondary);">Progress</small>\n                <small style="color: var(--color-text-secondary);">${escapeHtml(Math.round(t.percentPaid))}%</small>\n              </div>\n              <div class="progress" style="height: 12px; border-radius: var(--radius-full);">\n                <div class="progress-bar" role="progressbar"\n                     style="width: ${escapeAttribute(String(t.percentPaid))}%; background-color: ${escapeAttribute(n)};"\n                     aria-valuenow="${escapeAttribute(String(t.percentPaid))}" aria-valuemin="0" aria-valuemax="100">\n                </div>\n              </div>\n            </div>${o}\n            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px 16px; margin-top: 4px;">\n              <div style="text-align: left;">\n                <small style="color: var(--color-text-tertiary); font-size: 0.75rem;">Monthly</small>\n                <div><strong style="color: var(--color-primary);">${formatCurrency(e.amount)}</strong></div>\n              </div>\n              <div style="text-align: right;">\n                <small style="color: var(--color-text-tertiary); font-size: 0.75rem;">Remaining</small>\n                <div><strong style="color: var(--color-text-primary);">${formatCurrency(t.remainingBalance)}</strong></div>\n              </div>\n              <div style="text-align: left;">\n                <small style="color: var(--color-text-tertiary); font-size: 0.75rem;">Payoff</small>\n                <div><strong style="color: var(--color-text-primary);">${a}</strong></div>\n              </div>\n              ${null!==t.totalInterest?`<div style="text-align: right;">\n                <small style="color: var(--color-text-tertiary); font-size: 0.75rem;">Total Interest</small>\n                <div><strong style="color: var(--color-secondary);">${formatCurrency(t.totalInterest)}</strong></div>\n              </div>`:"<div></div>"}\n            </div>\n            <div class="mt-2 text-center">\n              <small style="color: var(--color-text-tertiary);">${escapeHtml(t.paymentsMade)} of ${escapeHtml(t.totalPayments)} payments made</small>\n              ${r}\n            </div>\n          </div>\n        </div>\n      </div>`}).join(""):e.innerHTML='<div class="col-12"><p class="text-muted fst-italic">No active financing items.</p></div>';const s=document.getElementById("completedSection"),o=document.getElementById("completedCards");s&&o&&(a.length>0?(s.classList.remove("d-none"),o.innerHTML=a.map(e=>{const t=getBillFinancingInfo(e);return`\n        <div class="col-xl-4 col-md-6 col-12">\n          <div class="card h-100" style="border-color: var(--color-success); opacity: 0.85;">\n            <div class="card-body p-4">\n              <div class="d-flex justify-content-between align-items-start mb-3">\n                <div>\n                  <h5 class="mb-1" style="color: var(--color-text-primary); font-size: var(--text-h5);">\n                    ✓ ${escapeHtml(e.name)}\n                  </h5>\n                  <span class="badge bg-success">Paid Off</span>\n                </div>\n                <div class="text-end">\n                  <button class="btn btn-sm btn-outline-primary" onclick="openBillModal('${escapeAttribute(e.id)}')" aria-label="Edit ${escapeAttribute(e.name)}"><i class="bi bi-pencil"></i></button>\n                  <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteBill('${escapeAttribute(e.id)}', '${escapeAttribute(e.name)}')" aria-label="Delete ${escapeAttribute(e.name)}"><i class="bi bi-trash"></i></button>\n                </div>\n              </div>\n              <div class="mb-3">\n                <div class="progress" style="height: 12px; border-radius: var(--radius-full);">\n                  <div class="progress-bar" role="progressbar"\n                       style="width: 100%; background-color: var(--color-success);"\n                       aria-valuenow="100" aria-valuemin="0" aria-valuemax="100">\n                  </div>\n                </div>\n              </div>\n              <div class="row g-2 text-center">\n                <div class="col-6">\n                  <small class="d-block" style="color: var(--color-text-tertiary);">Total Paid</small>\n                  <strong style="color: var(--color-success);">${formatCurrency(t.totalAmount)}</strong>\n                </div>\n                <div class="col-6">\n                  <small class="d-block" style="color: var(--color-text-tertiary);">Completed</small>\n                  <strong style="color: var(--color-success);">${escapeHtml(t.paymentsMade)} payments</strong>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>`}).join("")):s.classList.add("d-none"))}function isFinancingBillType(e){const t=(e||"").toLowerCase();return"financing"===t||"auto"===t||"housing"===t}function toggleFinancingFields(){const e=document.getElementById("billType").value,t=document.getElementById("financingFields");t&&t.classList.toggle("d-none",!isFinancingBillType(e))}function getLoanTermMonths(){const e=parseInt(document.getElementById("billLoanTermValue").value)||0;return"years"===document.getElementById("billLoanTermUnit").value?12*e:e}function updateLoanCalcPreview(){const e=parseFloat(document.getElementById("billOriginalPrincipal").value)||0,t=parseFloat(document.getElementById("billInterestRate").value)||0,n=getLoanTermMonths(),a=parseInt(document.getElementById("billPaymentsMade").value)||0,s=document.getElementById("loanCalcPreview"),o=document.getElementById("remainingBalanceDisplay");if(s)if(e>0&&n>0){const r=calculateAmortization(e,t,n,a);document.getElementById("calcMonthlyPayment").textContent=formatCurrency(r.monthlyPayment),document.getElementById("calcTotalInterest").textContent=formatCurrency(r.totalInterest),s.classList.remove("d-none");const i=document.getElementById("billTotalFinanced");i.value||(i.placeholder=formatCurrency(r.totalCost)+" (auto)"),o&&(o.textContent=formatCurrency(r.remainingBalance))}else s.classList.add("d-none"),o&&(o.textContent="�")}function openBillModal(e=null){editBillId=e;const t=document.getElementById("billForm");t.reset();const n=document.getElementById("financingFields");n&&n.classList.add("d-none");const a=document.getElementById("loanCalcPreview");a&&a.classList.add("d-none");const s=document.getElementById("remainingBalanceDisplay");if(s&&(s.textContent="�"),e){const a=window.bills.find(t=>t.id==e);if(a){t.billName.value=escapeHtml(a.name||""),t.billType.value=escapeHtml(a.type||""),t.billAmount.value=a.amount,t.billFrequency.value=a.frequency,t.billNextDueDate.value=a.nextDueDate;const e=a.total_amount||a.original_principal||a.payments_made>0,s=Object.keys(FINANCING_META).find(e=>e.toLowerCase()===(a.name||"").toLowerCase()),o=s?FINANCING_META[s]:null;if(isFinancingBillType(a.type)||e||s){if(n&&n.classList.remove("d-none"),void 0!==a.interest_rate&&null!==a.interest_rate&&(t.billInterestRate.value=a.interest_rate),a.original_principal&&(t.billOriginalPrincipal.value=a.original_principal),a.loan_term_months){const e=document.getElementById("billLoanTermUnit"),t=document.getElementById("billLoanTermValue");a.loan_term_months%12==0&&a.loan_term_months>=12?(t.value=a.loan_term_months/12,e.value="years"):(t.value=a.loan_term_months,e.value="months")}if(a.start_date&&(t.billStartDate.value=a.start_date),a.payments_made&&(t.billPaymentsMade.value=a.payments_made),a.total_amount&&(t.billTotalFinanced.value=a.total_amount),o&&!a.payments_made&&(t.billPaymentsMade.value=o.payments_made||""),o&&!a.total_amount&&(t.billTotalFinanced.value=o.total_amount||""),o&&!a.loan_term_months&&o.total_payments){const e=document.getElementById("billLoanTermUnit"),t=document.getElementById("billLoanTermValue");o.total_payments%12==0&&o.total_payments>=12?(t.value=o.total_payments/12,e.value="years"):(t.value=o.total_payments,e.value="months")}updateLoanCalcPreview();const e=document.getElementById("remainingBalanceDisplay");if(e&&"�"===e.textContent){const t=getBillFinancingInfo(a);t.isFinancing&&(e.textContent=formatCurrency(t.remainingBalance))}}}}const o=document.getElementById("billType");o.removeEventListener("change",toggleFinancingFields),o.addEventListener("change",toggleFinancingFields),["billOriginalPrincipal","billInterestRate","billLoanTermValue","billPaymentsMade"].forEach(e=>{const t=document.getElementById(e);t&&(t.removeEventListener("input",updateLoanCalcPreview),t.addEventListener("input",updateLoanCalcPreview))});const r=document.getElementById("billLoanTermUnit");r&&(r.removeEventListener("change",updateLoanCalcPreview),r.addEventListener("change",updateLoanCalcPreview)),bootstrap.Modal.getOrCreateInstance(t.closest(".modal")).show()}async function saveBill(){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const e=editBillId?"update_item":"add_bill";await withHybridRateLimit("save",e,async()=>{const e=document.getElementById("billForm"),t={name:e.billName.value,type:e.billType.value,amount:getRaw(e.billAmount.value),frequency:e.billFrequency.value,nextDueDate:e.billNextDueDate.value||null,user_id:currentUser.id};if(!document.getElementById("financingFields").classList.contains("d-none")){const n=e.billInterestRate.value,a=e.billOriginalPrincipal.value,s=getLoanTermMonths(),o=e.billStartDate.value,r=e.billPaymentsMade.value,i=e.billTotalFinanced.value;if(""!==n&&(t.interest_rate=parseFloat(n)),""!==a&&(t.original_principal=parseFloat(a)),s>0&&(t.loan_term_months=s),o&&(t.start_date=o),""!==r&&(t.payments_made=parseInt(r)),""!==i)t.total_amount=parseFloat(i);else if(a&&s>0){const e=calculateAmortization(parseFloat(a),parseFloat(n)||0,s,0);t.total_amount=e.totalCost}}let{error:n}=editBillId?await sb.from("bills").update(t).eq("id",editBillId).eq("user_id",currentUser.id):await sb.from("bills").insert(t);if(n&&n.message&&n.message.includes("column")){const e={name:t.name,type:t.type,amount:t.amount,frequency:t.frequency,nextDueDate:t.nextDueDate,user_id:t.user_id};t.total_amount&&(e.total_amount=t.total_amount),void 0!==t.payments_made&&(e.payments_made=t.payments_made),n=(editBillId?await sb.from("bills").update(e).eq("id",editBillId).eq("user_id",currentUser.id):await sb.from("bills").insert(e)).error}if(n)return alert(n.message);bootstrap.Modal.getInstance(e.closest(".modal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()})}function showAmortizationSchedule(e){const t=(window.bills||[]).find(t=>t.id==e);if(!t)return;const n=getBillFinancingInfo(t);if(!n.hasLoanDetails||!n.amortization)return void alert("Loan details are required to view the amortization schedule. Edit this bill and add principal, rate, and term.");const a=n.amortization,s=document.getElementById("amortSummary");s&&(s.innerHTML=`\n      <div class="col-md-3 col-6">\n        <div class="card" style="background: var(--color-bg-3); border-color: var(--color-border-subtle);">\n          <div class="card-body py-2 px-3 text-center">\n            <small style="color: var(--color-text-tertiary);">Monthly Payment</small>\n            <div><strong style="color: var(--color-primary);">${formatCurrency(a.monthlyPayment)}</strong></div>\n          </div>\n        </div>\n      </div>\n      <div class="col-md-3 col-6">\n        <div class="card" style="background: var(--color-bg-3); border-color: var(--color-border-subtle);">\n          <div class="card-body py-2 px-3 text-center">\n            <small style="color: var(--color-text-tertiary);">Total Cost</small>\n            <div><strong style="color: var(--color-text-primary);">${formatCurrency(a.totalCost)}</strong></div>\n          </div>\n        </div>\n      </div>\n      <div class="col-md-3 col-6">\n        <div class="card" style="background: var(--color-bg-3); border-color: var(--color-border-subtle);">\n          <div class="card-body py-2 px-3 text-center">\n            <small style="color: var(--color-text-tertiary);">Total Interest</small>\n            <div><strong style="color: var(--color-secondary);">${formatCurrency(a.totalInterest)}</strong></div>\n          </div>\n        </div>\n      </div>\n      <div class="col-md-3 col-6">\n        <div class="card" style="background: var(--color-bg-3); border-color: var(--color-border-subtle);">\n          <div class="card-body py-2 px-3 text-center">\n            <small style="color: var(--color-text-tertiary);">Remaining Balance</small>\n            <div><strong style="color: var(--color-text-primary);">${formatCurrency(a.remainingBalance)}</strong></div>\n          </div>\n        </div>\n      </div>`);const o=document.getElementById("amortTableBody");if(o){const e=n.paymentsMade||0;o.innerHTML=a.schedule.map(t=>{const n=t.payment<=e,a=t.payment===e+1;let s="",o="";return a?(s="table-active",o="border-left: 3px solid var(--color-primary); font-weight: 600;"):n&&(o="opacity: 0.6;"),`<tr class="${escapeAttribute(s)}" style="${escapeAttribute(o)}">\n        <td>${a?'<i class="bi bi-arrow-right-circle-fill me-1" style="color: var(--color-primary);"></i>':""}${escapeHtml(t.payment)}</td>\n        <td>${formatCurrency(t.paymentAmount)}</td>\n        <td>${formatCurrency(t.principal)}</td>\n        <td>${formatCurrency(t.interest)}</td>\n        <td>${formatCurrency(t.balance)}</td>\n      </tr>`}).join("")}const r=document.getElementById("amortizationModalLabel");r&&(r.textContent=`Amortization Schedule � ${t.name}`),bootstrap.Modal.getOrCreateInstance(document.getElementById("amortizationModal")).show()}async function confirmDeleteBill(e,t){deleteBillId=e,billSharesCache.filter(t=>t.bill_id===e&&"accepted"===t.status).length>0?showSharedBillDeleteWarning(e,t):(document.getElementById("deleteBillName").textContent=`"${t}"`,bootstrap.Modal.getOrCreateInstance(document.getElementById("confirmDeleteBillModal")).show())}function showSharedBillDeleteWarning(e,t){const n=billSharesCache.filter(t=>t.bill_id===e&&"accepted"===t.status).length;document.getElementById("sharedBillName").textContent=`"${t}"`,document.getElementById("sharedUserCount").textContent=n,document.getElementById("confirmSharedBillDelete").onclick=async()=>{const e=bootstrap.Modal.getInstance(document.getElementById("sharedBillDeleteWarningModal"));e&&e.hide(),await deleteBillConfirmed()},bootstrap.Modal.getOrCreateInstance(document.getElementById("sharedBillDeleteWarningModal")).show()}async function deleteBillConfirmed(){if(!rateLimiters.delete.allow("deleteBill")){const e=rateLimiters.delete.getRemainingTime("deleteBill"),t=Math.ceil(e/1e3);return void alert(`Too many delete requests. Please wait ${t} seconds.`)}try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const{error:e}=await sb.from("bills").delete().eq("id",deleteBillId).eq("user_id",currentUser.id);if(e)return alert(e.message);bootstrap.Modal.getInstance(document.getElementById("confirmDeleteBillModal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()}function getIncomeTypeDisplayName(e){return{salary:"Salary (W2)",hourly:"Hourly",commission:"Commission",bonus:"Bonus",freelance:"Freelance (1099)",rental:"Rental",investment:"Investment",other:"Other"}[e]||e}function getIncomeFrequencyDisplayName(e){return{weekly:"Weekly","bi-weekly":"Bi-Weekly","semi-monthly":"Semi-Monthly",monthly:"Monthly",quarterly:"Quarterly",annually:"Annually"}[e]||e}function renderIncome(){const e=document.getElementById("incomeTableBody");if(!e)return;const t=window.income||[];"function"==typeof toggleEmptyState&&toggleEmptyState("dataContainer","income",t),e.innerHTML=t.map(e=>`\n      <tr>\n          <td>${escapeHtml(e.name)}</td>\n          <td>${escapeHtml(getIncomeTypeDisplayName(e.type))}</td>\n          <td>${formatCurrency(e.amount)}</td>\n          <td>${escapeHtml(getIncomeFrequencyDisplayName(e.frequency))}</td>\n          <td>${e.nextDueDate?escapeHtml(formatDate(e.nextDueDate)):"-"}</td>\n          <td>\n              <button class="btn btn-sm btn-outline-primary" onclick="openIncomeModal('${escapeAttribute(e.id)}')" aria-label="Edit ${escapeAttribute(e.name)}"><i class="bi bi-pencil"></i></button>\n              <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteIncome('${escapeAttribute(e.id)}', '${escapeAttribute(e.name)}')" aria-label="Delete ${escapeAttribute(e.name)}"><i class="bi bi-trash"></i></button>\n          </td>\n      </tr>`).join("");const n={weekly:52/12,"bi-weekly":26/12,"semi-monthly":2,monthly:1,quarterly:1/3,annually:1/12};let a=0;t.forEach(e=>{const t=n[e.frequency]||1;a+=(parseFloat(e.amount)||0)*t});const s=12*a,o=new Date;o.setHours(0,0,0,0);let r=null;if(t.forEach(e=>{if(e.nextDueDate){const t=new Date(e.nextDueDate);t>=o&&(!r||t<new Date(r.nextDueDate))&&(r=e)}}),document.getElementById("incomeMonthlyTotal")){const e=document.getElementById("incomeMonthlyTotal");e.textContent=formatCurrency(a),e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}if(document.getElementById("incomeAnnualTotal")){const e=document.getElementById("incomeAnnualTotal");e.textContent=formatCurrency(s),e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}if(document.getElementById("incomeNextPayAmount")){const e=document.getElementById("incomeNextPayAmount"),t=document.getElementById("incomeNextPayDate");r?(e.textContent=formatCurrency(r.amount),t&&(t.textContent=formatDate(r.nextDueDate),t.classList.remove("d-none"))):e.textContent="—",e.classList.remove("d-none");const n=e.closest(".summary-card");n&&n.classList.remove("loading")}}function openIncomeModal(e=null){editIncomeId=e;const t=document.getElementById("incomeForm");if(t.reset(),e){const n=window.income.find(t=>t.id==e);n&&(t.incomeName.value=escapeHtml(n.name||""),t.incomeType.value=n.type||"",t.incomeAmount.value=n.amount,t.incomeFrequency.value=n.frequency||"",t.incomeNextDueDate.value=n.nextDueDate)}bootstrap.Modal.getOrCreateInstance(t.closest(".modal")).show()}async function saveIncome(){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const e=editIncomeId?"update_item":"add_income";await withHybridRateLimit("save",e,async()=>{const e=document.getElementById("incomeForm"),t={name:e.incomeName.value,type:e.incomeType.value,amount:getRaw(e.incomeAmount.value),frequency:e.incomeFrequency.value,nextDueDate:e.incomeNextDueDate.value||null,user_id:currentUser.id},{error:n}=editIncomeId?await sb.from("income").update(t).eq("id",editIncomeId).eq("user_id",currentUser.id):await sb.from("income").insert(t);if(n)return alert(n.message);bootstrap.Modal.getInstance(e.closest(".modal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()})}function confirmDeleteIncome(e,t){deleteIncomeId=e,document.getElementById("deleteIncomeName").textContent=`"${t}"`,bootstrap.Modal.getOrCreateInstance(document.getElementById("confirmDeleteIncomeModal")).show()}async function deleteIncomeConfirmed(){if(!rateLimiters.delete.allow("deleteIncome")){const e=rateLimiters.delete.getRemainingTime("deleteIncome"),t=Math.ceil(e/1e3);return void alert(`Too many delete requests. Please wait ${t} seconds.`)}try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const{error:e}=await sb.from("income").delete().eq("id",deleteIncomeId).eq("user_id",currentUser.id);if(e)return alert(e.message);bootstrap.Modal.getInstance(document.getElementById("confirmDeleteIncomeModal")).hide(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll()}async function renderEmergencyFundChart(){const e=document.getElementById("emergencyFundChartWrapper");if(!e)return;emergencyFundChart&&emergencyFundChart.destroy(),e.textContent="";const t=window.settings?.emergency_fund_goal||0,n=(window.investments||[]).find(e=>e.name.toLowerCase().includes("emergency fund")),a=n?.value||0;if(t>0){const n=document.createElement("canvas");e.appendChild(n);const s=getThemeColors();emergencyFundChart=await safeCreateChart(n,{type:"bar",data:{labels:["Goal","Current"],datasets:[{data:[t,a],backgroundColor:["#f0a500","#81b900"],barThickness:50}]},options:{indexAxis:"y",responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{x:{ticks:{color:s.text,callback:e=>formatCurrency(e)},grid:{color:s.grid},min:0},y:{ticks:{color:s.text},grid:{display:!1}}}}},"Emergency Fund")}else e.innerHTML='\n          <div class="text-center">\n              <p class="text-muted mb-2">You don\'t have an emergency fund goal set.</p>\n              <a href="settings.html" class="btn btn-primary btn-sm">Click here to set one</a>\n          </div>\n      '}async function saveSettings(){if(!rateLimiters.save.allow("saveSettings")){const e=rateLimiters.save.getRemainingTime("saveSettings"),t=Math.ceil(e/1e3);return void alert(`Too many save requests. Please wait ${t} seconds.`)}try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}if(!currentUser)return;const e=document.getElementById("emergencyFundGoal"),t=getRaw(e.value);if(e.classList.contains("is-invalid")){const e=document.getElementById("settingsStatus");return e.innerHTML='<span class="text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i>Please fix validation errors before saving.</span>',void setTimeout(()=>{e.innerHTML=""},5e3)}if(t&&(t<100||t>1e6)){const e=document.getElementById("settingsStatus");return e.innerHTML='<span class="text-warning"><i class="bi bi-exclamation-triangle-fill me-1"></i>Please enter a value between $100 and $1,000,000.</span>',void setTimeout(()=>{e.innerHTML=""},5e3)}const n=document.getElementById("settingsStatus");n.innerHTML='<span class="text-muted"><i class="spinner-border spinner-border-sm me-1"></i>Saving...</span>',n.className="ms-3";const{error:a}=await sb.from("settings").upsert({user_id:currentUser.id,emergency_fund_goal:t});a?n.innerHTML='<span class="text-danger"><i class="bi bi-exclamation-circle-fill me-1"></i>Save failed. Try again.</span>':(n.innerHTML='<span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Saved successfully!</span>',clearCache(),await fetchAllDataFromSupabase(!0)),setTimeout(()=>{n.innerHTML=""},3e3)}async function saveCategoryBudgets(){if(!currentUser)return;const e=document.getElementById("budgetSettingsStatus");if(!e)return;const t={};document.querySelectorAll(".category-budget-input").forEach(e=>{const n=e.dataset.category,a=parseFloat(e.value)||0;n&&a>0&&(t[n]=a)}),e.innerHTML='<span class="text-muted"><i class="spinner-border spinner-border-sm me-1"></i>Saving...</span>';const{error:n}=await sb.from("settings").upsert({user_id:currentUser.id,category_budgets:t});n?e.innerHTML='<span class="text-danger"><i class="bi bi-exclamation-circle-fill me-1"></i>Save failed. Try again.</span>':(window.settings&&(window.settings.category_budgets=t),e.innerHTML='<span class="text-success"><i class="bi bi-check-circle-fill me-1"></i>Budgets saved!</span>',clearCache()),setTimeout(()=>{e.innerHTML=""},3e3)}function updateCategoryBudgetTotal(){const e=document.getElementById("categoryBudgetTotal");if(!e)return;let t=0;document.querySelectorAll(".category-budget-input").forEach(e=>{t+=parseFloat(e.value)||0}),0===t?(e.textContent="Nothing budgeted yet — fill in your limits above",e.className="text-muted small fst-italic"):(e.textContent="$"+t.toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})+" / mo",e.className="fw-bold text-success")}async function renderAdditionalCharts(){if(!currentUser)return;if(!document.getElementById("netWorthDeltaChart"))return;const[e,t,n,a,s,o]=await Promise.all([sb.from("snapshots").select("date, netWorth").eq("user_id",currentUser.id),sb.from("bills").select("type, amount, frequency, nextDueDate").eq("user_id",currentUser.id),sb.from("debts").select("type, monthlyPayment, nextDueDate").eq("user_id",currentUser.id),sb.from("income").select("amount, frequency, nextDueDate").eq("user_id",currentUser.id),sb.from("investments").select("value, annualReturn, monthlyContribution").eq("user_id",currentUser.id),sb.from("assets").select("name, value").eq("user_id",currentUser.id)]),r=e.data||[],i=t.data||[],l=n.data||[],d=a.data||[],c=s.data||[],u=(o.data,{});r.forEach(({date:e,netWorth:t})=>{const n=new Date(e).toLocaleString("default",{month:"short",year:"numeric"});u[n]=t});const m=Object.entries(u).sort(([e],[t])=>new Date(e)-new Date(t)),g=m.map(([e])=>e),p=m.map(([,e],t,n)=>0===t?0:e-n[t-1][1]);netWorthDeltaChartInst&&netWorthDeltaChartInst.destroy(),netWorthDeltaChartInst=safeCreateChart(document.getElementById("netWorthDeltaChart"),{type:"bar",data:{labels:g,datasets:[{label:"Change ($)",data:p,backgroundColor:e=>e.raw<0?"#e53935":"#81b900"}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1}},scales:{y:{ticks:{color:"#b0b0b0"},grid:{color:"rgba(240,240,240,0.08)"}},x:{ticks:{color:"#b0b0b0"},grid:{display:!1}}}}},"Net Worth Delta");const y={};[...i,...l.map(e=>({type:e.type,amount:e.monthlyPayment}))].forEach(e=>{y[e.type]=(y[e.type]||0)+parseFloat(e.amount||0)});const h=Object.keys(y),b=Object.values(y);spendingCategoriesChartInst&&spendingCategoriesChartInst.destroy(),spendingCategoriesChartInst=safeCreateChart(document.getElementById("spendingCategoriesChart"),{type:"doughnut",data:{labels:h,datasets:[{data:b,backgroundColor:["#f44e24","#01a4ef","#81b900","#e53935","#999999"]}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:"#b0b0b0"}}}}},"Spending Categories");const f=g,v=f.map(e=>{const t=new Date(e);if(isNaN(t.getTime()))return 0;const n=new Date(t.getFullYear(),t.getMonth(),1),a=new Date(t.getFullYear(),t.getMonth()+1,0);let s=0;(d||[]).forEach(e=>{if(!e.nextDueDate||!e.frequency)return;const t=parseFloat(e.amount||0);let o=new Date(e.nextDueDate+"T00:00:00"),r=0;for(;o<n&&r<1e3;)o=getNextDate(o,e.frequency),r++;for(r=0;o<=a&&r<100;)s+=t,o=getNextDate(o,e.frequency),r++});let o=0;[...i||[],...(l||[]).map(e=>({...e,amount:e.monthlyPayment,frequency:"monthly",nextDueDate:e.nextDueDate}))].forEach(e=>{if(!e.nextDueDate||!e.frequency)return;let t=e.amount;if(e.id&&"debt"!==e.type){const n=getShareInfoForBill(e.id);n&&"accepted"===n.status&&(t=n.owner_amount)}t=parseFloat(t||0);let s=new Date(e.nextDueDate+"T00:00:00"),r=0;for(;s<n&&r<1e3;)s=getNextDate(s,e.frequency),r++;for(r=0;s<=a&&r<100;)o+=t,s=getNextDate(s,e.frequency),r++});const r=s>0?(s-o)/s*100:0;return isNaN(r)||!isFinite(r)?0:Math.round(r)});savingsRateChartInst&&savingsRateChartInst.destroy(),savingsRateChartInst=safeCreateChart(document.getElementById("savingsRateChart"),{type:"line",data:{labels:f,datasets:[{label:"Savings Rate %",data:v,fill:!0,borderColor:"#81b900",backgroundColor:"rgba(129, 185, 0, 0.15)",tension:.4}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:"#b0b0b0"}}},scales:{y:{ticks:{color:"#b0b0b0"},grid:{color:"rgba(240,240,240,0.08)"}},x:{ticks:{color:"#b0b0b0"},grid:{display:!1}}}}},"Savings Rate");const w=new Date,B=[];for(let e=0;e<5;e++){const t=new Date(w.getFullYear(),w.getMonth()+e,1);B.push(t.toLocaleString("default",{month:"short"}))}const C=c.reduce((e,t)=>e+parseFloat(t.value||0),0),I=(C>0?c.reduce((e,t)=>e+parseFloat(t.value||0)*parseFloat(t.annualReturn||0),0)/C:0)/100/12,_=c.reduce((e,t)=>e+parseFloat(t.monthlyContribution||0),0),x=[C];for(let e=1;e<5;e++){const t=x[e-1];x.push(Math.round(t*(1+I)+_))}investmentGrowthChartInst&&investmentGrowthChartInst.destroy(),investmentGrowthChartInst=safeCreateChart(document.getElementById("investmentGrowthChart"),{type:"line",data:{labels:B,datasets:[{label:"Projected Value ($)",data:x,fill:!0,borderColor:"#f44e24",backgroundColor:"rgba(244, 78, 36, 0.15)",tension:.3}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:"#b0b0b0"}}},scales:{y:{ticks:{color:"#b0b0b0"},grid:{color:"rgba(240,240,240,0.08)"}},x:{ticks:{color:"#b0b0b0"},grid:{display:!1}}}}},"Investment Growth")}let _budgetRenderLock=!1,_budgetRenderQueued=!1;async function loadAndRenderBudget(){if(document.getElementById("budgetAssignmentTable"))if(_budgetRenderLock)_budgetRenderQueued||(_budgetRenderQueued=!0,setTimeout(()=>{_budgetRenderQueued=!1,loadAndRenderBudget()},600));else{_budgetRenderLock=!0;try{const e=Date.now();for(;(!window.bills||!window.debts)&&Date.now()-e<1e4;)await new Promise(e=>setTimeout(e,50));if(!window.bills||!window.debts){const e=document.getElementById("budgetAssignmentTable"),t=document.createElement("tr"),n=document.createElement("td");return n.colSpan=7,n.className="text-center text-danger",n.textContent="Could not load bill and debt data. Please try refreshing the page.",t.appendChild(n),void e.replaceChildren(t)}const t=`${currentBudgetMonth.getFullYear()}-${(currentBudgetMonth.getMonth()+1).toString().padStart(2,"0")}`;document.getElementById("currentMonth")&&(document.getElementById("currentMonth").textContent=currentBudgetMonth.toLocaleString("default",{month:"long",year:"numeric"}));let n={},a=[];if(currentUser){const{data:e,error:s}=await sb.from("budgets").select("*").eq("user_id",currentUser.id).eq("month",t);s||(a=e||[],a.forEach(e=>{e.suppressed||(n[e.item_id]=e.assigned_amount)}))}const s=new Set(a.filter(e=>e.suppressed).map(e=>e.item_id)),o=(window.income||[]).reduce((e,t)=>e+normalizeToMonthly(t.amount,t.frequency),0),r=Object.values(n).reduce((e,t)=>e+getRaw(t),0),i=o-r;if(document.getElementById("expectedIncome")){const e=document.getElementById("expectedIncome");e.textContent=formatCurrency(o),e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}if(document.getElementById("assignedAmount")){const e=document.getElementById("assignedAmount");e.textContent=formatCurrency(r),e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}if(document.getElementById("remainingToBudget")){const e=document.getElementById("remainingToBudget");e.textContent=formatCurrency(i),e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}if(document.getElementById("activityAmount")){const e=document.getElementById("activityAmount");if(e.classList.contains("d-none")){e.textContent="$0.00",e.classList.remove("d-none");const t=e.closest(".summary-card");t&&t.classList.remove("loading")}}const l=document.querySelector(".table-card");let d=document.getElementById("incomeWarningBanner");if(0===o){if(!d&&l){d=document.createElement("div"),d.id="incomeWarningBanner",d.className="alert alert-warning mb-3";const e=document.createElement("i");e.className="bi bi-exclamation-triangle-fill me-2";const t=document.createTextNode("​​ No income sources found for this month. "),n=document.createElement("a");n.href="income.html",n.className="alert-link",n.textContent="Add income on the Income page";const a=document.createTextNode(" to track your budget accurately.");d.appendChild(e),d.appendChild(t),d.appendChild(n),d.appendChild(a),l.parentNode.insertBefore(d,l)}}else d&&d.remove();const c=document.getElementById("budgetAssignmentTable");c.textContent="";let u=[];if(currentUser){const{data:e,error:t}=await sb.from("bill_shares").select("\n        *,\n        bill:bills!bill_shares_bill_id_fkey(*)\n      ").eq("shared_with_id",currentUser.id).eq("status","accepted");!t&&e&&(u=e.map(e=>({...e.bill,amount:e.shared_amount||.5*e.bill.amount,id:e.bill.id,isShared:!0,shareId:e.id,name:e.bill.name,type:e.bill.type,frequency:e.bill.frequency,status:e.bill.status,is_variable:e.bill.is_variable})))}const m=window.bills&&window.bills.length>0||window.debts&&window.debts.length>0||window.income&&window.income.length>0||u.length>0||a.length>0;"function"==typeof toggleEmptyState&&toggleEmptyState("dataContainer","budget",m);const g=[...window.bills||[],...u,...window.debts||[]],p=new Set,y=g.filter(e=>{if(!e||!e.id)return!1;if(p.has(e.id))return!1;p.add(e.id);const t=(e.status||"").toLowerCase();if("paid_off"===t||"cancelled"===t)return!1;const n=getBillFinancingInfo(e);return!n.isFinancing||"paid_off"!==n.status}),h=new Set(y.map(e=>e.id).filter(Boolean)),b=new Set;y.forEach(e=>{if(!e.id)return void debugLog("Skipping an invalid budget item without an ID:",e);if(b.has(e.id))return;if(b.add(e.id),s.has(e.id))return;const a=e.id,o=e.amount||e.monthlyPayment||0,r=n[a]||0,i=o-r,l=o>0?r/o*100:r>0?100:0;let d="bg-dashboard-green";l>100?d="bg-dashboard-red":l<100&&(d="bg-dashboard-yellow");const u=i<=0?"text-dashboard-green":"text-dashboard-yellow",m=document.createElement("tr");m.innerHTML=`\n          <td>${escapeHtml(e.name||"Unnamed")}</td><td>${escapeHtml(toTitleCase(e.type)||"N/A")}</td><td>${formatCurrency(o)}</td>\n          <td><div class="input-group input-group-sm"><span class="input-group-text">$</span><input type="number" class="form-control assigned-input" value="${escapeAttribute(r.toFixed(2))}" data-item-id="${escapeAttribute(e.id)}" step="0.01"></div></td>\n          <td class="${u} fw-bold">${formatCurrency(i)}</td>\n          <td><div class="progress" style="height: 20px;"><div class="progress-bar ${d}" style="width: ${escapeAttribute(String(Math.min(l,100)))}%">${escapeHtml(Math.round(l))}%</div></div></td>\n          <td><button class="btn btn-sm btn-outline-danger" onclick="deleteBudgetItem('${escapeAttribute(e.id)}', '${escapeAttribute(t)}')" aria-label="Remove ${escapeAttribute(e.name)} from budget"><i class="bi bi-trash"></i></button></td>\n      `,c.appendChild(m)}),a.filter(e=>e.item_id&&!h.has(e.item_id)&&"custom"===e.item_type&&!e.suppressed).forEach(e=>{if(b.has(e.item_id))return;b.add(e.item_id);const n=getRaw(e.needed_amount)||0,a=getRaw(e.assigned_amount)||0,s=n-a,o=n>0?a/n*100:a>0?100:0;let r="bg-dashboard-green";o>100?r="bg-dashboard-red":o<100&&(r="bg-dashboard-yellow");const i=s<=0?"text-dashboard-green":"text-dashboard-yellow",l=document.createElement("tr");l.innerHTML=`\n          <td>${escapeHtml(e.name||"Unnamed")}</td><td>${escapeHtml(toTitleCase(e.category)||"Custom")}</td><td>${formatCurrency(n)}</td>\n          <td><div class="input-group input-group-sm"><span class="input-group-text">$</span><input type="number" class="form-control assigned-input" value="${escapeAttribute(a.toFixed(2))}" data-item-id="${escapeAttribute(e.item_id)}" data-item-type="custom" step="0.01"></div></td>\n          <td class="${i} fw-bold">${formatCurrency(s)}</td>\n          <td><div class="progress" style="height: 20px;"><div class="progress-bar ${r}" style="width: ${escapeAttribute(String(Math.min(o,100)))}%">${escapeHtml(Math.round(o))}%</div></div></td>\n          <td><button class="btn btn-sm btn-outline-danger" onclick="deleteBudgetItem('${escapeAttribute(e.item_id)}', '${escapeAttribute(t)}')" aria-label="Remove ${escapeAttribute(e.item_name)} from budget"><i class="bi bi-trash"></i></button></td>\n      `,c.appendChild(l)});const f=a.filter(e=>e.suppressed);if(f.length>0){const e=document.createElement("tr");e.innerHTML='<td colspan="7" class="text-muted text-center small py-2" style="opacity: 0.6;"><i class="bi bi-eye-slash me-1"></i>Removed items (click restore to re-add)</td>',c.appendChild(e),f.forEach(e=>{const n=getRaw(e.needed_amount)||0,a=document.createElement("tr");a.style.opacity="0.45",a.innerHTML=`\n          <td><s>${escapeHtml(e.name||"Unnamed")}</s></td>\n          <td>${escapeHtml(toTitleCase(e.category)||"N/A")}</td>\n          <td class="text-muted">${formatCurrency(n)}</td>\n          <td class="text-muted">�</td>\n          <td class="text-muted">�</td>\n          <td class="text-muted small">Removed</td>\n          <td><button class="btn btn-sm btn-outline-success" onclick="restoreBudgetItem('${escapeAttribute(e.item_id)}', '${escapeAttribute(t)}')" aria-label="Restore ${escapeAttribute(e.item_name)} to budget"><i class="bi bi-arrow-counterclockwise"></i></button></td>\n      `,c.appendChild(a)})}if(0===c.children.length){const e=document.createElement("tr");e.innerHTML='<td colspan="7" class="text-center text-muted py-4">\n      <i class="bi bi-journal-text" style="font-size: 1.5rem;"></i><br>\n      No budget items yet.<br>\n      <small>Add bills on the <a href="bills.html">Bills page</a> or click <strong>Generate Budget</strong> to get started.</small>\n    </td>',c.appendChild(e)}"function"==typeof renderBudgetVsActuals&&renderBudgetVsActuals("bvaCardBody",t),document.querySelectorAll(".assigned-input").forEach(e=>{e.addEventListener("change",async e=>{const t=e.target.getAttribute("data-item-id"),n=getRaw(e.target.value);if(!currentUser||!t)return;let a;if("custom"===e.target.getAttribute("data-item-type"))a="custom";else{const e=window.bills?.some(e=>e.id===t);a=e?"bill":"debt"}await saveBudgetAssignment(t,n,a);const s=(window.income||[]).reduce((e,t)=>e+normalizeToMonthly(t.amount,t.frequency),0),o=Array.from(document.querySelectorAll(".assigned-input")).reduce((e,t)=>e+getRaw(t.value),0),r=s-o;document.getElementById("assignedAmount")&&(document.getElementById("assignedAmount").textContent=formatCurrency(o)),document.getElementById("remainingToBudget")&&(document.getElementById("remainingToBudget").textContent=formatCurrency(r));const i=e.target.closest("tr"),l=getRaw(i.cells[2].textContent),d=i.cells[4],c=i.querySelector(".progress-bar"),u=l-n,m=l>0?n/l*100:n>0?100:0;d.textContent=formatCurrency(u);let g="bg-dashboard-green";m>100?g="bg-dashboard-red":m<100&&(g="bg-dashboard-yellow"),c.className=`progress-bar ${g}`,c.style.width=`${Math.min(m,100)}%`,c.textContent=`${Math.round(m)}%`;const p=u<=0?"text-dashboard-green":"text-dashboard-yellow";d.className=`fw-bold ${p}`})})}finally{_budgetRenderLock=!1}}}async function saveBudgetAssignment(e,t,n){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}if(!currentUser||!e||!n)return;const a=`${currentBudgetMonth.getFullYear()}-${(currentBudgetMonth.getMonth()+1).toString().padStart(2,"0")}`,s={user_id:currentUser.id,item_id:e,item_type:n,month:a,assigned_amount:t},{error:o}=await sb.from("budgets").upsert(s,{onConflict:"user_id,month,item_id"});o?alert("Could not save the change."):(clearCache(),await fetchAllDataFromSupabase(!0),renderAll())}async function saveBudgetItem(){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}if(!currentUser)return;const e=`${currentBudgetMonth.getFullYear()}-${(currentBudgetMonth.getMonth()+1).toString().padStart(2,"0")}`,t=crypto.randomUUID?crypto.randomUUID():"custom-"+Date.now()+"-"+Math.random().toString(36).substr(2,9),n=getRaw(document.getElementById("budgetItemNeeded").value),a={user_id:currentUser.id,month:e,item_id:t,item_type:"saving",name:document.getElementById("budgetItemName").value,category:document.getElementById("budgetItemCategory").value,needed_amount:n,assigned_amount:n},{error:s}=await sb.from("budgets").insert(a);s?alert("Error saving item: "+s.message):(bootstrap.Modal.getInstance(document.getElementById("addBudgetItemModal")).hide(),document.getElementById("budgetItemForm").reset(),clearCache(),await fetchAllDataFromSupabase(!0),renderAll())}async function deleteBudgetItem(e,t){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}currentUser&&e&&showConfirmModal("Remove Budget Item","Remove this item from the budget for this month?",()=>_deleteBudgetItemConfirmed(e,t),{confirmText:"Remove",confirmClass:"btn-danger"})}async function _deleteBudgetItemConfirmed(e,t){if(!currentUser||!e)return;const{data:n}=await sb.from("budgets").select("id, item_type").eq("user_id",currentUser.id).eq("month",t).eq("item_id",e).maybeSingle();if(n&&"custom"===n.item_type){const{error:n}=await sb.from("budgets").delete().eq("user_id",currentUser.id).eq("month",t).eq("item_id",e);if(n)return void alert("Could not delete the budget item: "+n.message)}else if(n){const{error:n}=await sb.from("budgets").update({suppressed:!0,assigned_amount:0}).eq("user_id",currentUser.id).eq("month",t).eq("item_id",e);if(n)return void alert("Could not remove the budget item: "+n.message)}else{const n=(window.bills||[]).some(t=>t.id===e),a=n?(window.bills||[]).find(t=>t.id===e):(window.debts||[]).find(t=>t.id===e),{error:s}=await sb.from("budgets").insert({user_id:currentUser.id,month:t,item_id:e,item_type:n?"bill":"debt",assigned_amount:0,needed_amount:getRaw(a?.amount||a?.monthlyPayment||0),name:a?.name||"Unknown",category:a?.type||"N/A",suppressed:!0});if(s)return void alert("Could not remove the budget item: "+s.message)}clearCache(),await fetchAllDataFromSupabase(!0),loadAndRenderBudget()}async function restoreBudgetItem(e,t){if(!currentUser||!e)return;const{data:n}=await sb.from("budgets").select("needed_amount").eq("user_id",currentUser.id).eq("month",t).eq("item_id",e).maybeSingle(),{error:a}=await sb.from("budgets").update({suppressed:!1,assigned_amount:getRaw(n?.needed_amount||0)}).eq("user_id",currentUser.id).eq("month",t).eq("item_id",e);a?alert("Could not restore the budget item: "+a.message):(clearCache(),await fetchAllDataFromSupabase(!0),loadAndRenderBudget())}async function generateBudgetForMonth(e){if(!currentUser)return void alert("Please log in first.");const t=document.getElementById("generateBudgetStatus");t&&(t.textContent="Generating...",t.className="ms-2 text-info small");try{const{data:n,error:a}=await sb.from("bills").select("*").eq("user_id",currentUser.id);if(a)throw a;const{data:s,error:o}=await sb.from("bill_shares").select("\n        *,\n        bill:bills!bill_shares_bill_id_fkey(*)\n      ").eq("shared_with_id",currentUser.id).eq("status","accepted");if(o)throw o;const r=[...n||[],...(s||[]).map(e=>({...e.bill,amount:e.shared_amount||.5*e.bill.amount,id:e.bill.id,isShared:!0,shareId:e.id,name:e.bill.name,type:e.bill.type,frequency:e.bill.frequency,status:e.bill.status,is_variable:e.bill.is_variable}))],{data:i,error:l}=await sb.from("budgets").select("*").eq("user_id",currentUser.id).eq("month",e);if(l)throw l;const d=new Set((i||[]).map(e=>e.item_id)),[c,u]=e.split("-").map(Number),m=new Date(c,u-2,1),g=`${m.getFullYear()}-${(m.getMonth()+1).toString().padStart(2,"0")}`,{data:p}=await sb.from("budgets").select("*").eq("user_id",currentUser.id).eq("month",g),y={};(p||[]).forEach(e=>{y[e.item_id]=e.assigned_amount});const h=["electric","water","sewage","peoples gas","west penn power","american water"],b=[];for(const t of r||[]){const n=(t.status||"").toLowerCase();if("paid_off"===n||"cancelled"===n)continue;const a=getBillFinancingInfo(t);if(!(a.isFinancing&&"paid_off"===a.status||d.has(t.id))){const n=t.is_variable||h.includes((t.name||"").toLowerCase());let a=getRaw(t.amount);n&&y[t.id]&&(a=getRaw(y[t.id])),b.push({user_id:currentUser.id,month:e,item_id:t.id,item_type:"bill",assigned_amount:a,needed_amount:a,name:t.name,category:t.type})}}const{data:f}=await sb.from("debts").select("*").eq("user_id",currentUser.id);for(const t of f||[])d.has(t.id)||b.push({user_id:currentUser.id,month:e,item_id:t.id,item_type:"debt",assigned_amount:getRaw(t.monthlyPayment),needed_amount:getRaw(t.monthlyPayment),name:t.name,category:t.type});if(0===b.length)return t&&(t.textContent="Budget already up to date!",t.className="ms-2 text-success small"),void setTimeout(()=>{t&&(t.textContent="")},3e3);const{error:v}=await sb.from("budgets").insert(b);if(v)throw v;t&&(t.textContent=`? Generated ${b.length} budget entries!`,t.className="ms-2 text-success small"),setTimeout(()=>{t&&(t.textContent="")},3e3),clearCache(),await fetchAllDataFromSupabase(!0),loadAndRenderBudget()}catch(e){t&&(t.textContent="Error: "+(e.message||"Could not generate budget"),t.className="ms-2 text-danger small")}}function initializeBudgetPage(){document.getElementById("budgetAssignmentTable")&&(document.getElementById("prevMonth")?.addEventListener("click",()=>{currentBudgetMonth.setMonth(currentBudgetMonth.getMonth()-1),loadAndRenderBudget()}),document.getElementById("nextMonth")?.addEventListener("click",()=>{currentBudgetMonth.setMonth(currentBudgetMonth.getMonth()+1),loadAndRenderBudget()}),document.getElementById("generateBudgetBtn")?.addEventListener("click",()=>{generateBudgetForMonth(`${currentBudgetMonth.getFullYear()}-${(currentBudgetMonth.getMonth()+1).toString().padStart(2,"0")}`)}))}async function calculateAndDisplayTrends(e){const t=window.snapshots||[],n=new Date,a=new Date(n);a.setDate(n.getDate()-30);const s=new Date(n);s.setDate(n.getDate()-60);const o=t.filter(e=>{const t=new Date(e.date+"T00:00:00");return t>=s&&t<a}),r=o.length>0?o.sort((e,t)=>new Date(t.date)-new Date(e.date))[0]:null;function i(e,t,n=!1){if(null==t||0===t||isNaN(t))return'<span class="trend-indicator" style="color: var(--color-text-tertiary);">—</span>';const a=e-t,s=a/t*100;return isFinite(s)?`\n      <span class="trend-indicator" style="color: ${(n?a<0:a>0)?"var(--color-success)":"#dc2626"};">\n        <span style="font-size: 1.2em;">${a>0?"↑":"↓"}</span>\n        <span>${a>0?"+":""}${formatCurrency(Math.abs(a))} (${Math.abs(s).toFixed(1)}%)</span>\n      </span>\n      <div class="trend-label" style="font-size: 12px; color: var(--color-text-tertiary); margin-top: 4px;">\n        vs last month\n      </div>\n    `:'<span class="trend-indicator" style="color: var(--color-text-tertiary);">—</span>'}const l=e=>document.getElementById(e);if(r){l("netWorthTrend")&&(l("netWorthTrend").innerHTML=i(e.netWorth,getRaw(r.netWorth),!1),l("netWorthTrend").classList.remove("d-none"));const t=l("assetsTrend");t&&(t.innerHTML=i(e.totalAssets,getRaw(r.totalAssets),!1),t.classList.remove("d-none"));const n=l("investmentsTrend");n&&(n.innerHTML=i(e.totalInvestments,getRaw(r.totalInvestments),!1),n.classList.remove("d-none"));const a=l("debtsTrend");a&&(a.innerHTML=i(e.totalDebts,getRaw(r.totalDebts),!0),a.classList.remove("d-none"))}else["netWorthTrend","assetsTrend","investmentsTrend","debtsTrend","billsTrend","incomeTrend"].forEach(e=>{const t=l(e);t&&(t.innerHTML='<span class="trend-indicator" style="color: var(--color-text-tertiary);">—</span>',t.classList.remove("d-none"))})}async function updateDashboardCards(){if(!currentUser)return;const e=window.assets&&window.assets.length>0||window.investments&&window.investments.length>0||window.debts&&window.debts.length>0||window.bills&&window.bills.length>0||window.sharedBillsForDisplay&&window.sharedBillsForDisplay.length>0||window.income&&window.income.length>0;"function"==typeof toggleEmptyState&&toggleEmptyState("dataContainer","dashboard",e);try{const e=window.assets||[],t=window.investments||[],n=window.debts||[],a=[...window.bills||[],...window.sharedBillsForDisplay||[]],s=window.income||[],o=e.reduce((e,t)=>e+(getRaw(t.value)||0),0),r=e.reduce((e,t)=>e+(getRaw(t.loan)||0),0),i=t.reduce((e,t)=>e+(getRaw(t.value)||0),0),l=n.reduce((e,t)=>e+(getRaw(t.amount)||0),0),d=o+i-(l+r),c=a.reduce((e,t)=>{const n=getBillFinancingInfo(t);if(n.isFinancing&&"paid_off"===n.status)return e;if(t.isSharedWithMe)return e+normalizeToMonthly(getRaw(t.amount)||0,t.frequency);const a=getShareInfoForBill(t.id),s=getRaw(a&&"accepted"===a.status?a.owner_amount:t.amount)||0;let o=s;switch((t.frequency||"").toLowerCase()){case"daily":o=30*s;break;case"weekly":o=52*s/12;break;case"bi-weekly":case"biweekly":o=26*s/12;break;case"twice monthly":case"semi-monthly":o=2*s;break;case"monthly":default:o=s;break;case"quarterly":o=s/3;break;case"semi-annually":o=s/6;break;case"annually":case"annual":o=s/12}return e+o},0),u=s.reduce((e,t)=>e+normalizeToMonthly(getRaw(t.amount)||0,t.frequency),0),m=e=>document.getElementById(e);if(m("netWorthValue")){m("netWorthValue").textContent=formatCurrency(d),m("netWorthValue").classList.remove("d-none");const e=m("netWorthValue").closest(".stat-card");e&&e.classList.remove("loading")}if(m("totalAssetsValue")){m("totalAssetsValue").textContent=formatCurrency(o),m("totalAssetsValue").classList.remove("d-none");const e=m("totalAssetsValue").closest(".stat-card");e&&e.classList.remove("loading")}if(m("monthlyBillsValue")){m("monthlyBillsValue").textContent=formatCurrency(c),m("monthlyBillsValue").classList.remove("d-none");const e=m("monthlyBillsValue").closest(".stat-card");e&&e.classList.remove("loading")}if(m("totalDebtsValue")){m("totalDebtsValue").textContent=formatCurrency(l),m("totalDebtsValue").classList.remove("d-none");const e=m("totalDebtsValue").closest(".stat-card");e&&e.classList.remove("loading")}if(m("totalInvestmentsValue")){m("totalInvestmentsValue").textContent=formatCurrency(i),m("totalInvestmentsValue").classList.remove("d-none");const e=m("totalInvestmentsValue").closest(".stat-card");e&&e.classList.remove("loading")}if(m("monthlyIncomeValue")){m("monthlyIncomeValue").textContent=formatCurrency(u),m("monthlyIncomeValue").classList.remove("d-none");const e=m("monthlyIncomeValue").closest(".stat-card");e&&e.classList.remove("loading")}if(m("assetCount")&&(m("assetCount").textContent=`${e.length} asset${1!==e.length?"s":""}`,m("assetCount").classList.remove("d-none")),m("billCount")){const e=a.filter(e=>{const t=getBillFinancingInfo(e);return!(t.isFinancing&&"paid_off"===t.status)});m("billCount").textContent=`${e.length} bill${1!==e.length?"s":""}`,m("billCount").classList.remove("d-none")}m("debtCount")&&(m("debtCount").textContent=`${n.length} debt${1!==n.length?"s":""}`,m("debtCount").classList.remove("d-none")),m("investmentCount")&&(m("investmentCount").textContent=`${t.length} investment${1!==t.length?"s":""}`,m("investmentCount").classList.remove("d-none")),m("incomeCount")&&(m("incomeCount").textContent=`${s.length} source${1!==s.length?"s":""}`,m("incomeCount").classList.remove("d-none")),await calculateAndDisplayTrends({netWorth:d,totalAssets:o,totalInvestments:i,totalDebts:l,monthlyBills:c,monthlyIncome:u});const g=(new Date).toISOString().split("T")[0],{error:p}=await sb.from("snapshots").upsert({date:g,netWorth:d,totalAssets:o,totalInvestments:i,totalDebts:l,monthlyBills:c,monthlyIncome:u,user_id:currentUser.id},{onConflict:"date,user_id"})}catch(e){}}function renderUpcomingPayments(){const e=document.getElementById("upcomingPaymentsList");if(!e)return;const t=new Date;t.setHours(0,0,0,0);const n=new Date(t.getTime()+6048e5),a=[...(window.debts||[]).map(e=>({...e,amount:e.monthlyPayment,category:"Debt"})),...window.bills||[],...window.sharedBillsForDisplay||[]].filter(e=>{if(!e.nextDueDate)return!1;const a=new Date(e.nextDueDate+"T00:00:00");return a>=t&&a<=n}).sort((e,t)=>new Date(e.nextDueDate)-new Date(t.nextDueDate));0!==a.length?e.innerHTML=a.map(e=>{let t=e.amount;if(e.isSharedWithMe)t=e.amount;else if("Debt"!==e.category&&e.id){const n=getShareInfoForBill(e.id);n&&"accepted"===n.status&&(t=n.owner_amount)}const n=e.isSharedWithMe?`<small class="d-block text-muted">from ${escapeHtml(e.sharedByName)}</small>`:"";return`<div class="d-flex justify-content-between border-bottom py-2"><div><strong>${escapeHtml(e.name)}</strong><span class="badge ${getCategoryBadgeClass(e.type)} rounded-pill ms-2">${escapeHtml(e.type||e.category||"Bill")}</span>${n}</div><div class="text-end"><div class="text-danger fw-bold">-${formatCurrency(t)}</div><small class="text-muted">${formatDate(e.nextDueDate)}</small></div></div>`}).join(""):"function"==typeof generateEmptyStateHTML?e.innerHTML=generateEmptyStateHTML("upcomingPayments"):e.innerHTML='<p class="text-muted fst-italic">No upcoming payments this week.</p>'}async function renderNetWorthChart(){const e=document.getElementById("netWorthTimelineChart");if(!e)return;netWorthChart&&netWorthChart.destroy();const t=dedupeSnapshotsByDate(window.snapshots||[]),n=getThemeColors();netWorthChart=await safeCreateChart(e,{type:"line",data:{labels:t.map(e=>e.date),datasets:[{label:"Net Worth",data:t.map(e=>getRaw(e.netWorth)),borderColor:"#f44e24",backgroundColor:n.fill,tension:.3,fill:!0}]},options:{responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,scales:{y:{ticks:{callback:e=>formatCurrency(e),color:n.text},grid:{color:n.grid}},x:{ticks:{color:n.text},grid:{display:!1}}},plugins:{legend:{display:!1}}}},"Net Worth Timeline")}async function generateMonthlyCashFlowChart(){const e=document.getElementById("cashFlowChart");if(!e)return;cashFlowChart&&cashFlowChart.destroy();const t=getThemeColors(),n=[],a=[],s=[],o=new Date;for(let e=0;e<6;e++){const t=new Date(o.getFullYear(),o.getMonth()+e,1),r=new Date(o.getFullYear(),o.getMonth()+e+1,0);n.push(t.toLocaleString("default",{month:"short"}));let i=0,l=0;const d=[...window.bills||[],...window.sharedBillsForDisplay||[]].filter(e=>{const t=(e.status||"").toLowerCase();if("paid_off"===t||"cancelled"===t)return!1;const n=getBillFinancingInfo(e);return!n.isFinancing||"paid_off"!==n.status});[...window.income||[],...d,...(window.debts||[]).map(e=>({...e,amount:e.monthlyPayment,frequency:"monthly"}))].forEach(e=>{if(!e.nextDueDate||!e.frequency)return;const n="string"==typeof e.type&&("w2"===e.type.toLowerCase()||"1099"===e.type.toLowerCase());let a=e.amount;if(e.isSharedWithMe);else if(!n&&e.id){const t=getShareInfoForBill(e.id);t&&"accepted"===t.status&&(a=t.owner_amount)}a=getRaw(a);let s=new Date(e.nextDueDate+"T00:00:00"),d=0;for(;s<t&&s.getFullYear()<o.getFullYear()+2&&d<1e3;){try{s=getNextDate(s,e.frequency)}catch{break}d++}for(d=0;s<=r&&d<100;){n?i+=a:l+=a;try{s=getNextDate(s,e.frequency)}catch{break}d++}}),a.push(i),s.push(l)}cashFlowChart=await safeCreateChart(e,{type:"bar",data:{labels:n,datasets:[{label:"Income",data:a,backgroundColor:"#81b900"},{label:"Expenses",data:s,backgroundColor:"#e53935"}]},options:{responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,scales:{x:{stacked:!0,ticks:{color:t.text},grid:{display:!1}},y:{stacked:!0,ticks:{color:t.text},grid:{color:t.grid}}},plugins:{legend:{labels:{color:t.text}}}}},"Cash Flow")}function initializeAssetForm(){const e=document.getElementById("assetType");e&&e.addEventListener("change",function(){const e=this.value;document.querySelectorAll(".asset-fields").forEach(e=>e.classList.add("d-none")),"real-estate"===e?document.querySelector(".real-estate-fields").classList.remove("d-none"):"vehicle"===e&&document.querySelector(".vehicle-fields").classList.remove("d-none")})}function init(){debugLog("INIT: Page loaded, starting initialization."),sessionSecurity=new SessionSecurityManager(sb,e=>{}),sb.auth.onAuthStateChange((e,t)=>{if(debugLog(`AUTH: Event received: ${e}`),currentUser=t?.user||null,"PASSWORD_RECOVERY"===e){const e=document.getElementById("resetPasswordModal");e&&bootstrap.Modal.getOrCreateInstance(e).show()}if(document.getElementById("loggedInState")?.classList.toggle("d-none",!currentUser),document.getElementById("loggedOutState")?.classList.toggle("d-none",!!currentUser),document.body.classList.add("auth-resolved"),document.getElementById("dataContainer")&&(document.getElementById("dataContainer").style.visibility=currentUser?"visible":"hidden",toggleLoggedOutCTA(!currentUser)),document.getElementById("pageActions")){const e=document.getElementById("pageActions");currentUser?e.classList.remove("initially-hidden"):e.style.display="none"}if(document.querySelectorAll(".auth-required").forEach(e=>{e.style.display=currentUser?"":"none"}),currentUser){const t=currentUser.user_metadata?.first_name?.trim()||currentUser.email;document.getElementById("username").textContent=t,"SIGNED_IN"===e&&sessionSecurity&&sessionSecurity.onLogin(),ensureUserProfile(),fetchAllDataFromSupabase().then(()=>{renderAll(),renderAdditionalCharts(),initNotifications(),loadSharedBillsData(),loadFriendsPage(),checkOnboardingStatus()})}else"SIGNED_OUT"===e&&sessionSecurity&&sessionSecurity.onLogout(),notificationChannel&&(sb.removeChannel(notificationChannel),notificationChannel=null),renderAll()}),sb.auth.getSession().then(({data:{session:e}})=>{debugLog("INIT: Initial session check complete")}),document.body.addEventListener("click",e=>{e.target.closest("#logoutButton")&&(e.preventDefault(),logout())}),document.getElementById("loginForm")?.addEventListener("submit",e=>{e.preventDefault(),login(e.target.loginEmail.value,e.target.loginPassword.value)}),document.getElementById("signupForm")?.addEventListener("submit",e=>{e.preventDefault(),signUp(e.target.signupEmail.value,e.target.signupPassword.value,e.target.signupFirstName.value,e.target.signupLastName.value)}),document.getElementById("forgotPasswordLink")?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("loginForm")?.classList.add("d-none"),document.getElementById("forgotPasswordForm")?.classList.remove("d-none");const t=document.getElementById("loginEmail")?.value;t&&(document.getElementById("forgotEmail").value=t)}),document.getElementById("backToLoginLink")?.addEventListener("click",e=>{e.preventDefault(),document.getElementById("loginForm")?.classList.remove("d-none"),document.getElementById("forgotPasswordForm")?.classList.add("d-none"),hideAuthAlert("forgotAlert")}),document.getElementById("forgotPasswordBtn")?.addEventListener("click",()=>{forgotPassword(document.getElementById("forgotEmail")?.value)}),document.getElementById("resetPasswordForm")?.addEventListener("submit",e=>{e.preventDefault();const t=document.getElementById("newPassword")?.value,n=document.getElementById("confirmNewPassword")?.value;t===n?t.length<6?showAuthAlert("resetPasswordAlert","Password must be at least 6 characters.","warning"):updatePassword(t):showAuthAlert("resetPasswordAlert","Passwords do not match.","warning")}),document.getElementById("loginModal")?.addEventListener("show.bs.modal",()=>{document.getElementById("loginForm")?.classList.remove("d-none"),document.getElementById("forgotPasswordForm")?.classList.add("d-none"),hideAuthAlert("loginAlert"),hideAuthAlert("forgotAlert")}),document.getElementById("signupModal")?.addEventListener("show.bs.modal",()=>{hideAuthAlert("signupAlert")}),document.getElementById("saveAssetBtn")?.addEventListener("click",e=>{e.preventDefault(),saveAsset()}),document.getElementById("saveInvestmentBtn")?.addEventListener("click",e=>{e.preventDefault(),saveInvestment()}),document.getElementById("saveDebtBtn")?.addEventListener("click",e=>{e.preventDefault(),saveDebt()}),document.getElementById("saveBillBtn")?.addEventListener("click",e=>{e.preventDefault(),saveBill()}),document.getElementById("saveIncomeBtn")?.addEventListener("click",e=>{e.preventDefault(),saveIncome()}),document.getElementById("saveBudgetItemBtn")?.addEventListener("click",e=>{e.preventDefault(),saveBudgetItem()}),document.getElementById("saveBudgetsBtn")?.addEventListener("click",async e=>{e.preventDefault(),await saveSettings(),await saveCategoryBudgets()}),document.getElementById("categoryBudgetsGrid")?.addEventListener("input",()=>{updateCategoryBudgetTotal()}),document.getElementById("showGoalFormBtn")?.addEventListener("click",()=>{const e=document.getElementById("settingsEmptyState"),t=document.getElementById("settingsCard"),n=document.getElementById("emergencyFundGoal");e&&t&&n&&(e.classList.add("d-none"),t.classList.remove("d-none"),document.getElementById("categoryBudgetsCard")?.classList.remove("d-none"),n.focus())}),document.getElementById("emergencyFundGoal")?.addEventListener("input",e=>{const t=e.target,n=parseFloat(t.value),a=document.getElementById("emergencyGoalFeedback");t.value?isNaN(n)?(t.classList.add("is-invalid"),t.classList.remove("is-valid"),a.textContent="Please enter a valid number"):n<100?(t.classList.add("is-invalid"),t.classList.remove("is-valid"),a.textContent="Minimum goal is $100"):n>1e6?(t.classList.add("is-invalid"),t.classList.remove("is-valid"),a.textContent="Maximum goal is $1,000,000"):(t.classList.remove("is-invalid"),t.classList.add("is-valid"),a.textContent=""):(t.classList.remove("is-invalid","is-valid"),a.textContent="")});const e=document.querySelector("button .bi-download")?.closest("button");e&&e.addEventListener("click",e=>{e.preventDefault(),exportFinancialDataCSV()}),debugLog("INIT: Initialization complete."),document.getElementById("totalInvestments")&&(updateDashboardCards(),renderUpcomingPayments(),renderNetWorthChart(),generateMonthlyCashFlowChart()),document.getElementById("budgetAssignmentTable")&&loadAndRenderBudget(),setupThemeToggle(),setupSidebarToggle(),setupNotificationScrollLock(),initializeAssetForm(),initializeBudgetPage(),initShareBillUI(),initializeTooltips(),document.getElementById("friendSearchBtn")?.addEventListener("click",()=>{const e=document.getElementById("friendSearchInput")?.value;e&&searchFriends(e)}),document.getElementById("friendSearchInput")?.addEventListener("keydown",e=>{if("Enter"===e.key){e.preventDefault();const t=e.target.value;t&&searchFriends(t)}})}function setupThemeToggle(){const e=document.getElementById("themeSwitch"),t=document.querySelector('label[for="themeSwitch"]');if(!e)return;function n(){const n=document.documentElement.getAttribute("data-bs-theme")||"dark";t&&(t.innerHTML="dark"===n?"🌙 Dark Mode":"☀️ Light Mode"),e&&(e.checked="dark"===n)}function a(e){document.body.setAttribute("data-theme",e),document.documentElement.setAttribute("data-bs-theme",e),localStorage.setItem("theme",e),n(),"function"==typeof renderNetWorthChart&&document.getElementById("netWorthTimelineChart")&&renderNetWorthChart(),"function"==typeof generateMonthlyCashFlowChart&&document.getElementById("cashFlowChart")&&generateMonthlyCashFlowChart()}const s=localStorage.getItem("theme");a(s||(window.matchMedia("(prefers-color-scheme: dark)").matches?"dark":"light")),e.addEventListener("change",function(){a(this.checked?"dark":"light")}),window.matchMedia("(prefers-color-scheme: dark)").addEventListener("change",function(e){localStorage.getItem("theme")||a(e.matches?"dark":"light")}),n()}function setupSidebarToggle(){const e=document.getElementById("sidebarToggle"),t=document.getElementById("sidebar"),n=document.getElementById("sidebarOverlay");if(!e||!t)return;const a=()=>{t.classList.remove("show"),n&&n.classList.remove("show"),e.innerHTML='<i class="bi bi-list"></i>';const a=parseInt(document.body.dataset.scrollY||"0");document.body.classList.remove("sidebar-open"),document.body.style.removeProperty("--scroll-lock-offset"),document.body.removeAttribute("data-scroll-y"),window.scrollTo(0,a)};e.addEventListener("click",()=>{t.classList.contains("show")?a():(()=>{t.classList.add("show"),n&&n.classList.add("show"),e.innerHTML='<i class="bi bi-x-lg"></i>';const a=window.scrollY;document.body.dataset.scrollY=a,document.body.style.setProperty("--scroll-lock-offset",`-${a}px`),document.body.classList.add("sidebar-open")})()}),n&&n.addEventListener("click",a),t.querySelectorAll("a[href]").forEach(e=>{e.addEventListener("click",()=>{window.innerWidth<=991&&a()})})}function setupNotificationScrollLock(){const e=document.getElementById("notificationDropdown");!e||window.innerWidth>991||(e.addEventListener("shown.bs.dropdown",()=>{document.body.style.overflow="hidden",document.body.style.position="fixed",document.body.style.width="100%",document.body.style.top=`-${window.scrollY}px`,document.body.dataset.scrollY=window.scrollY}),e.addEventListener("hidden.bs.dropdown",()=>{const e=document.body.dataset.scrollY||"0";document.body.style.overflow="",document.body.style.position="",document.body.style.width="",document.body.style.top="",window.scrollTo(0,parseInt(e))}))}async function ensureUserProfile(){if(!currentUser)return;const{data:e}=await sb.from("user_profiles").select("id").eq("id",currentUser.id).single();if(!e){const e=currentUser.email||"",t=currentUser.user_metadata?.first_name||"",n=currentUser.user_metadata?.last_name||"",a=t?`${t} ${n}`.trim():e.split("@")[0],s=e.split("@")[0].replace(/[^a-zA-Z0-9_]/g,"_").substring(0,30);await sb.from("user_profiles").upsert({id:currentUser.id,display_name:a,username:s},{onConflict:"id"})}}let notificationChannel=null;async function initNotifications(){currentUser&&(await updateNotificationBadge(),await loadNotifications(),notificationChannel&&sb.removeChannel(notificationChannel),notificationChannel=sb.channel("user-notifications").on("postgres_changes",{event:"INSERT",schema:"public",table:"notifications",filter:`user_id=eq.${currentUser.id}`},e=>{showNotificationToast(e.new),updateNotificationBadge(),loadNotifications(),document.getElementById("friendSearchInput")&&loadFriendsPage(),document.getElementById("billTableBody")&&loadSharedBillsData()}).subscribe())}async function updateNotificationBadge(){if(!currentUser)return;const e=document.getElementById("notificationBadge");if(!e)return;const{count:t}=await sb.from("notifications").select("id",{count:"exact",head:!0}).eq("user_id",currentUser.id).eq("is_read",!1),n=t||0;n>0?(e.textContent=n>99?"99+":n,e.classList.remove("d-none")):e.classList.add("d-none")}async function loadNotifications(){if(!currentUser)return;const e=document.getElementById("notificationList"),t=document.getElementById("noNotifications");if(!e)return;const{data:n}=await sb.from("notifications").select("*").eq("user_id",currentUser.id).order("created_at",{ascending:!1}).limit(20);if(e.querySelectorAll(".notification-item").forEach(e=>e.remove()),!n||0===n.length)return void(t&&t.classList.remove("d-none"));t&&t.classList.add("d-none");const a={friend_request:"bi-person-plus text-primary",friend_accepted:"bi-person-check text-success",bill_shared:"bi-share text-info",bill_share_accepted:"bi-check-circle text-success",bill_share_declined:"bi-x-circle text-danger",bill_amount_updated:"bi-arrow-repeat text-warning",bill_deleted:"bi-trash text-danger",payment_reminder:"bi-bell text-warning",connection_removed:"bi-person-dash text-danger"};n.forEach(t=>{const n=document.createElement("li");n.className="notification-item";const s=a[t.type]||"bi-bell text-muted",o=!t.is_read,r=getTimeAgo(t.created_at);n.innerHTML=`\n      <a class="dropdown-item py-2 px-3 ${o?"":"opacity-75"}" href="#" \n         data-notif-id="${escapeAttribute(t.id)}" \n         data-notif-type="${escapeAttribute(t.type)}" \n         data-notif-data="${escapeAttribute(JSON.stringify(t.data||{}))}">\n        <div class="d-flex align-items-start gap-2">\n          <i class="bi ${s} mt-1" style="font-size: 1.1rem;"></i>\n          <div class="flex-grow-1">\n            <div class="d-flex justify-content-between">\n              <strong style="font-size: 0.85rem;">${escapeHtml(t.title)}</strong>\n              ${o?'<span class="badge bg-primary" style="font-size: 0.6rem;">NEW</span>':""}\n            </div>\n            <div style="font-size: 0.8rem; color: var(--color-text-secondary);">${escapeHtml(t.body||"")}</div>\n            <small style="color: var(--color-text-tertiary);">${r}</small>\n          </div>\n        </div>\n      </a>\n    `,n.querySelector("a").addEventListener("click",function(e){e.preventDefault(),handleNotificationClick(this.dataset.notifId,this.dataset.notifType,JSON.parse(this.dataset.notifData))}),e.appendChild(n)})}function getTimeAgo(e){const t=new Date,n=new Date(e),a=Math.floor((t-n)/1e3);return a<60?"Just now":a<3600?`${Math.floor(a/60)}m ago`:a<86400?`${Math.floor(a/3600)}h ago`:a<604800?`${Math.floor(a/86400)}d ago`:n.toLocaleDateString()}async function handleNotificationClick(e,t,n){await sb.from("notifications").update({is_read:!0}).eq("id",e),await updateNotificationBadge(),"friend_request"===t||"friend_accepted"===t||"connection_removed"===t?window.location.href="friends.html":(t.startsWith("bill_share")||"bill_shared"===t||"bill_amount_updated"===t||"bill_deleted"===t)&&(window.location.href="bills.html")}async function markAllNotificationsRead(){currentUser&&(await sb.from("notifications").update({is_read:!0}).eq("user_id",currentUser.id).eq("is_read",!1),await updateNotificationBadge(),await loadNotifications())}function showNotificationToast(e){const t=document.createElement("div");t.className="position-fixed bottom-0 end-0 p-3",t.style.zIndex="9999",t.innerHTML=`\n    <div class="toast show" role="alert" style="background: var(--color-bg-2); border: 1px solid var(--color-border-subtle); border-radius: var(--radius-md);">\n      <div class="toast-header" style="background: var(--color-bg-3); border-color: var(--color-border-subtle);">\n        <i class="bi bi-bell-fill text-primary me-2"></i>\n        <strong class="me-auto" style="color: var(--color-text-primary);">${escapeHtml(e.title)}</strong>\n        <button type="button" class="btn-close" onclick="this.closest('.position-fixed').remove()"></button>\n      </div>\n      <div class="toast-body" style="color: var(--color-text-secondary);">\n        ${escapeHtml(e.body||"")}\n      </div>\n    </div>\n  `,document.body.appendChild(t),setTimeout(()=>t.remove(),5e3)}async function searchFriends(e){if(!currentUser||!e||e.length<2){const e=document.getElementById("searchResults");return void(e&&(e.textContent=""))}const{data:t}=await sb.from("user_profiles").select("id, username, display_name, avatar_url").or(`username.ilike.%${e}%,display_name.ilike.%${e}%`).neq("id",currentUser.id).limit(20);let n=[];if(e.includes("@")){const{data:t}=await sb.rpc("search_users_by_email",{search_email:e});n=t||[]}const a=[...t||[]];n.forEach(e=>{a.find(t=>t.id===e.id)||a.push(e)});const{data:s}=await sb.from("connections").select("requester_id, addressee_id, status").or(`requester_id.eq.${currentUser.id},addressee_id.eq.${currentUser.id}`),o=new Set;(s||[]).forEach(e=>{"declined"!==e.status&&o.add(e.requester_id===currentUser.id?e.addressee_id:e.requester_id)});const r=a.filter(e=>!o.has(e.id)),i=document.getElementById("searchResults");if(i){if(0===r.length){const e=document.createElement("p");return e.className="text-muted mt-2",e.textContent="No users found matching your search.",void i.replaceChildren(e)}i.innerHTML=r.map(e=>`\n    <div class="card mb-2">\n      <div class="card-body p-3 d-flex justify-content-between align-items-center">\n        <div class="d-flex align-items-center gap-3">\n          <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: var(--color-bg-3); border: 1px solid var(--color-border-subtle);">\n            ${e.avatar_url?`<img src="${escapeAttribute(e.avatar_url)}" class="rounded-circle" width="40" height="40">`:'<i class="bi bi-person" style="font-size: 1.2rem;"></i>'}\n          </div>\n          <div>\n            <strong style="color: var(--color-text-primary);">${escapeHtml(e.display_name||"Unknown")}</strong>\n            ${e.username?`<div style="font-size: 0.8rem; color: var(--color-text-tertiary);">@${escapeHtml(e.username)}</div>`:""}\n          </div>\n        </div>\n        <button class="btn btn-sm btn-primary" onclick="sendFriendRequest('${escapeAttribute(e.id)}')">\n          <i class="bi bi-person-plus me-1"></i>Add Friend\n        </button>\n      </div>\n    </div>\n  `).join("")}}async function sendFriendRequest(e){if(!currentUser)return;const{error:t}=await sb.from("connections").insert({requester_id:currentUser.id,addressee_id:e,status:"pending"});if(t)return void(t.message.includes("duplicate")||t.message.includes("unique")?alert("You already have a pending connection with this user."):alert("Error sending friend request: "+t.message));const n=document.getElementById("friendSearchInput");n&&n.value&&searchFriends(n.value),loadFriendsPage()}async function acceptFriendRequest(e){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}await sb.from("connections").update({status:"accepted",updated_at:(new Date).toISOString()}).eq("id",e).eq("addressee_id",currentUser.id),loadFriendsPage()}async function declineFriendRequest(e){await sb.from("connections").update({status:"declined",updated_at:(new Date).toISOString()}).eq("id",e).eq("addressee_id",currentUser.id),loadFriendsPage()}async function cancelFriendRequest(e){await sb.from("connections").delete().eq("id",e).eq("requester_id",currentUser.id),loadFriendsPage()}async function removeFriend(e,t){showConfirmModal("Remove Friend",`Are you sure you want to remove ${t} from your friends?`,async()=>{await sb.from("connections").delete().eq("id",e),loadFriendsPage()},{confirmText:"Remove",confirmClass:"btn-danger"})}async function loadFriendsPage(){if(!currentUser||!document.getElementById("friendSearchInput"))return;const e=document.getElementById("pendingRequestsContainer"),t=document.getElementById("pendingRequestsSection"),n=document.getElementById("myFriendsContainer"),a=document.getElementById("outgoingRequestsContainer"),s=document.getElementById("outgoingRequestsSection"),o='\n    <div class="col-xl-4 col-md-6 col-12">\n      <div class="card">\n        <div class="card-body p-3 d-flex justify-content-between align-items-center">\n          <div class="d-flex align-items-center gap-3 flex-grow-1">\n            <div class="skeleton-loader rounded-circle" style="width: 40px; height: 40px;"></div>\n            <div style="flex-grow: 1;">\n              <div class="skeleton-loader mb-2" style="height: 16px; max-width: 60%;"></div>\n              <div class="skeleton-loader" style="height: 12px; max-width: 40%;"></div>\n            </div>\n          </div>\n          <div class="skeleton-loader" style="width: 70px; height: 32px; border-radius: 4px;"></div>\n        </div>\n      </div>\n    </div>\n  '.repeat(3);e&&(e.innerHTML=o),n&&(n.innerHTML=o),a&&(a.innerHTML=o);const{data:r}=await sb.from("connections").select("id, created_at, requester_id, requester:user_profiles!connections_requester_id_user_profiles_fkey(id, username, display_name, avatar_url)").eq("addressee_id",currentUser.id).eq("status","pending");e&&(r&&r.length>0?(t.classList.remove("d-none"),e.innerHTML=r.map(e=>`\n        <div class="col-xl-4 col-md-6 col-12">\n          <div class="card">\n            <div class="card-body p-3 d-flex justify-content-between align-items-center">\n              <div class="d-flex align-items-center gap-3">\n                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: var(--color-bg-3); border: 1px solid var(--color-border-subtle);">\n                  <i class="bi bi-person" style="font-size: 1.2rem;"></i>\n                </div>\n                <div>\n                  <strong style="color: var(--color-text-primary);">${escapeHtml(e.requester?.display_name||"Unknown")}</strong>\n                  ${e.requester?.username?`<div style="font-size: 0.8rem; color: var(--color-text-tertiary);">@${escapeHtml(e.requester.username)}</div>`:""}\n                </div>\n              </div>\n              <div class="d-flex gap-2">\n                <button class="btn btn-sm btn-success" onclick="acceptFriendRequest('${escapeAttribute(e.id)}')" aria-label="Accept friend request from ${escapeAttribute(e.friend_email||e.requester?.display_name||"Unknown")}"><i class="bi bi-check-lg"></i></button>\n                <button class="btn btn-sm btn-outline-danger" onclick="declineFriendRequest('${escapeAttribute(e.id)}')" aria-label="Decline friend request from ${escapeAttribute(e.friend_email||e.requester?.display_name||"Unknown")}"><i class="bi bi-x-lg"></i></button>\n              </div>\n            </div>\n          </div>\n        </div>\n      `).join("")):t.classList.add("d-none"));const{data:i}=await sb.from("connections").select("id, status, created_at, requester_id, addressee_id, requester:user_profiles!connections_requester_id_user_profiles_fkey(id, username, display_name, avatar_url), addressee:user_profiles!connections_addressee_id_user_profiles_fkey(id, username, display_name, avatar_url)").eq("status","accepted").or(`requester_id.eq.${currentUser.id},addressee_id.eq.${currentUser.id}`);if(n){const e=(i||[]).map(e=>({connectionId:e.id,friend:e.requester?.id===currentUser.id?e.addressee:e.requester,since:e.created_at}));if(e.length>0)"function"==typeof hideEmptyState&&hideEmptyState("myFriendsContainer"),n.innerHTML=e.map(e=>`\n        <div class="col-xl-4 col-md-6 col-12">\n          <div class="card">\n            <div class="card-body p-3 d-flex justify-content-between align-items-center">\n              <div class="d-flex align-items-center gap-3">\n                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: var(--color-bg-3); border: 1px solid var(--color-border-subtle);">\n                  <i class="bi bi-person-fill" style="font-size: 1.2rem; color: var(--color-success);"></i>\n                </div>\n                <div>\n                  <strong style="color: var(--color-text-primary);">${escapeHtml(e.friend?.display_name||"Unknown")}</strong>\n                  ${e.friend?.username?`<div style="font-size: 0.8rem; color: var(--color-text-tertiary);">@${escapeHtml(e.friend.username)}</div>`:""}\n                  <small style="color: var(--color-text-tertiary);">Friends since ${formatDate(e.since?.split("T")[0])}</small>\n                </div>\n              </div>\n              <button class="btn btn-sm btn-outline-danger" onclick="removeFriend('${escapeAttribute(e.connectionId)}', '${escapeAttribute(e.friend?.display_name||"this friend")}')">\n                <i class="bi bi-person-dash"></i>\n              </button>\n            </div>\n          </div>\n        </div>\n      `).join("");else if("function"==typeof showEmptyState)n.innerHTML="",showEmptyState("myFriendsContainer","friends");else{const e=document.createElement("div");e.className="col-12";const t=document.createElement("p");t.className="text-muted fst-italic",t.textContent="No friends yet. Search for people to connect with!",e.appendChild(t),n.replaceChildren(e)}}const{data:l}=await sb.from("connections").select("id, created_at, addressee:user_profiles!connections_addressee_id_user_profiles_fkey(id, username, display_name, avatar_url)").eq("requester_id",currentUser.id).eq("status","pending");a&&(l&&l.length>0?(s.classList.remove("d-none"),a.innerHTML=l.map(e=>`\n        <div class="col-xl-4 col-md-6 col-12">\n          <div class="card">\n            <div class="card-body p-3 d-flex justify-content-between align-items-center">\n              <div class="d-flex align-items-center gap-3">\n                <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 40px; height: 40px; background: var(--color-bg-3); border: 1px solid var(--color-border-subtle);">\n                  <i class="bi bi-person" style="font-size: 1.2rem;"></i>\n                </div>\n                <div>\n                  <strong style="color: var(--color-text-primary);">${escapeHtml(e.addressee?.display_name||"Unknown")}</strong>\n                  ${e.addressee?.username?`<div style="font-size: 0.8rem; color: var(--color-text-tertiary);">@${escapeHtml(e.addressee.username)}</div>`:""}\n                  <small style="color: var(--color-text-tertiary);">Sent ${formatDate(e.created_at?.split("T")[0])}</small>\n                </div>\n              </div>\n              <button class="btn btn-sm btn-outline-secondary" onclick="cancelFriendRequest('${escapeAttribute(e.id)}')">\n                <i class="bi bi-x-lg me-1"></i>Cancel\n              </button>\n            </div>\n          </div>\n        </div>\n      `).join("")):s.classList.add("d-none"))}let resizeTimeout,billSharesCache=[],sharedWithMeCache=[];async function loadSharedBillsData(){if(!currentUser)return;const{data:e}=await sb.from("bill_shares").select("*, shared_user:user_profiles!bill_shares_shared_with_id_user_profiles_fkey(id, username, display_name)").eq("owner_id",currentUser.id);billSharesCache=e||[];const{data:t}=await sb.from("bill_shares").select("*, bill:bills!bill_shares_bill_id_fkey(*), owner:user_profiles!bill_shares_owner_id_user_profiles_fkey(id, username, display_name)").eq("shared_with_id",currentUser.id).eq("status","accepted");sharedWithMeCache=t||[];const{data:n}=await sb.from("bill_shares").select("*, bill:bills!bill_shares_bill_id_fkey(*), owner:user_profiles!bill_shares_owner_id_user_profiles_fkey(id, username, display_name)").eq("shared_with_id",currentUser.id).eq("status","pending"),{data:a}=await sb.from("bill_shares").select("*, bill:bills!bill_shares_bill_id_fkey(*), shared_user:user_profiles!bill_shares_shared_with_id_user_profiles_fkey(id, username, display_name)").eq("owner_id",currentUser.id);renderSharedWithMe(sharedWithMeCache),renderPendingShares(n||[]),renderMySharedBills(a||[]),window.sharedBillsForDisplay=sharedWithMeCache.map(e=>({id:`shared_${e.id}`,originalBillId:e.bill?.id,name:e.bill?.name||"Unknown Bill",amount:e.shared_amount||.5*e.bill?.amount,fullAmount:e.bill?.amount,type:e.bill?.type||"Other",frequency:e.bill?.frequency||"monthly",nextDueDate:e.bill?.next_due_date||e.bill?.nextDueDate,isSharedWithMe:!0,sharedByName:e.owner?.display_name||"Unknown",sharedByUsername:e.owner?.username||"",splitType:e.split_type,splitLabel:"equal"===e.split_type?"50/50":"percentage"===e.split_type?`${e.shared_percent}%`:formatCurrency(e.shared_fixed),shareId:e.id,status:e.bill?.status})),renderBills(),document.getElementById("netWorthValue")&&updateDashboardCards(),document.getElementById("budgetAssignmentTable")&&loadAndRenderBudget()}function renderSharedWithMe(e){const t=document.getElementById("sharedWithMeSection"),n=document.getElementById("sharedWithMeTableBody");t&&n&&(0!==e.length?(t.classList.remove("d-none"),n.innerHTML=e.map(e=>{const t="equal"===e.split_type?"50/50":"percentage"===e.split_type?`${escapeHtml(e.shared_percent)}%`:formatCurrency(e.shared_fixed);return`\n      <tr>\n        <td>${escapeHtml(e.bill?.name||"Unknown")}</td>\n        <td>\n          <span style="color: var(--color-text-secondary);">${escapeHtml(e.owner?.display_name||"Unknown")}</span>\n          ${e.owner?.username?`<small class="d-block" style="color: var(--color-text-tertiary);">@${escapeHtml(e.owner.username)}</small>`:""}\n        </td>\n        <td><strong style="color: var(--color-primary);">${formatCurrency(e.shared_amount)}</strong></td>\n        <td style="color: var(--color-text-tertiary);">${formatCurrency(e.bill?.amount)}</td>\n        <td><span class="badge bg-info">${escapeHtml(t)}</span></td>\n        <td><span class="badge bg-success">Active</span></td>\n        <td>\n          <span class="badge bg-secondary-subtle"><i class="bi bi-link-45deg me-1"></i>Shared</span>\n        </td>\n      </tr>\n    `}).join("")):t.classList.add("d-none"))}function renderPendingShares(e){const t=document.getElementById("pendingSharesSection"),n=document.getElementById("pendingSharesContainer");t&&n&&(0!==e.length?(t.classList.remove("d-none"),n.innerHTML=e.map(e=>{const t="equal"===e.split_type?"50/50":"percentage"===e.split_type?`${escapeHtml(e.owner_percent)}/${escapeHtml(e.shared_percent)}`:"Fixed";return`\n      <div class="col-xl-4 col-md-6 col-12">\n        <div class="card">\n          <div class="card-body p-4">\n            <div class="d-flex justify-content-between align-items-start mb-2">\n              <h5 class="mb-0" style="color: var(--color-text-primary);">${escapeHtml(e.bill?.name||"Unknown Bill")}</h5>\n              <span class="badge bg-warning">Pending</span>\n            </div>\n            <p style="color: var(--color-text-secondary); font-size: 0.85rem;">\n              <i class="bi bi-person me-1"></i>From: ${escapeHtml(e.owner?.display_name||"Unknown")}\n            </p>\n            <div class="d-flex justify-content-between mb-2">\n              <span style="color: var(--color-text-tertiary);">Full bill:</span>\n              <span style="color: var(--color-text-primary);">${formatCurrency(e.bill?.amount)}</span>\n            </div>\n            <div class="d-flex justify-content-between mb-2">\n              <span style="color: var(--color-text-tertiary);">Your portion:</span>\n              <strong style="color: var(--color-primary);">${formatCurrency(e.shared_amount)}</strong>\n            </div>\n            <div class="d-flex justify-content-between mb-3">\n              <span style="color: var(--color-text-tertiary);">Split:</span>\n              <span class="badge bg-info">${escapeHtml(t)}</span>\n            </div>\n            <div class="d-flex gap-2">\n              <button class="btn btn-success btn-sm flex-grow-1" onclick="acceptBillShare('${escapeAttribute(e.id)}')">\n                <i class="bi bi-check-lg me-1"></i>Accept\n              </button>\n              <button class="btn btn-outline-danger btn-sm flex-grow-1" onclick="declineBillShare('${escapeAttribute(e.id)}')">\n                <i class="bi bi-x-lg me-1"></i>Decline\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `}).join("")):t.classList.add("d-none"))}function renderMySharedBills(e){const t=document.getElementById("mySharedBillsSection"),n=document.getElementById("mySharedBillsTableBody");t&&n&&(0!==e.length?(t.classList.remove("d-none"),n.innerHTML=e.map(e=>{const t="equal"===e.split_type?"50/50":"percentage"===e.split_type?`${escapeHtml(e.shared_percent)}%`:formatCurrency(e.shared_fixed),n="accepted"===e.status?"success":"pending"===e.status?"warning":"danger",a="accepted"===e.status?"Active":"pending"===e.status?"Pending":"Declined";return`\n      <tr>\n        <td>${escapeHtml(e.bill?.name||"Unknown")}</td>\n        <td>\n          <span style="color: var(--color-text-secondary);">${escapeHtml(e.shared_user?.display_name||"Unknown")}</span>\n          ${e.shared_user?.username?`<small class="d-block" style="color: var(--color-text-tertiary);">@${escapeHtml(e.shared_user.username)}</small>`:""}\n        </td>\n        <td><strong style="color: var(--color-primary);">${formatCurrency(e.shared_amount)}</strong></td>\n        <td style="color: var(--color-text-secondary);">${formatCurrency(e.owner_amount)}</td>\n        <td><span class="badge bg-info">${escapeHtml(t)}</span></td>\n        <td><span class="badge bg-${escapeAttribute(n)}">${escapeHtml(a)}</span></td>\n        <td>\n          <button class="btn btn-outline-danger btn-sm" onclick="revokeShareBill('${escapeAttribute(e.id)}')" title="Revoke share">\n            <i class="bi bi-x-circle me-1"></i>Revoke\n          </button>\n        </td>\n      </tr>\n    `}).join("")):t.classList.add("d-none"))}async function revokeShareBill(e){showConfirmModal("Revoke Shared Bill","Are you sure you want to revoke this shared bill? The other person will no longer see it.",async()=>{const{error:t}=await sb.from("bill_shares").delete().eq("id",e).eq("owner_id",currentUser.id);t?Toast.error("Error revoking share: "+t.message):(await loadSharedBillsData(),renderBills())},{confirmText:"Revoke",confirmClass:"btn-danger"})}async function openShareBillModal(e){const t=(window.bills||[]).find(t=>t.id==e);if(!t)return;document.getElementById("shareBillId").value=t.id,document.getElementById("shareBillName").value=escapeHtml(t.name||""),document.getElementById("shareBillAmount").value=formatCurrency(t.amount),document.getElementById("shareSplitType").value="equal",document.getElementById("percentageSplitFields").classList.add("d-none"),document.getElementById("fixedSplitFields").classList.add("d-none"),document.getElementById("shareOwnerPercent").value=50,document.getElementById("shareSharedPercent").value=50;const n=document.getElementById("shareFriendSelect"),a=document.getElementById("noFriendsMsg"),s=document.createElement("option");s.value="",s.textContent="Select a friend...",n.replaceChildren(s);const{data:o}=await sb.from("connections").select("id, requester_id, addressee_id, requester:user_profiles!connections_requester_id_user_profiles_fkey(id, username, display_name), addressee:user_profiles!connections_addressee_id_user_profiles_fkey(id, username, display_name)").eq("status","accepted").or(`requester_id.eq.${currentUser.id},addressee_id.eq.${currentUser.id}`),r=(o||[]).map(e=>e.requester?.id===currentUser.id?e.addressee:e.requester).filter(Boolean);0===r.length?a.classList.remove("d-none"):(a.classList.add("d-none"),r.forEach(e=>{const t=document.createElement("option");t.value=e.id,t.textContent=`${e.display_name||"Unknown"}${e.username?` (@${e.username})`:""}`,n.appendChild(t)})),updateSharePreview(),bootstrap.Modal.getOrCreateInstance(document.getElementById("shareBillModal")).show()}function updateSharePreview(){const e=getRaw(document.getElementById("shareBillAmount").value);let t=0,n=0;switch(document.getElementById("shareSplitType").value){case"equal":t=e/2,n=e/2;break;case"percentage":t=e*((parseFloat(document.getElementById("shareOwnerPercent").value)||0)/100),n=e*((parseFloat(document.getElementById("shareSharedPercent").value)||0)/100);break;case"fixed":t=parseFloat(document.getElementById("shareOwnerFixed").value)||0,n=parseFloat(document.getElementById("shareSharedFixed").value)||0}document.getElementById("sharePreviewOwner").textContent=formatCurrency(t),document.getElementById("sharePreviewShared").textContent=formatCurrency(n)}async function confirmShareBill(){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}const e=document.getElementById("shareBillId").value,t=document.getElementById("shareFriendSelect").value,n=document.getElementById("shareSplitType").value;if(!t)return void alert("Please select a friend to share with.");const a=(window.bills||[]).find(t=>t.id==e);if(!a)return;let s,o,r,i,l,d;switch(n){case"equal":s=50,o=50,l=a.amount/2,d=a.amount/2;break;case"percentage":if(s=parseFloat(document.getElementById("shareOwnerPercent").value)||0,o=parseFloat(document.getElementById("shareSharedPercent").value)||0,Math.abs(s+o-100)>.01)return void document.getElementById("percentageError").classList.remove("d-none");l=a.amount*(s/100),d=a.amount*(o/100);break;case"fixed":if(r=parseFloat(document.getElementById("shareOwnerFixed").value)||0,i=parseFloat(document.getElementById("shareSharedFixed").value)||0,r>a.amount||i>a.amount){const e=document.getElementById("fixedAmountError");return void(e&&(e.textContent="Amount exceeds the bill total.",e.classList.remove("d-none")))}if(Math.abs(r+i-a.amount)>.01){const e=document.getElementById("fixedAmountError");return void(e&&(e.textContent="Amounts must add up to the bill total.",e.classList.remove("d-none")))}l=r,d=i}const{error:c}=await sb.from("bill_shares").insert({bill_id:e,owner_id:currentUser.id,shared_with_id:t,status:"pending",split_type:n,owner_percent:s||null,shared_percent:o||null,owner_fixed:r||null,shared_fixed:i||null,owner_amount:Math.round(100*l)/100,shared_amount:Math.round(100*d)/100});c?c.message.includes("unique")||c.message.includes("duplicate")?alert("This bill is already shared with that user."):alert("Error sharing bill: "+c.message):(bootstrap.Modal.getInstance(document.getElementById("shareBillModal")).hide(),await loadSharedBillsData(),renderBills())}async function acceptBillShare(e){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}await sb.from("bill_shares").update({status:"accepted",accepted_at:(new Date).toISOString(),updated_at:(new Date).toISOString()}).eq("id",e).eq("shared_with_id",currentUser.id),await loadSharedBillsData()}async function declineBillShare(e){try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(e){return void alert(e.message)}await sb.from("bill_shares").update({status:"declined",updated_at:(new Date).toISOString()}).eq("id",e).eq("shared_with_id",currentUser.id),await loadSharedBillsData()}function getShareInfoForBill(e){return billSharesCache.find(t=>t.bill_id===e)}function initializeTooltips(){[...document.querySelectorAll('[data-bs-toggle="tooltip"]')].map(e=>new bootstrap.Tooltip(e))}function initShareBillUI(){document.getElementById("shareBillModal")&&(document.getElementById("shareSplitType")?.addEventListener("change",e=>{document.getElementById("percentageSplitFields").classList.toggle("d-none","percentage"!==e.target.value),document.getElementById("fixedSplitFields").classList.toggle("d-none","fixed"!==e.target.value),document.getElementById("percentageError")?.classList.add("d-none"),document.getElementById("fixedAmountError")?.classList.add("d-none"),updateSharePreview()}),["shareOwnerPercent","shareSharedPercent"].forEach(e=>{document.getElementById(e)?.addEventListener("input",updateSharePreview)}),document.getElementById("shareOwnerFixed")?.addEventListener("input",e=>{const t=getRaw(document.getElementById("shareBillAmount").value),n=parseFloat(e.target.value)||0,a=Math.min(Math.max(n,0),t),s=Math.round(100*(t-a))/100;document.getElementById("shareSharedFixed").value=s>=0?s:0;const o=document.getElementById("fixedAmountError");o&&o.classList.toggle("d-none",n<=t),updateSharePreview()}),document.getElementById("shareSharedFixed")?.addEventListener("input",e=>{const t=getRaw(document.getElementById("shareBillAmount").value),n=parseFloat(e.target.value)||0,a=Math.min(Math.max(n,0),t),s=Math.round(100*(t-a))/100;document.getElementById("shareOwnerFixed").value=s>=0?s:0;const o=document.getElementById("fixedAmountError");o&&o.classList.toggle("d-none",n<=t),updateSharePreview()}),document.getElementById("shareOwnerPercent")?.addEventListener("input",e=>{document.getElementById("shareSharedPercent").value=100-(parseFloat(e.target.value)||0),updateSharePreview()}),document.getElementById("shareSharedPercent")?.addEventListener("input",e=>{document.getElementById("shareOwnerPercent").value=100-(parseFloat(e.target.value)||0),updateSharePreview()}),document.getElementById("confirmShareBillBtn")?.addEventListener("click",confirmShareBill))}document.addEventListener("DOMContentLoaded",init),window.addEventListener("resize",function(){clearTimeout(resizeTimeout),resizeTimeout=setTimeout(function(){window.innerWidth<768&&(Chart.defaults.font.size=11,Chart.defaults.responsive=!0,Chart.defaults.maintainAspectRatio=!1,document.querySelectorAll(".chart-wrapper canvas").forEach(e=>{e.style.backgroundColor="transparent"}))},250)}),window.openAssetModal=openAssetModal,window.confirmDeleteAsset=confirmDeleteAsset,window.deleteAssetConfirmed=deleteAssetConfirmed,window.openInvestmentModal=openInvestmentModal,window.confirmDeleteInvestment=confirmDeleteInvestment,window.deleteInvestmentConfirmed=deleteInvestmentConfirmed,window.openDebtModal=openDebtModal,window.confirmDeleteDebt=confirmDeleteDebt,window.deleteDebtConfirmed=deleteDebtConfirmed,window.openBillModal=openBillModal,window.confirmDeleteBill=confirmDeleteBill,window.deleteBillConfirmed=deleteBillConfirmed,window.openIncomeModal=openIncomeModal,window.confirmDeleteIncome=confirmDeleteIncome,window.deleteIncomeConfirmed=deleteIncomeConfirmed,window.generateBudgetForMonth=generateBudgetForMonth,window.searchFriends=searchFriends,window.sendFriendRequest=sendFriendRequest,window.acceptFriendRequest=acceptFriendRequest,window.declineFriendRequest=declineFriendRequest,window.cancelFriendRequest=cancelFriendRequest,window.removeFriend=removeFriend,window.openShareBillModal=openShareBillModal,window.confirmShareBill=confirmShareBill,window.acceptBillShare=acceptBillShare,window.declineBillShare=declineBillShare,window.revokeShareBill=revokeShareBill,window.markAllNotificationsRead=markAllNotificationsRead,window.handleNotificationClick=handleNotificationClick,window.showAmortizationSchedule=showAmortizationSchedule,window.deleteBudgetItem=deleteBudgetItem,window.sessionSecurity=sessionSecurity;