const DEBUG_EMAIL_BILLS=!1;function debugLog(...e){}let pendingEmailBills=[],selectedBillIds=new Set;const CONFIDENCE_THRESHOLDS={HIGH:.7,LOW:.5};async function scanEmailForBills(){if(window.rateLimiters&&!window.rateLimiters.email.allow("scanEmailBills")){const e=window.rateLimiters.email.getRemainingTime("scanEmailBills"),n=Math.ceil(e/1e3);return void showToast(`Too many scan requests. Please wait ${n} seconds.`,"warning")}const e=document.getElementById("scanEmailBillsBtn");if(!e)return;const n=e.innerHTML;e.disabled=!0,e.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Scanning...';try{const e=await fetch("/api/scan-email-bills",{method:"POST",headers:{"Content-Type":"application/json",Authorization:`Bearer ${(await sb.auth.getSession()).data.session?.access_token}`},body:JSON.stringify({days:30})});if(!e.ok)throw new Error(`Scan failed: ${e.statusText}`);const n=await e.json();n.bills&&n.bills.length>0?(await storePendingBills(n.bills),showToast(`Found ${n.bills.length} bills! Review them below.`,"success"),await loadPendingEmailBills(),bootstrap.Modal.getOrCreateInstance(document.getElementById("emailReviewModal")).show()):showToast("No new bills found in your email.","info")}catch(e){showToast(`Scan failed: ${e.message}. Gmail integration may not be set up yet.`,"danger")}finally{e.disabled=!1,e.innerHTML=n}}async function storePendingBills(e){if(!currentUser)throw new Error("User not authenticated");const n=e.map(e=>({user_id:currentUser.id,vendor:e.vendor,amount:e.amount,due_date:e.due_date||null,category:e.category||"other",confidence:e.confidence||.5,source_email_id:e.source_email_id||null,email_subject:e._meta?.subject||"",email_snippet:e._meta?.snippet||"",status:"pending"})),{data:t,error:l}=await sb.from("pending_bills").insert(n).select();if(l)throw new Error(`Failed to save bills: ${l.message}`);return debugLog(`Stored ${t.length} pending bills`),t}async function loadPendingEmailBills(){if(currentUser)try{const{data:e,error:n}=await sb.from("pending_bills").select("*").eq("user_id",currentUser.id).eq("status","pending").order("created_at",{ascending:!1});if(n)throw n;pendingEmailBills=e||[],updatePendingBillsUI()}catch(e){}}function updatePendingBillsUI(){const e=document.getElementById("pendingEmailBillsSection"),n=document.getElementById("pendingEmailCount");pendingEmailBills.length>0?(e?.classList.remove("d-none"),n&&(n.textContent=pendingEmailBills.length)):e?.classList.add("d-none")}function populateEmailReviewModal(){const e=document.getElementById("emailReviewLoading"),n=document.getElementById("emailReviewEmpty"),t=document.getElementById("emailReviewBatchActions"),l=document.getElementById("emailReviewList");e?.classList.remove("d-none"),n?.classList.add("d-none"),t?.classList.add("d-none"),l&&(l.textContent=""),setTimeout(()=>{e?.classList.add("d-none"),0!==pendingEmailBills.length?(t?.classList.remove("d-none"),renderPendingBillsList()):n?.classList.remove("d-none")},300)}function renderPendingBillsList(){const e=document.getElementById("emailReviewList");e&&(e.innerHTML=pendingEmailBills.map(e=>{Math.round(100*e.confidence);const n=getConfidenceBadge(e.confidence),t=selectedBillIds.has(e.id);return`\n        <div class="card mb-3 pending-bill-card ${t?"selected":""}" data-bill-id="${e.id}">\n          <div class="card-body">\n            <div class="row">\n              \x3c!-- Selection Checkbox --\x3e\n              <div class="col-auto d-flex align-items-center">\n                <div class="form-check">\n                  <input \n                    class="form-check-input bill-checkbox" \n                    type="checkbox" \n                    value="${e.id}" \n                    id="bill-${e.id}"\n                    ${t?"checked":""}\n                  >\n                </div>\n              </div>\n\n              \x3c!-- Bill Details --\x3e\n              <div class="col">\n                <div class="d-flex justify-content-between align-items-start mb-2">\n                  <div>\n                    <h6 class="mb-1">\n                      ${escapeHtml(e.vendor)}\n                      ${n}\n                    </h6>\n                    <small class="text-muted">\n                      <i class="bi bi-envelope me-1"></i>${escapeHtml(e.email_subject||"No subject")}\n                    </small>\n                  </div>\n                  <div class="text-end">\n                    <h5 class="mb-0" style="color: var(--color-primary);">${formatCurrency(e.amount)}</h5>\n                    ${e.due_date?`<small class="text-muted">Due: ${formatDate(e.due_date)}</small>`:""}\n                  </div>\n                </div>\n\n                \x3c!-- Category & Email Snippet --\x3e\n                <div class="row g-2 mb-2">\n                  <div class="col-md-4">\n                    <label class="form-label form-label-sm">Category</label>\n                    <select class="form-select form-select-sm bill-category" data-bill-id="${e.id}">\n                      <option value="utilities" ${"utilities"===e.category?"selected":""}>Utilities</option>\n                      <option value="housing" ${"housing"===e.category?"selected":""}>Housing</option>\n                      <option value="auto" ${"auto"===e.category?"selected":""}>Auto</option>\n                      <option value="insurance" ${"insurance"===e.category?"selected":""}>Insurance</option>\n                      <option value="subscriptions" ${"subscriptions"===e.category?"selected":""}>Subscriptions</option>\n                      <option value="health" ${"health"===e.category?"selected":""}>Health</option>\n                      <option value="other" ${"other"===e.category?"selected":""}>Other</option>\n                    </select>\n                  </div>\n                  <div class="col-md-8">\n                    <label class="form-label form-label-sm">Email Preview</label>\n                    <div class="email-snippet">\n                      ${escapeHtml(e.email_snippet||"No preview available").substring(0,120)}...\n                    </div>\n                  </div>\n                </div>\n\n                \x3c!-- Actions --\x3e\n                <div class="d-flex gap-2 mt-3">\n                  <button class="btn btn-sm btn-success approve-bill-btn" data-bill-id="${e.id}">\n                    <i class="bi bi-check-circle"></i> Approve\n                  </button>\n                  <button class="btn btn-sm btn-danger reject-bill-btn" data-bill-id="${e.id}">\n                    <i class="bi bi-x-circle"></i> Reject\n                  </button>\n                  <button class="btn btn-sm btn-outline-primary edit-bill-btn" data-bill-id="${e.id}">\n                    <i class="bi bi-pencil"></i> Edit\n                  </button>\n                </div>\n              </div>\n            </div>\n          </div>\n        </div>\n      `}).join(""))}function getConfidenceBadge(e){const n=Math.round(100*e);return e>=CONFIDENCE_THRESHOLDS.HIGH?`<span class="badge bg-success ms-2">${n}% confident</span>`:e>=CONFIDENCE_THRESHOLDS.LOW?`<span class="badge bg-warning text-dark ms-2">${n}% confident</span>`:`<span class="badge bg-danger ms-2">${n}% confident</span>`}function updateBillCardSelection(e,n){const t=document.querySelector(`.pending-bill-card[data-bill-id="${e}"]`);t&&(n?t.classList.add("selected"):t.classList.remove("selected"))}async function approveBill(e){const n=pendingEmailBills.find(n=>n.id===e);if(n)try{const{error:t}=await sb.from("bills").insert({user_id:currentUser.id,name:n.vendor,type:n.category,amount:n.amount,nextDueDate:n.due_date||null,frequency:n.frequency||"monthly"});if(t)throw t;const{error:l}=await sb.from("pending_bills").update({status:"approved"}).eq("id",e);if(l)throw l;pendingEmailBills=pendingEmailBills.filter(n=>n.id!==e),selectedBillIds.delete(e),renderPendingBillsList(),updatePendingBillsUI(),"function"==typeof loadBills&&loadBills(),showToast(`âœ“ ${n.vendor} added to your bills`,"success")}catch(e){showToast(`Failed to approve bill: ${e.message}`,"danger")}}async function rejectBill(e){try{const{error:n}=await sb.from("pending_bills").update({status:"rejected"}).eq("id",e);if(n)throw n;pendingEmailBills=pendingEmailBills.filter(n=>n.id!==e),selectedBillIds.delete(e),renderPendingBillsList(),updatePendingBillsUI(),showToast("Bill rejected","info")}catch(e){showToast(`Failed to reject bill: ${e.message}`,"danger")}}function editBill(e){const n=pendingEmailBills.find(n=>n.id===e);if(!n)return;const t=document.getElementById("billName"),l=document.getElementById("billAmount"),i=document.getElementById("billType");t&&(t.value=n.vendor||""),l&&(l.value=n.amount||""),i&&(i.value=n.category||"other");const s=document.getElementById("addBillModal");if(s){s.dataset.editPendingId=e;const n=s.querySelector(".modal-title");n&&(n.textContent="Edit Detected Bill"),bootstrap.Modal.getOrCreateInstance(s).show()}}async function updateBillCategory(e,n){try{const{error:t}=await sb.from("pending_bills").update({category:n}).eq("id",e);if(t)throw t;const l=pendingEmailBills.find(n=>n.id===e);l&&(l.category=n)}catch(e){}}async function updateBillAmount(e,n){try{const{error:t}=await sb.from("pending_bills").update({amount:n}).eq("id",e);if(t)throw t;const l=pendingEmailBills.find(n=>n.id===e);l&&(l.amount=n),renderPendingBillsList(),showToast("Amount updated","success")}catch(e){showToast(`Failed to update amount: ${e.message}`,"danger")}}async function approveAllHighConfidence(){const e=pendingEmailBills.filter(e=>e.confidence>=CONFIDENCE_THRESHOLDS.HIGH);0!==e.length?showConfirmModal("Approve Bills",`Approve ${e.length} high-confidence bills?`,async()=>{for(const n of e)await approveBill(n.id);showToast(`Approved ${e.length} bills`,"success")},{confirmText:"Approve All",confirmClass:"btn-success"}):showToast("No high-confidence bills to approve","info")}async function rejectAllLowConfidence(){const e=pendingEmailBills.filter(e=>e.confidence<=CONFIDENCE_THRESHOLDS.LOW);0!==e.length?showConfirmModal("Reject Bills",`Reject ${e.length} low-confidence bills?`,async()=>{for(const n of e)await rejectBill(n.id);showToast(`Rejected ${e.length} bills`,"success")},{confirmText:"Reject All",confirmClass:"btn-danger"}):showToast("No low-confidence bills to reject","info")}function selectAllBills(){pendingEmailBills.forEach(e=>selectedBillIds.add(e.id)),document.querySelectorAll(".bill-checkbox").forEach(e=>{e.checked=!0,updateBillCardSelection(e.value,!0)})}function deselectAllBills(){selectedBillIds.clear(),document.querySelectorAll(".bill-checkbox").forEach(e=>{e.checked=!1,updateBillCardSelection(e.value,!1)})}function initEmailBillsEventListeners(){const e=document.getElementById("scanEmailBillsBtn");e&&e.addEventListener("click",scanEmailForBills);const n=document.getElementById("emailReviewModal");n&&n.addEventListener("show.bs.modal",populateEmailReviewModal);const t=document.getElementById("emailReviewList");t&&(t.addEventListener("change",e=>{const n=e.target.closest(".bill-checkbox");if(!n)return;const t=n.value;n.checked?selectedBillIds.add(t):selectedBillIds.delete(t),updateBillCardSelection(t,n.checked)}),t.addEventListener("change",e=>{const n=e.target.closest(".bill-category");n&&updateBillCategory(n.dataset.billId,n.value)}),t.addEventListener("click",e=>{const n=e.target.closest(".approve-bill-btn");if(n)return void approveBill(n.dataset.billId);const t=e.target.closest(".reject-bill-btn");if(t)return void rejectBill(t.dataset.billId);const l=e.target.closest(".edit-bill-btn");l&&editBill(l.dataset.billId)}));const l=document.getElementById("approveAllHighConfidenceBtn");l&&l.addEventListener("click",approveAllHighConfidence);const i=document.getElementById("rejectAllLowConfidenceBtn");i&&i.addEventListener("click",rejectAllLowConfidence);const s=document.getElementById("selectAllBtn");s&&s.addEventListener("click",selectAllBills);const a=document.getElementById("deselectAllBtn");a&&a.addEventListener("click",deselectAllBills);const o=document.getElementById("saveEmailReviewBtn");o&&o.addEventListener("click",async()=>{const e=Array.from(selectedBillIds);if(0!==e.length){for(const n of e)await approveBill(n);0===pendingEmailBills.length&&bootstrap.Modal.getInstance(n)?.hide()}else showToast("No bills selected","warning")})}function initEmailBills(){initEmailBillsEventListeners(),loadPendingEmailBills()}window.addEventListener("dataLoaded",()=>{document.getElementById("scanEmailBillsBtn")&&"function"==typeof initEmailBills&&initEmailBills()}),"undefined"!=typeof window&&(window.initEmailBills=initEmailBills,window.loadPendingEmailBills=loadPendingEmailBills);