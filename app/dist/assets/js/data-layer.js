const DataLayer={async getCurrentUser(){if("function"==typeof isDemoMode&&isDemoMode())return DEMO_USER;if("undefined"==typeof sb)return null;const{data:{user:e}}=await sb.auth.getUser();return e||null},async getAssets(){if("function"==typeof isDemoMode&&isDemoMode())return{data:DEMO_DATA.assets,error:null};if("undefined"==typeof sb)return{data:[],error:"Supabase not initialized"};const e=await this.getCurrentUser();return e?await sb.from("assets").select("*").eq("user_id",e.id).order("name",{ascending:!0}):{data:[],error:"Not authenticated"}},async getIncome(){if("function"==typeof isDemoMode&&isDemoMode())return{data:DEMO_DATA.income,error:null};if("undefined"==typeof sb)return{data:[],error:"Supabase not initialized"};const e=await this.getCurrentUser();return e?await sb.from("income").select("*").eq("user_id",e.id).order("source",{ascending:!0}):{data:[],error:"Not authenticated"}},async getBills(){if("function"==typeof isDemoMode&&isDemoMode())return{data:DEMO_DATA.bills,error:null};if("undefined"==typeof sb)return{data:[],error:"Supabase not initialized"};const e=await this.getCurrentUser();return e?await sb.from("bills").select("*").eq("user_id",e.id).order("nextDueDate",{ascending:!0}):{data:[],error:"Not authenticated"}},async getDebts(){if("function"==typeof isDemoMode&&isDemoMode())return{data:DEMO_DATA.debts,error:null};if("undefined"==typeof sb)return{data:[],error:"Supabase not initialized"};const e=await this.getCurrentUser();return e?await sb.from("debts").select("*").eq("user_id",e.id).order("name",{ascending:!0}):{data:[],error:"Not authenticated"}},async getInvestments(){if("function"==typeof isDemoMode&&isDemoMode())return{data:DEMO_DATA.investments,error:null};if("undefined"==typeof sb)return{data:[],error:"Supabase not initialized"};const e=await this.getCurrentUser();return e?await sb.from("investments").select("*").eq("user_id",e.id).order("name",{ascending:!0}):{data:[],error:"Not authenticated"}},async getTransactions(e={}){if("function"==typeof isDemoMode&&isDemoMode()){let t=[...DEMO_DATA.transactions||[]];e.category&&(t=t.filter(t=>t.category===e.category)),e.startDate&&(t=t.filter(t=>t.date>=e.startDate)),e.endDate&&(t=t.filter(t=>t.date<=e.endDate)),t.sort((e,t)=>t.date>e.date?1:t.date<e.date?-1:0);const r=t.length;return e.offset&&(t=t.slice(e.offset)),e.limit&&(t=t.slice(0,e.limit)),{data:t,count:r,error:null}}if("undefined"==typeof sb)return{data:[],count:0,error:"Supabase not initialized"};const t=await this.getCurrentUser();if(!t)return{data:[],count:0,error:"Not authenticated"};let r=sb.from("transactions").select("*",{count:"exact"}).eq("user_id",t.id).order("date",{ascending:!1});return e.category&&(r=r.eq("category",e.category)),e.startDate&&(r=r.gte("date",e.startDate)),e.endDate&&(r=r.lte("date",e.endDate)),e.limit&&(r=r.limit(e.limit)),e.offset&&(r=r.range(e.offset,e.offset+(e.limit||50)-1)),await r},async getSnapshots(e={}){if("function"==typeof isDemoMode&&isDemoMode()){let t=[...DEMO_DATA.snapshots||[]];return e.startDate&&(t=t.filter(t=>t.date>=e.startDate)),t.sort((e,t)=>e.date>t.date?1:e.date<t.date?-1:0),e.limit&&(t=t.slice(-e.limit)),{data:t,error:null}}if("undefined"==typeof sb)return{data:[],error:"Supabase not initialized"};const t=await this.getCurrentUser();if(!t)return{data:[],error:"Not authenticated"};let r=sb.from("snapshots").select("*").eq("user_id",t.id).order("date",{ascending:!0});return e.startDate&&(r=r.gte("date",e.startDate)),e.limit&&(r=r.limit(e.limit)),await r},async getSettings(){if("function"==typeof isDemoMode&&isDemoMode())return{data:DEMO_DATA.settings||DEMO_SETTINGS,error:null};if("undefined"==typeof sb)return{data:null,error:"Supabase not initialized"};const e=await this.getCurrentUser();return e?await sb.from("settings").select("*").eq("user_id",e.id).single():{data:null,error:"Not authenticated"}},async upsertSettings(e){if("function"==typeof isDemoMode&&isDemoMode())return{data:e,error:null};if("undefined"==typeof sb)return{data:null,error:"Supabase not initialized"};const t=await this.getCurrentUser();return t?await sb.from("settings").upsert({...e,user_id:t.id},{onConflict:"user_id"}):{data:null,error:"Not authenticated"}}};window.DataLayer=DataLayer;