const PLAID_SERVER_URL=void 0!==window.PLAID_SERVER_URL?window.PLAID_SERVER_URL:"http://localhost:3000",CATEGORIES=["dining","groceries","transportation","utilities","entertainment","shopping","healthcare","travel","bills","income","other"];let currentPage=1,itemsPerPage=50,totalCount=0,activeFilters={};async function loadTransactions(t={}){try{const e=await sb.auth.getUser();if(!e.data.user)return{data:[],count:0};const n=t.limit||50,a=((t.page||1)-1)*n;let s=sb.from("transactions").select("*",{count:"exact"}).eq("user_id",e.data.user.id).order("date",{ascending:!1});t.category&&(s=s.eq("category",t.category)),t.startDate&&(s=s.gte("date",t.startDate)),t.endDate&&(s=s.lte("date",t.endDate)),s=s.range(a,a+n-1);const{data:r,error:o,count:c}=await s;if(o)throw o;return{data:r||[],count:c||0}}catch(t){return{data:[],count:0}}}async function syncTransactions(){try{const t=document.getElementById("syncTransactionsBtn");t&&(t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Syncing...');const e=localStorage.getItem("plaid_access_token");if(!e)return void showToast("Please connect a bank account first","warning");const n=await fetch(`${PLAID_SERVER_URL}/api/transactions/sync`,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({accessToken:e})});if(!n.ok){const t=await n.json();throw new Error(t.error||"Sync failed")}const a=await n.json(),s=await categorizeTransactionsBatch(a.transactions),r=await sb.auth.getUser(),o=s.map(t=>({...t,user_id:r.data.user.id})),{error:c}=await sb.from("transactions").upsert(o,{onConflict:"plaid_transaction_id"});if(c)throw c;showToast(`Synced ${a.count} transactions!`,"success"),await renderTransactionsTable()}catch(t){showToast("Failed to sync transactions: "+t.message,"danger")}finally{const t=document.getElementById("syncTransactionsBtn");t&&(t.disabled=!1,t.innerHTML='<i class="bi bi-arrow-repeat"></i> Sync Transactions')}}function updatePaginationUI(){const t=Math.ceil(totalCount/itemsPerPage);document.getElementById("pageIndicator").textContent=`Page ${currentPage} of ${t||1}`,document.getElementById("prevPageBtn").disabled=1===currentPage,document.getElementById("nextPageBtn").disabled=currentPage>=t;const e=document.getElementById("paginationControls");t<=1?e.classList.add("d-none"):e.classList.remove("d-none")}async function renderTransactionsTable(t={}){const e=document.getElementById("transactionsTableBody"),n=document.getElementById("loadingSpinner"),a=document.getElementById("emptyState"),s=document.querySelector(".table-responsive");if(!e)return;e.innerHTML="",n&&n.classList.remove("d-none"),a&&a.classList.add("d-none");const r={category:t.category||"",startDate:t.startDate||"",endDate:t.endDate||"",page:currentPage,limit:itemsPerPage},o=await loadTransactions(r),c=o.data;if(totalCount=o.count,n&&n.classList.add("d-none"),0===c.length)return s&&s.classList.add("d-none"),a&&a.classList.remove("d-none"),void updatePaginationUI();s&&s.classList.remove("d-none"),a&&a.classList.add("d-none"),e.innerHTML=c.map(t=>`\n    <tr>\n      <td>${new Date(t.date).toLocaleDateString()}</td>\n      <td>${escapeHtml(t.merchant_name||t.name)}</td>\n      <td>\n        <select class="form-select form-select-sm" data-transaction-id="${t.id}">\n          ${CATEGORIES.map(e=>`\n            <option value="${e}" ${t.category===e?"selected":""}>${e}</option>\n          `).join("")}\n        </select>\n        ${!t.user_confirmed&&t.confidence>0?`\n          <small class="text-muted">AI: ${Math.round(100*t.confidence)}%</small>\n        `:""}\n      </td>\n      <td class="${t.amount>0?"text-danger":"text-success"}">\n        ${t.amount>0?"-":"+"}${formatCurrency(Math.abs(t.amount))}\n      </td>\n      <td>\n        ${t.pending?'<span class="badge bg-warning">Pending</span>':""}\n      </td>\n    </tr>\n  `).join(""),updatePaginationUI()}async function updateTransactionCategory(t,e){try{const{error:n}=await sb.from("transactions").update({category:e,user_confirmed:!0}).eq("id",t);if(n)throw n;await learnCategoryPattern(t,e),showToast("Category updated","success")}catch(t){showToast("Failed to update category","danger")}}function formatCurrency(t){return new Intl.NumberFormat("en-US",{style:"currency",currency:"USD"}).format(t)}async function addManualTransaction(){const t=document.getElementById("addTransactionSubmitBtn"),e=document.getElementById("addTransactionAlert");try{t.disabled=!0,t.innerHTML='<span class="spinner-border spinner-border-sm me-2"></span>Adding...';const e=document.getElementById("transactionDate").value,n=document.getElementById("transactionDescription").value.trim(),a=parseFloat(document.getElementById("transactionAmount").value),s=document.getElementById("transactionType").value,r=document.getElementById("transactionCategory").value,o=document.getElementById("transactionAccount").value.trim()||"Manual Entry";if(!(e&&n&&a&&s&&r))throw new Error("Please fill in all required fields");if(a<=0)throw new Error("Amount must be greater than 0");const c=await sb.auth.getUser();if(!c.data.user)throw new Error("You must be logged in to add transactions");const d="expense"===s?a:-a,i={user_id:c.data.user.id,date:e,merchant_name:n,amount:d,category:r,source:"manual",confidence_level:1,user_confirmed:!0,account_name:o,pending:!1,name:n},{data:l,error:u}=await sb.from("transactions").insert([i]).select();if(u)throw u;showToast("Transaction added successfully!","success"),document.getElementById("addTransactionForm").reset(),bootstrap.Modal.getOrCreateInstance(document.getElementById("addTransactionModal")).hide(),await renderTransactionsTable()}catch(t){e.className="alert alert-danger",e.textContent=t.message||"Failed to add transaction",e.classList.remove("d-none")}finally{t.disabled=!1,t.innerHTML="Add Transaction"}}document.addEventListener("DOMContentLoaded",async()=>{if(document.getElementById("transactionsTableBody"))try{await renderTransactionsTable();const t=document.getElementById("transactionsTableBody");t&&t.addEventListener("change",t=>{const e=t.target.closest("select[data-transaction-id]");e&&updateTransactionCategory(e.dataset.transactionId,e.value)});const e=document.getElementById("prevPageBtn"),n=document.getElementById("nextPageBtn"),a=document.getElementById("itemsPerPage");e&&e.addEventListener("click",()=>{currentPage>1&&(currentPage--,renderTransactionsTable(activeFilters))}),n&&n.addEventListener("click",()=>{const t=Math.ceil(totalCount/itemsPerPage);currentPage<t&&(currentPage++,renderTransactionsTable(activeFilters))}),a&&a.addEventListener("change",t=>{itemsPerPage=parseInt(t.target.value),currentPage=1,renderTransactionsTable(activeFilters)}),document.querySelectorAll("[data-preset]").forEach(t=>{t.addEventListener("click",t=>{const e=t.target.dataset.preset,n=new Date;let a,s;switch(e){case"last7":a=new Date(n),a.setDate(n.getDate()-7),s=n;break;case"last30":a=new Date(n),a.setDate(n.getDate()-30),s=n;break;case"last90":a=new Date(n),a.setDate(n.getDate()-90),s=n;break;case"thisMonth":a=new Date(n.getFullYear(),n.getMonth(),1),s=n;break;case"thisYear":a=new Date(n.getFullYear(),0,1),s=n}const r=t=>t.toISOString().split("T")[0],o=document.getElementById("startDate"),c=document.getElementById("endDate");o&&(o.value=r(a)),c&&(c.value=r(s));const d=document.getElementById("applyFiltersBtn");d&&d.click()})})}catch(t){}});