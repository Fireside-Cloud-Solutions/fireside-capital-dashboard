let chartInstances={netWorth:null,cashFlow:null,netWorthDelta:null,spendingCategories:null,savingsRate:null,investmentGrowth:null,assetAllocation:null,dtiGauge:null};const TIME_RANGES={"1M":{months:1,label:"1 Month"},"3M":{months:3,label:"3 Months"},"6M":{months:6,label:"6 Months"},"1Y":{months:12,label:"1 Year"},All:{months:null,label:"All Time"}};function getTimeRange(t){return localStorage.getItem(`timeRange_${t}`)||"6M"}function setTimeRange(t,e){localStorage.setItem(`timeRange_${t}`,e)}function filterDataByTimeRange(t,e,a){if("All"===a||!TIME_RANGES[a])return{data:t,labels:e};const n=TIME_RANGES[a].months,o=Math.max(0,t.length-n);return{data:t.slice(o),labels:e.slice(o)}}function shouldEnableDecimation(t){return t>100}function getResponsiveLegendPosition(){return window.innerWidth<768?"bottom":"right"}function updateChartData(t,e,a,n=null){t&&(t.data.labels=a,t.data.datasets[0].data=e,n&&t.data.datasets.length>1&&(t.data.datasets[1].data=n),t.update("none"))}function createTimeRangeFilter(t,e,a="full"){const n=getTimeRange(t),o=document.createElement("div");return o.className="time-range-filter btn-group btn-group-sm mb-3",o.setAttribute("role","group"),o.setAttribute("aria-label","Time range filter"),Object.keys(TIME_RANGES).forEach(a=>{const r=document.createElement("button");r.type="button",r.className="btn "+(a===n?"btn-primary":"btn-outline-secondary"),r.textContent=a,r.setAttribute("data-range",a),r.addEventListener("click",()=>{o.querySelectorAll(".btn").forEach(t=>{t.classList.remove("btn-primary"),t.classList.add("btn-outline-secondary")}),r.classList.remove("btn-outline-secondary"),r.classList.add("btn-primary"),setTimeRange(t,a),e(a)}),o.appendChild(r)}),o}function getEnhancedTooltipConfig(t=!0){return{backgroundColor:"rgba(26, 26, 26, 0.95)",titleColor:"#ffffff",bodyColor:"#e0e0e0",borderColor:"#f44e24",borderWidth:1,padding:12,displayColors:!0,callbacks:{label:function(e){let a=e.dataset.label||"";return a&&(a+=": "),a+=t?formatCurrency(e.parsed.y):e.parsed.y.toFixed(2)+"%",a},title:function(t){return t[0].label}}}}async function renderNetWorthChart(){const t=document.getElementById("netWorthTimelineChart");if(!t)return;const e=t.closest(".chart-card");if(e&&!e.querySelector(".time-range-filter")){const t=document.createElement("div");t.className="d-flex justify-content-between align-items-center mb-2";const a=createTimeRangeFilter("netWorth",t=>{renderNetWorthChart()});t.appendChild(a);const n=e.querySelector("h5");n.parentNode.insertBefore(t,n.nextSibling)}chartInstances.netWorth&&chartInstances.netWorth.destroy();const a=dedupeSnapshotsByDate(window.snapshots||[]),n=a.map(t=>t.date),o=filterDataByTimeRange(a.map(t=>getRaw(t.netWorth)),n,getTimeRange("netWorth")),r=[],s=[];if(o.data.length>=2){const t=[];for(let e=1;e<o.data.length;e++)t.push(o.data[e]-o.data[e-1]);const e=t.reduce((t,e)=>t+e,0)/t.length,a=o.data[o.data.length-1],n=new Date(o.labels[o.labels.length-1]);for(let t=1;t<=12;t++){const o=new Date(n);o.setMonth(o.getMonth()+t),r.push(o.toISOString().split("T")[0]),s.push(a+e*t)}}const i=getThemeColors(),l=[{label:"Net Worth",data:o.data,borderColor:"#f44e24",backgroundColor:"rgba(244, 78, 36, 0.15)",tension:.3,fill:!0,pointRadius:4,pointHoverRadius:6,pointBackgroundColor:"#f44e24",pointBorderColor:"#fff",pointBorderWidth:2}];s.length>0&&l.push({label:"Projected (based on avg trend)",data:[...Array(o.data.length-1).fill(null),o.data[o.data.length-1],...s],borderColor:"#01a4ef",backgroundColor:"transparent",borderDash:[5,5],tension:.3,fill:!1,pointRadius:0,pointHoverRadius:4}),chartInstances.netWorth=await safeCreateChart(t,{type:"line",data:{labels:s.length>0?[...o.labels,...r]:o.labels,datasets:l},options:{responsive:!0,maintainAspectRatio:!1,parsing:0!==s.length,normalized:0===s.length,interaction:{mode:"index",intersect:!1},plugins:{decimation:{enabled:shouldEnableDecimation(o.data.length),algorithm:"lttb",samples:50,threshold:100},legend:{labels:{color:i.text}},tooltip:getEnhancedTooltipConfig(!0)},scales:{y:{ticks:{callback:t=>formatCurrency(t),color:i.text},grid:{color:i.grid}},x:{ticks:{color:i.text,maxRotation:0,minRotation:0,autoSkip:!0,sampleSize:10},grid:{display:!1}}}}},"Net Worth Timeline")}async function generateMonthlyCashFlowChart(){const t=document.getElementById("cashFlowChart");if(!t)return;chartInstances.cashFlow&&chartInstances.cashFlow.destroy();const e=getThemeColors(),a=[],n=[],o=[],r=new Date;for(let t=0;t<6;t++){const e=new Date(r.getFullYear(),r.getMonth()+t,1),s=new Date(r.getFullYear(),r.getMonth()+t+1,0);a.push(e.toLocaleString("default",{month:"short"}));let i=0,l=0;const c=[...window.bills||[],...window.sharedBillsForDisplay||[]].filter(t=>{const e=(t.status||"").toLowerCase();if("paid_off"===e||"cancelled"===e)return!1;const a=getBillFinancingInfo(t);return!a.isFinancing||"paid_off"!==a.status});[...window.income||[],...c,...(window.debts||[]).map(t=>({...t,amount:t.monthlyPayment,frequency:"monthly"}))].forEach(t=>{if(!t.nextDueDate||!t.frequency)return;const a="string"==typeof t.type&&("w2"===t.type.toLowerCase()||"1099"===t.type.toLowerCase());let n=t.amount;if(t.isSharedWithMe);else if(!a&&t.id){const e=getShareInfoForBill(t.id);e&&"accepted"===e.status&&(n=e.owner_amount)}n=getRaw(n);let o=new Date(t.nextDueDate+"T00:00:00"),c=0;for(;o<e&&o.getFullYear()<r.getFullYear()+2&&c<1e3;){try{o=getNextDate(o,t.frequency)}catch{break}c++}for(c=0;o<=s&&c<100;){a?i+=n:l+=n;try{o=getNextDate(o,t.frequency)}catch{break}c++}}),n.push(i),o.push(l)}chartInstances.cashFlow=await safeCreateChart(t,{type:"bar",data:{labels:a,datasets:[{label:"Income",data:n,backgroundColor:"#81b900"},{label:"Expenses",data:o,backgroundColor:"#e53935"}]},options:{responsive:!0,maintainAspectRatio:!1,interaction:{mode:"index",intersect:!1},scales:{x:{stacked:!1,ticks:{color:e.text,maxRotation:0,minRotation:0,autoSkip:!0,sampleSize:10},grid:{display:!1}},y:{stacked:!1,ticks:{callback:t=>formatCurrency(t),color:e.text},grid:{color:e.grid}}},plugins:{legend:{labels:{color:e.text}},tooltip:getEnhancedTooltipConfig(!0)}}},"Cash Flow")}async function renderNetWorthDeltaChart(){const t=document.getElementById("netWorthDeltaChart");if(!t)return;const e=t.closest(".chart-card");if(e&&!e.querySelector(".time-range-filter")){const t=document.createElement("div");t.className="d-flex justify-content-between align-items-center mb-2";const a=createTimeRangeFilter("netWorthDelta",t=>{renderNetWorthDeltaChart()});t.appendChild(a);const n=e.querySelector("h5");n.parentNode.insertBefore(t,n.nextSibling)}chartInstances.netWorthDelta&&chartInstances.netWorthDelta.destroy();const a=dedupeSnapshotsByDate(window.snapshots||[]),n=[],o=[];for(let t=1;t<a.length;t++){const e=getRaw(a[t].netWorth)-getRaw(a[t-1].netWorth);n.push(e),o.push(a[t].date)}const r=filterDataByTimeRange(n,o,getTimeRange("netWorthDelta")),s=getThemeColors();chartInstances.netWorthDelta=await safeCreateChart(t,{type:"bar",data:{labels:r.labels,datasets:[{label:"Net Worth Change",data:r.data,backgroundColor:r.data.map(t=>t>=0?"#81b900":"#e53935")}]},options:{responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{display:!1},tooltip:getEnhancedTooltipConfig(!0)},scales:{y:{ticks:{callback:t=>formatCurrency(t),color:s.text},grid:{color:s.grid}},x:{ticks:{color:s.text,maxRotation:0,minRotation:0,autoSkip:!0,sampleSize:10},grid:{display:!1}}}}},"Net Worth Delta")}async function renderSavingsRateChart(){const t=document.getElementById("savingsRateChart");if(!t)return;const e=t.closest(".chart-card");if(e&&!e.querySelector(".time-range-filter")){const t=document.createElement("div");t.className="d-flex justify-content-between align-items-center mb-2";const a=createTimeRangeFilter("savingsRate",t=>{renderSavingsRateChart()});t.appendChild(a);const n=e.querySelector("h5");n.parentNode.insertBefore(t,n.nextSibling)}chartInstances.savingsRate&&chartInstances.savingsRate.destroy();const a=new Date,n=[],o=[];for(let t=0;t<12;t++){const e=new Date(a.getFullYear(),a.getMonth()-(11-t),1),r=new Date(a.getFullYear(),a.getMonth()-(11-t)+1,0);n.push(e.toLocaleString("default",{month:"short",year:"numeric"}));let s=0,i=0;[...window.income||[],...window.bills||[],...(window.debts||[]).map(t=>({...t,amount:t.monthlyPayment,frequency:"monthly"}))].forEach(t=>{if(!t.nextDueDate||!t.frequency)return;const a="string"==typeof t.type&&("w2"===t.type.toLowerCase()||"1099"===t.type.toLowerCase());let n=getRaw(t.amount),o=new Date(t.nextDueDate+"T00:00:00"),l=0;for(;o<e&&l<1e3;)o=getNextDate(o,t.frequency),l++;for(l=0;o<=r&&l<100;)a?s+=n:i+=n,o=getNextDate(o,t.frequency),l++});const l=s>0?(s-i)/s*100:0;o.push(isNaN(l)||!isFinite(l)?0:Math.round(l))}const r=filterDataByTimeRange(o,n,getTimeRange("savingsRate")),s=getThemeColors();chartInstances.savingsRate=await safeCreateChart(t,{type:"line",data:{labels:r.labels,datasets:[{label:"Savings Rate %",data:r.data,fill:!0,borderColor:"#81b900",backgroundColor:"rgba(129, 185, 0, 0.15)",tension:.4,pointRadius:4,pointHoverRadius:6,pointBackgroundColor:"#81b900",pointBorderColor:"#fff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{labels:{color:s.text}},tooltip:getEnhancedTooltipConfig(!1)},scales:{y:{ticks:{callback:t=>t+"%",color:s.text},grid:{color:s.grid}},x:{ticks:{color:s.text,maxRotation:0,minRotation:0,autoSkip:!0,sampleSize:10},grid:{display:!1}}}}},"Savings Rate")}async function renderInvestmentGrowthChart(){const t=document.getElementById("investmentGrowthChart");if(!t)return;const e=t.closest(".chart-card");if(e&&!e.querySelector(".time-range-filter")){const t=document.createElement("div");t.className="d-flex justify-content-between align-items-center mb-2";const a=createTimeRangeFilter("investmentGrowth",t=>{renderInvestmentGrowthChart()});t.appendChild(a);const n=e.querySelector("h5");n.parentNode.insertBefore(t,n.nextSibling)}chartInstances.investmentGrowth&&chartInstances.investmentGrowth.destroy();const a=window.investments||[],n=new Date,o=[],r=[],s=a.reduce((t,e)=>t+parseFloat(e.value||0),0),i=(s>0?a.reduce((t,e)=>t+parseFloat(e.value||0)*parseFloat(e.annualReturn||0),0)/s:0)/100/12,l=a.reduce((t,e)=>t+parseFloat(e.monthlyContribution||0),0);r.push(s),o.push(n.toLocaleString("default",{month:"short"}));for(let t=1;t<12;t++){const e=new Date(n.getFullYear(),n.getMonth()+t,1);o.push(e.toLocaleString("default",{month:"short"}));const a=r[t-1];r.push(Math.round(a*(1+i)+l))}const c=filterDataByTimeRange(r,o,getTimeRange("investmentGrowth")),d=getThemeColors();chartInstances.investmentGrowth=await safeCreateChart(t,{type:"line",data:{labels:c.labels,datasets:[{label:"Projected Value",data:c.data,fill:!0,borderColor:"#f44e24",backgroundColor:"rgba(244, 78, 36, 0.15)",tension:.3,pointRadius:4,pointHoverRadius:6,pointBackgroundColor:"#f44e24",pointBorderColor:"#fff",pointBorderWidth:2}]},options:{responsive:!0,maintainAspectRatio:!1,parsing:!1,normalized:!0,interaction:{mode:"index",intersect:!1},plugins:{legend:{labels:{color:d.text}},tooltip:getEnhancedTooltipConfig(!0)},scales:{y:{ticks:{callback:t=>formatCurrency(t),color:d.text},grid:{color:d.grid}},x:{ticks:{color:d.text,maxRotation:0,minRotation:0,autoSkip:!0,sampleSize:10},grid:{display:!1}}}}},"Investment Growth")}async function renderSpendingCategoriesChart(){const t=document.getElementById("spendingCategoriesChart");if(!t)return;chartInstances.spendingCategories&&chartInstances.spendingCategories.destroy();const e={};[...window.bills||[],...(window.debts||[]).map(t=>({...t,amount:t.monthlyPayment,type:"Debt Payment"}))].forEach(t=>{const a=t.type||"Other",n=getRaw(t.amount);e[a]=(e[a]||0)+n});const a=Object.entries(e).sort((t,e)=>e[1]-t[1]).slice(0,6),n=a.map(t=>t[0]),o=a.map(t=>t[1]),r=getThemeColors();chartInstances.spendingCategories=await safeCreateChart(t,{type:"doughnut",data:{labels:n,datasets:[{data:o,backgroundColor:["#f44e24","#01a4ef","#81b900","#ffa726","#ab47bc","#26c6da"],hoverOffset:10}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:getResponsiveLegendPosition(),labels:{color:r.text,font:{size:window.innerWidth<768?11:14,weight:"500"},padding:window.innerWidth<768?10:20,boxWidth:window.innerWidth<768?15:20,boxHeight:window.innerWidth<768?15:20,generateLabels:t=>{const e=t.data;if(e.labels.length&&e.datasets.length){const t=e.datasets[0].data.reduce((t,e)=>t+e,0);return e.labels.map((a,n)=>{const o=e.datasets[0].data[n],r=(o/t*100).toFixed(1);return{text:`${a}: ${formatCurrency(o)} (${r}%)`,fillStyle:e.datasets[0].backgroundColor[n],hidden:!1,index:n}})}return[]}}},tooltip:{...getEnhancedTooltipConfig(!0),callbacks:{label:function(t){const e=t.label||"",a=t.parsed,n=(a/t.dataset.data.reduce((t,e)=>t+e,0)*100).toFixed(1);return`${e}: ${formatCurrency(a)} (${n}%)`}}}},onClick:(t,e)=>{if(e.length>0){const t=e[0].index,a=n[t],r=o[t];"undefined"!=typeof Toast&&Toast.info(`<strong>${a}</strong><br>Monthly Total: ${formatCurrency(r)}`)}}}},"Spending Categories")}async function renderAssetAllocationChart(){const t=document.getElementById("assetAllocationChart");if(!t)return;chartInstances.assetAllocation&&chartInstances.assetAllocation.destroy();const e=window.assets||[],a={"Real Estate":0,Vehicles:0,Other:0};e.forEach(t=>{const e=getRaw(t.value);"realEstate"===t.type?a["Real Estate"]+=e:"vehicle"===t.type?a.Vehicles+=e:a.Other+=e});const n=Object.keys(a).filter(t=>a[t]>0),o=n.map(t=>a[t]),r={"Real Estate":"#01a4ef",Vehicles:"#ffa726",Other:"#9e9e9e"},s=getThemeColors();0===o.length||o.every(t=>0===t)?t.parentElement.innerHTML='<p class="text-muted text-center">No assets to display. Add assets to see allocation.</p>':chartInstances.assetAllocation=await safeCreateChart(t,{type:"pie",data:{labels:n,datasets:[{data:o,backgroundColor:n.map(t=>r[t]),hoverOffset:8}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{position:"bottom",labels:{color:s.text,padding:15,font:{size:12},generateLabels:t=>{const e=t.data;if(e.labels.length&&e.datasets.length){const t=e.datasets[0].data.reduce((t,e)=>t+e,0);return e.labels.map((a,n)=>{const o=e.datasets[0].data[n],r=(o/t*100).toFixed(1);return{text:`${a}: ${formatCurrency(o)} (${r}%)`,fillStyle:e.datasets[0].backgroundColor[n],hidden:!1,index:n}})}return[]}}},tooltip:getEnhancedTooltipConfig(!0)}}},"Asset Allocation")}async function renderDTIGauge(){const t=document.getElementById("dtiGaugeChart");if(!t)return;chartInstances.dtiGauge&&chartInstances.dtiGauge.destroy();const e=window.debts||[],a=window.bills||[];let n=0;e.forEach(t=>{n+=getRaw(t.monthlyPayment)}),a.forEach(t=>{t.type&&(t.type.toLowerCase().includes("loan")||t.type.toLowerCase().includes("financing"))&&(n+=normalizeToMonthly(getRaw(t.amount),t.frequency))});const o=window.income||[];let r=0;o.forEach(t=>{r+=normalizeToMonthly(getRaw(t.amount),t.frequency)});const s=r>0?n/r*100:0,i=Math.round(s);let l,c;s<20?(l="#81b900",c="Excellent"):s<36?(l="#ffa726",c="Manageable"):(l="#e53935",c="High");const d=getThemeColors();chartInstances.dtiGauge=await safeCreateChart(t,{type:"doughnut",data:{labels:["DTI Ratio","Available"],datasets:[{data:[i,Math.max(0,100-i)],backgroundColor:[l,d.grid],borderWidth:0,circumference:180,rotation:270}]},options:{responsive:!0,maintainAspectRatio:!1,plugins:{legend:{display:!1},tooltip:{enabled:!1}}},plugins:[{id:"gaugeText",afterDraw:t=>{const{ctx:e,chartArea:{left:a,right:n,top:o,bottom:r}}=t,s=(a+n)/2,h=r-20;e.save(),e.textAlign="center",e.textBaseline="middle",e.font="bold 32px Inter",e.fillStyle=l,e.fillText(`${i}%`,s,h-25),e.font="14px Inter",e.fillStyle=d.text,e.fillText(c,s,h),e.restore()}}]},"DTI Gauge");const h=t.closest(".chart-wrapper");if(h&&!h.querySelector(".dti-description")){const t=document.createElement("div");t.className="dti-description text-center mt-3",t.innerHTML=`\n      <p class="text-muted mb-1" style="font-size: 12px;">\n        Monthly Debt: ${formatCurrency(n)} / Income: ${formatCurrency(r)}\n      </p>\n      <p class="text-muted" style="font-size: 11px;">\n        <strong>Good:</strong> &lt;20% | <strong>Warning:</strong> 20-36% | <strong>High:</strong> &gt;36%\n      </p>\n    `,h.appendChild(t)}}async function renderAdditionalCharts(){await Promise.all([renderNetWorthDeltaChart(),renderSpendingCategoriesChart(),renderSavingsRateChart(),renderInvestmentGrowthChart(),renderAssetAllocationChart(),renderDTIGauge()])}Chart.defaults.animation=!1,Chart.defaults.responsive=!0,Chart.defaults.maintainAspectRatio=!1,Chart.defaults.datasets.line.tension=0,Chart.defaults.datasets.line.spanGaps=!0,window.renderNetWorthChart=renderNetWorthChart,window.generateMonthlyCashFlowChart=generateMonthlyCashFlowChart,window.renderAdditionalCharts=renderAdditionalCharts;