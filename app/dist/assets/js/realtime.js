const FiresideRealtime=(()=>{"use strict";let e=null,t=0,n=null,s=!1;const i=new Map,r={totalEvents:0,connectionAttempts:0,lastConnectedAt:null,lastEventAt:null};function a(){return"undefined"!=typeof sb&&null!==sb}function o(){return"function"==typeof isDemoMode&&isDemoMode()}function c(e,t){r.totalEvents++,r.lastEventAt=(new Date).toISOString();const n=i.get(e)||[];0!==n.length&&n.forEach(e=>{try{e(t)}catch(e){}})}async function l(){if(!a())return;if(o())return;let i;r.connectionAttempts++;try{const{data:{user:e},error:t}=await sb.auth.getUser();if(t||!e)return;i=e.id}catch(e){return}await async function(){clearTimeout(n),n=null;const t=e;if(e=null,s=!1,t&&a())try{await sb.removeChannel(t)}catch(e){}}(),e=sb.channel(`fireside-ops-${Date.now()}`).on("postgres_changes",{event:"INSERT",schema:"public",table:"transactions",filter:`user_id=eq.${i}`},e=>{c("transaction:insert",e.new)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"transactions",filter:`user_id=eq.${i}`},e=>{c("transaction:update",e.new)}).on("postgres_changes",{event:"UPDATE",schema:"public",table:"bills",filter:`user_id=eq.${i}`},e=>{c("bill:update",e.new)}).on("postgres_changes",{event:"INSERT",schema:"public",table:"snapshots",filter:`user_id=eq.${i}`},e=>{c("snapshot:insert",e.new)}).subscribe((n,i)=>{switch(n){case"SUBSCRIBED":t=0,s=!0,r.lastConnectedAt=(new Date).toISOString();break;case"CHANNEL_ERROR":case"TIMED_OUT":s=!1,u();break;case"CLOSED":s=!1,null!==e&&u()}})}function u(){if(t>=5)return;const e=5e3*Math.pow(2,t);t++,clearTimeout(n),n=setTimeout(()=>{l()},e)}return window.addEventListener("beforeunload",()=>{e=null,clearTimeout(n)}),{subscribe:l,on:function(e,t){"function"==typeof t&&(i.has(e)||i.set(e,[]),i.get(e).push(t))},off:function(e,t){if(!i.has(e))return;if(!t)return void i.delete(e);const n=i.get(e).filter(e=>e!==t);i.set(e,n)},reconnect:function(){t=0,clearTimeout(n),l()},teardown:async function(){const t=e;if(e=null,clearTimeout(n),n=null,s=!1,t&&a())try{await sb.removeChannel(t)}catch(e){}},status:function(){return{isSubscribed:s,retryCount:t,maxRetries:5,channelActive:null!==e,demoMode:o(),metrics:{...r},handlerCount:[...i.entries()].reduce((e,[t,n])=>(e[t]=n.length,e),{})}}}})();window.FiresideRealtime=FiresideRealtime;