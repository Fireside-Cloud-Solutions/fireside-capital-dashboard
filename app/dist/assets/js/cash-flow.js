const DAYS_IN_PERIOD={daily:1,weekly:7,"bi-weekly":14,monthly:30.44,"bi-monthly":60.88,quarterly:91.31,"semi-annual":182.63,annual:365.25};function generateCashFlowProjection({startBalance:e,incomes:t=[],bills:n=[],debts:a=[],days:o=90}){const s=new Date;s.setHours(0,0,0,0);const c={};for(let e=0;e<=o;e++){const t=new Date(s);t.setDate(s.getDate()+e);const n=t.toISOString().split("T")[0];c[n]={date:n,inflows:[],outflows:[],net:0,balance:0}}for(const e of t){if(!e.is_active)continue;const t=getOccurrences(e.next_payment_date||e.nextPaymentDate,e.frequency,o);for(const n of t)c[n]&&c[n].inflows.push({name:e.name,amount:e.amount,type:"income"})}for(const e of n){if(!e.is_active&&void 0!==e.is_active)continue;const t=getOccurrences(e.due_date||e.nextDueDate,e.frequency,o);for(const n of t)c[n]&&c[n].outflows.push({name:e.name,amount:e.amount,type:"bill"})}for(const e of a){const t=getOccurrences(e.next_payment_date||e.nextPaymentDate,"monthly",o);for(const n of t)c[n]&&c[n].outflows.push({name:e.name,amount:e.monthly_payment||e.monthlyPayment,type:"debt"})}let r=e||0;const l=Object.values(c).sort((e,t)=>e.date.localeCompare(t.date));for(const e of l){const t=e.inflows.reduce((e,t)=>e+t.amount,0),n=e.outflows.reduce((e,t)=>e+t.amount,0);e.net=t-n,r+=e.net,e.balance=r}return l}function getOccurrences(e,t,n){const a=[];if(!e||!t)return a;const o=new Date;o.setHours(0,0,0,0);const s=new Date(o);s.setDate(o.getDate()+n);let c=new Date(e);for(c.setHours(0,0,0,0);c<o;)c=advanceByFrequency(c,t);for(;c<=s&&(a.push(c.toISOString().split("T")[0]),c=advanceByFrequency(c,t),!(a.length>500)););return a}function advanceByFrequency(e,t){const n=new Date(e);switch((t||"").toLowerCase()){case"daily":n.setDate(n.getDate()+1);break;case"weekly":n.setDate(n.getDate()+7);break;case"bi-weekly":case"biweekly":n.setDate(n.getDate()+14);break;case"monthly":default:n.setMonth(n.getMonth()+1);break;case"bi-monthly":case"bimonthly":n.setMonth(n.getMonth()+2);break;case"quarterly":n.setMonth(n.getMonth()+3);break;case"semi-annual":case"semiannual":n.setMonth(n.getMonth()+6);break;case"annual":case"yearly":n.setFullYear(n.getFullYear()+1)}return n}function calculateSafeToSpend(e,t=500){const n=e.slice(0,15),a=Math.min(...n.map(e=>e.balance)),o=Math.max(0,a-t);return{safeToSpend:o,lowestBalance:a,lowestDate:n.find(e=>e.balance===a)?.date,safetyBuffer:t,isComfortable:o>1e3,isTight:o>0&&o<=1e3,isDanger:o<=0}}function getBillsAging(e){const t=[],n=[],a=[],o=(new Date).toISOString().split("T")[0];for(const s of e){if(s.date<o)continue;const e=Math.ceil((new Date(s.date)-new Date(o))/864e5);for(const o of s.outflows){const c={...o,date:s.date,daysOut:e};e<=7?t.push(c):e<=30?n.push(c):e<=60&&a.push(c)}}const s=e=>e.reduce((e,t)=>e+t.amount,0);return{critical:{items:t,total:s(t),label:"≤ 7 Days",color:"danger"},upcoming:{items:n,total:s(n),label:"8–30 Days",color:"warning"},planned:{items:a,total:s(a),label:"31–60 Days",color:"success"}}}function getUpcomingTransactions(e){const t=(new Date).toISOString().split("T")[0],n=e.filter(e=>e.date>=t).slice(0,15),a=[];for(const e of n){for(const t of e.inflows)a.push({date:e.date,name:t.name,amount:t.amount,type:"inflow",runningBalance:e.balance});for(const t of e.outflows)a.push({date:e.date,name:t.name,amount:t.amount,type:"outflow",runningBalance:e.balance})}return a.sort((e,t)=>e.date!==t.date?e.date.localeCompare(t.date):"inflow"===e.type?-1:1),a}function formatShortDate(e){const t=new Date(e);return`${t.toLocaleDateString("en-US",{month:"short"})} ${t.getDate()}`}function formatFullDate(e){return new Date(e).toLocaleDateString("en-US",{weekday:"long",year:"numeric",month:"long",day:"numeric"})}window.CashFlow={generateCashFlowProjection:generateCashFlowProjection,getOccurrences:getOccurrences,advanceByFrequency:advanceByFrequency,calculateSafeToSpend:calculateSafeToSpend,getBillsAging:getBillsAging,getUpcomingTransactions:getUpcomingTransactions,formatShortDate:formatShortDate,formatFullDate:formatFullDate};