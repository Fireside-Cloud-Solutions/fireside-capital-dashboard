const BVA_CATEGORIES=["dining","groceries","transportation","utilities","entertainment","shopping","healthcare","travel","other"],BVA_CATEGORY_ICONS={dining:"bi-cup-hot",groceries:"bi-cart3",transportation:"bi-car-front",utilities:"bi-lightning-charge",entertainment:"bi-controller",shopping:"bi-bag",healthcare:"bi-heart-pulse",travel:"bi-airplane",other:"bi-three-dots"};async function calculateBudgetVsActuals(t=null){const a=t||bvaGetCurrentMonth();let e={},n=[];if("undefined"==typeof DataLayer)return null;const s=await DataLayer.getSettings();e=s.data?.category_budgets||{};const r=`${a}-01`,i=bvaGetLastDayOfMonth(a);n=((await DataLayer.getTransactions({startDate:r,endDate:i})).data||[]).filter(t=>"income"!==t.category);const l={};n.forEach(t=>{const a=t.category||"other";l[a]=(l[a]||0)+Math.abs(parseFloat(t.amount)||0)});const c=BVA_CATEGORIES.map(t=>{const a=parseFloat(e[t])||0,n=parseFloat((l[t]||0).toFixed(2));let s;return s=0===a?"unbudgeted":n>a?"over":n>.85*a?"warning":"under",{category:t,budget:a,actual:n,variance:parseFloat((n-a).toFixed(2)),variancePct:a>0?parseFloat((100*(n/a-1)).toFixed(1)):null,status:s,progressPct:a>0?Math.min(parseFloat((n/a*100).toFixed(1)),150):null}}),o=parseFloat(c.reduce((t,a)=>t+a.budget,0).toFixed(2)),u=parseFloat(c.reduce((t,a)=>t+a.actual,0).toFixed(2)),d=parseFloat((u-o).toFixed(2));return{month:a,categories:c,totals:{budget:o,actual:u,variance:d,variancePct:o>0?parseFloat((100*(u/o-1)).toFixed(1)):null,status:d>0?"over":d>-.15*o?"warning":"under"}}}async function renderBudgetVsActuals(t,a=null){const e=document.getElementById(t);if(!e)return;e.innerHTML='\n    <div class="d-flex align-items-center justify-content-center py-4">\n      <div class="spinner-border spinner-border-sm text-primary me-2" role="status" aria-hidden="true"></div>\n      <span class="text-muted">Loading budget data...</span>\n    </div>';const n=await calculateBudgetVsActuals(a);if(!n)return void(e.innerHTML='\n      <div class="empty-state py-4">\n        <i class="bi bi-calculator empty-state-icon"></i>\n        <h5>No budget data</h5>\n        <p class="text-muted">Set category budgets in Settings to track your spending.</p>\n        <a href="settings.html" class="btn btn-primary">Set Up Budgets</a>\n      </div>');const{month:s,categories:r,totals:i}=n,l=bvaFormatMonthLabel(s),c="over"===i.status?"danger":"warning"===i.status?"warning":"success",o=i.variance>0?`<span class="text-danger">+${bvaFormatCurrency(i.variance)} over</span>`:`<span class="text-success">${bvaFormatCurrency(Math.abs(i.variance))} under</span>`,u=r.filter(t=>t.budget>0||t.actual>0),d=u.length>0?u.map(renderBVACategoryRow).join(""):'<p class="text-muted small text-center py-3">No category budgets set yet.\n         <a href="settings.html">Add budgets in Settings →</a></p>';e.innerHTML=`\n    <div class="d-flex justify-content-between align-items-center mb-3">\n      <span class="text-muted small">${l}</span>\n      <a href="settings.html" class="text-muted small">Edit Budgets →</a>\n    </div>\n    <div class="row mb-4 text-center">\n      <div class="col-4">\n        <div class="fs-4 fw-bold">${bvaFormatCurrency(i.budget)}</div>\n        <div class="text-muted small">Total Budget</div>\n      </div>\n      <div class="col-4">\n        <div class="fs-4 fw-bold text-${c}">${bvaFormatCurrency(i.actual)}</div>\n        <div class="text-muted small">Actual Spend</div>\n      </div>\n      <div class="col-4">\n        <div class="fs-4 fw-bold text-${c}">\n          ${null!==i.variancePct?Math.abs(i.variancePct).toFixed(1)+"%":"—"}\n        </div>\n        <div class="text-muted small">${o}</div>\n      </div>\n    </div>\n    <div id="bvaCategoryBreakdown">\n      ${d}\n    </div>\n    <div class="text-end mt-2">\n      <a href="transactions.html" class="text-muted small">View all transactions →</a>\n    </div>`}function renderBVACategoryRow(t){const{category:a,budget:e,actual:n,variance:s,status:r,progressPct:i}=t,l=BVA_CATEGORY_ICONS[a]||"bi-tag",c="over"===r?"danger":"warning"===r?"warning":"unbudgeted"===r?"secondary":"success",o=e>0?s>0?`<small class="text-danger ms-1">+${bvaFormatCurrency(s)}</small>`:`<small class="text-success ms-1">-${bvaFormatCurrency(Math.abs(s))}</small>`:'<small class="text-muted ms-1">no budget</small>',u=null!==i?i:0;return`\n    <div class="mb-3">\n      <div class="d-flex justify-content-between align-items-center mb-1">\n        <span class="d-flex align-items-center gap-2">\n          <i class="bi ${l} text-muted"></i>\n          <span class="text-capitalize fw-medium">${a}</span>\n        </span>\n        <span class="text-end">\n          <small>${bvaFormatCurrency(n)}</small>\n          <small class="text-muted"> / ${e>0?bvaFormatCurrency(e):"unset"}</small>\n          ${o}\n        </span>\n      </div>\n      <div class="progress progress-thin" role="progressbar"\n           aria-valuenow="${u}" aria-valuemin="0" aria-valuemax="150">\n        <div class="progress-bar bg-${c}" style="width: ${Math.min(u,100)}%"></div>\n      </div>\n    </div>`}function bvaGetCurrentMonth(){const t=new Date;return`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,"0")}`}function bvaGetLastDayOfMonth(t){const[a,e]=t.split("-").map(Number);return new Date(a,e,0).toISOString().split("T")[0]}function bvaFormatCurrency(t){return"function"==typeof formatCurrency?formatCurrency(t):"$"+parseFloat(t||0).toLocaleString("en-US",{minimumFractionDigits:2,maximumFractionDigits:2})}function bvaFormatMonthLabel(t){const[a,e]=t.split("-").map(Number);return new Date(a,e-1,1).toLocaleDateString("en-US",{month:"long",year:"numeric"})}async function getBudgetAlertSummary(){const t=await calculateBudgetVsActuals();return t?{overCount:t.categories.filter(t=>"over"===t.status).length,warningCount:t.categories.filter(t=>"warning"===t.status).length,budgetedCategories:t.categories.filter(t=>t.budget>0).length,totalVariance:t.totals.variance,totalVariancePct:t.totals.variancePct,overallStatus:t.totals.status,month:t.month}:null}