const SESSION_CONFIG={INACTIVITY_TIMEOUT:18e5,ABSOLUTE_TIMEOUT:288e5,ACTIVITY_CHECK_INTERVAL:6e4,MAX_LOGIN_ATTEMPTS:5,LOGIN_ATTEMPT_WINDOW:9e5,WARNING_THRESHOLD:3e5};class SessionSecurityManager{constructor(t,i){this.sb=t,this.onForceLogout=i,this.lastActivity=Date.now(),this.sessionStartTime=null,this.activityMonitor=null,this.loginAttempts=this.loadLoginAttempts(),this.warningShown=!1,this.isActive=!1,this.init()}init(){this.registerActivityListeners(),this.sb.auth.getSession().then(({data:{session:t}})=>{t&&this.startSessionMonitoring()})}registerActivityListeners(){["mousedown","mousemove","keypress","scroll","touchstart","click"].forEach(t=>{document.addEventListener(t,()=>this.recordActivity(),{passive:!0})})}recordActivity(){this.isActive&&(this.lastActivity=Date.now(),this.warningShown=!1,this.hideSessionWarning())}startSessionMonitoring(){this.isActive||(this.isActive=!0,this.sessionStartTime=Date.now(),this.lastActivity=Date.now(),this.warningShown=!1,this.activityMonitor&&clearInterval(this.activityMonitor),this.activityMonitor=setInterval(()=>this.checkSessionValidity(),SESSION_CONFIG.ACTIVITY_CHECK_INTERVAL))}stopSessionMonitoring(){this.isActive=!1,this.activityMonitor&&(clearInterval(this.activityMonitor),this.activityMonitor=null),this.sessionStartTime=null,this.hideSessionWarning()}checkSessionValidity(){if(!this.isActive)return;const t=Date.now(),i=t-this.lastActivity;if(t-this.sessionStartTime>SESSION_CONFIG.ABSOLUTE_TIMEOUT)return void this.forceLogout("Your session has expired after 8 hours. Please log in again for security.");if(i>SESSION_CONFIG.INACTIVITY_TIMEOUT)return void this.forceLogout("You have been logged out due to inactivity.");const s=SESSION_CONFIG.INACTIVITY_TIMEOUT-i;s<=SESSION_CONFIG.WARNING_THRESHOLD&&!this.warningShown&&(this.showSessionWarning(Math.ceil(s/6e4)),this.warningShown=!0)}showSessionWarning(t){let i=document.getElementById("sessionWarningBanner");i?document.getElementById("sessionWarningTime").textContent=t:(i=document.createElement("div"),i.id="sessionWarningBanner",i.className="alert alert-warning position-fixed top-0 start-50 translate-middle-x mt-3",i.style.cssText="z-index: 9999; max-width: 500px; box-shadow: 0 4px 12px rgba(0,0,0,0.15);",i.innerHTML=`\n        <div class="d-flex align-items-center justify-content-between">\n          <div>\n            <i class="bi bi-exclamation-triangle-fill me-2"></i>\n            <strong>Session expiring soon!</strong>\n            <p class="mb-0 small">You'll be logged out in <span id="sessionWarningTime">${t}</span> minute(s) due to inactivity.</p>\n          </div>\n          <button type="button" class="btn-close" data-action="dismiss-session-warning" aria-label="Close"></button>\n        </div>\n      `,document.body.appendChild(i))}hideSessionWarning(){const t=document.getElementById("sessionWarningBanner");t&&t.remove()}async forceLogout(t){this.stopSessionMonitoring(),this.clearAllSessionData(),await this.sb.auth.signOut(),t&&this.showLogoutMessage(t),this.onForceLogout&&this.onForceLogout(t)}clearAllSessionData(){window.dataCache&&Object.keys(window.dataCache).forEach(t=>delete window.dataCache[t]),window.assets=[],window.investments=[],window.debts=[],window.bills=[],window.income=[],window.snapshots=[],window.settings={},window.netWorthChart&&"function"==typeof window.netWorthChart.destroy&&window.netWorthChart.destroy(),window.cashFlowChart&&"function"==typeof window.cashFlowChart.destroy&&window.cashFlowChart.destroy(),window.emergencyFundChart&&"function"==typeof window.emergencyFundChart.destroy&&window.emergencyFundChart.destroy()}showLogoutMessage(t){const i=document.getElementById("sessionTimeoutModal");i&&i.remove();const s=`\n      <div class="modal fade" id="sessionTimeoutModal" tabindex="-1" data-bs-backdrop="static" data-bs-keyboard="false">\n        <div class="modal-dialog modal-dialog-centered">\n          <div class="modal-content">\n            <div class="modal-header bg-warning">\n              <h5 class="modal-title">\n                <i class="bi bi-shield-exclamation me-2"></i>Session Expired\n              </h5>\n            </div>\n            <div class="modal-body">\n              <p>${t}</p>\n            </div>\n            <div class="modal-footer">\n              <button type="button" class="btn btn-primary" data-bs-dismiss="modal" data-action="reload-page">\n                <i class="bi bi-box-arrow-in-right me-1"></i>Log In Again\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;document.body.insertAdjacentHTML("beforeend",s),bootstrap.Modal.getOrCreateInstance(document.getElementById("sessionTimeoutModal")).show()}loadLoginAttempts(){try{const t=sessionStorage.getItem("login_attempts");return t?JSON.parse(t):[]}catch{return[]}}saveLoginAttempts(){try{sessionStorage.setItem("login_attempts",JSON.stringify(this.loginAttempts))}catch(t){}}recordLoginAttempt(t,i){const s=Date.now();return this.loginAttempts=this.loginAttempts.filter(t=>s-t.timestamp<SESSION_CONFIG.LOGIN_ATTEMPT_WINDOW),this.loginAttempts.push({timestamp:s,success:t,email:i?this.hashEmail(i):null}),this.saveLoginAttempts(),!t&&this.isAccountLocked()?{locked:!0,message:`Too many failed login attempts. Please wait ${this.getLockoutMinutes()} minutes before trying again.`}:{locked:!1}}isAccountLocked(){const t=Date.now();return this.loginAttempts.filter(i=>!i.success&&t-i.timestamp<SESSION_CONFIG.LOGIN_ATTEMPT_WINDOW).length>=SESSION_CONFIG.MAX_LOGIN_ATTEMPTS}getLockoutMinutes(){if(0===this.loginAttempts.length)return 0;const t=this.loginAttempts[0],i=Date.now()-t.timestamp,s=SESSION_CONFIG.LOGIN_ATTEMPT_WINDOW-i;return Math.ceil(s/6e4)}clearLoginAttempts(){this.loginAttempts=[],this.saveLoginAttempts()}hashEmail(t){let i=0;for(let s=0;s<t.length;s++)i=(i<<5)-i+t.charCodeAt(s),i&=i;return i.toString(36)}async validateSessionIntegrity(){try{const{data:{session:t},error:i}=await this.sb.auth.getSession();return i?(this.forceLogout("Session validation failed. Please log in again."),!1):!(!t||t.expires_at&&1e3*t.expires_at<Date.now()&&(this.forceLogout("Your session has expired. Please log in again."),1))}catch(t){return this.forceLogout("Session integrity check failed. Please log in again."),!1}}onLogin(){this.clearLoginAttempts(),this.startSessionMonitoring()}onLogout(){this.stopSessionMonitoring(),this.clearAllSessionData()}extendSession(){this.recordActivity()}}window.SessionSecurityManager=SessionSecurityManager,document.addEventListener("click",t=>{const i=t.target.closest("[data-action]")?.dataset.action;"reload-page"===i?location.reload():"dismiss-session-warning"===i&&window.sessionSecurity?.hideSessionWarning()});