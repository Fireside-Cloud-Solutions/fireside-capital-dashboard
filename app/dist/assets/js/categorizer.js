const DEBUG_CATEGORIZER=!1;function debugLog(...e){}const CATEGORIES=["dining","groceries","transportation","utilities","entertainment","shopping","healthcare","travel","bills","income","other","uncategorized"],MERCHANT_KEYWORDS={dining:["starbucks","mcdonald","chipotle","doordash","ubereats","grubhub","subway","dominos","pizza hut","chick-fil-a","olive garden","applebee","denny","waffle house","five guys","shake shack","wingstop","panera","taco bell","burger king","wendy","popeyes","raising cane","culver","sonic drive","jack in the box","dairy queen","little caesar","papa john","door dash","uber eats","postmates","caviar","seamless","instacart meals","restaurant","diner","cafe","bistro","grill ","sushi","ramen","bbq","coffee shop","dunkin","tim horton","peet","dutch bros","boba","smoothie king","jamba juice","tropical smoothie","la madeleine","in-n-out","whataburger","cookout","steak n shake","hardee"],groceries:["walmart supercenter","walmart grocery","target grocery","costco","kroger","safeway","whole foods","trader joe","aldi","publix","sprouts","food lion","h-e-b","heb ","meijer","wegman","giant food","stop & shop","shoprite","winn dixie","bi-lo","piggly wiggly","fresh market","fresh thyme","market basket","save a lot","grocery outlet","smart & final","stater bros","vons","pavilions","ralphs","king soopers","harris teeter","grocery","supermarket","food mart","food store","bodega","instacart","shipt ","amazon fresh","imperfect foods","misfit market","butcher box","good food"],transportation:["uber ","lyft","bird scooter","lime scooter","shell oil","shell gas","chevron","bp gas","exxon","speedway","wawa ","sunoco","mobil ","marathon gas","citgo","casey","kwik trip","pilot flying","loves travel","ta express","parkway toll","e-zpass","sunpass","tollway","tollroad","metro card","transit","mta ","bart ","cta ","septa","wmata","amtrak","greyhound","flixbus","enterprise rent","hertz","avis ","budget rental","zipcar","turo ","parking ","parkmobile","spothero","lazepark","jiffy lube","midas ","firestone","valvoline","pep boys","gas station","fuel ","tesla charging","ev charging","electrify america","chargepoint","blink ev","auto repair","car wash","jiffy lube"],utilities:["at&t ","verizon","t-mobile","spectrum ","xfinity","cox comm","comcast","pg&e","national grid","duke energy","dominion energy","american electric","con ed","consolidated edison","georgia power","florida power","pse&g","comed ","centerpoint","reliant energy","txu energy","entergy","electric bill","gas bill","water bill","internet service","phone bill","dish network","directv","google fi","mint mobile","visible wireless","boost mobile","cricket wireless","metro pcs","straight talk","tracfone","republic wireless","ting mobile","us cellular","c spire","sewer ","garbage collection","waste management"],entertainment:["netflix","hulu","disney+","disneyplus","hbo max","hbomax","paramount+","peacock","apple tv+","appletv","youtube premium","crunchyroll","funimation","discovery+","showtime","starz","spotify","apple music","youtube music","tidal ","pandora","amazon music","deezer","soundcloud","steam ","playstation","xbox game","nintendo","epic games","twitch","humble bundle","gog.com","amc theater","regal cinema","cinemark","fandango","ticketmaster","stubhub","eventbrite","bowling","arcade","dave & buster","topgolf","mini golf","escape room","trampoline","axe throwing","laser tag","paintball","go-kart","audible","kindle","book of the month","scribd","masterclass","skillshare","coursera","udemy"],shopping:["amazon.com","amazon mktp","amazon prime","walmart.com","target.com","best buy","apple store","apple.com","home depot","lowe's","menards","ace hardware","true value","gap ","old navy","banana republic","zara ","h&m ","uniqlo","forever 21","macy's","macy ","nordstrom","bloomingdale","neiman marcus","saks ","tj maxx","ross store","burlington coat","marshalls","dollar general","dollar tree","five below","gamestop","game stop","ikea","wayfair","chewy","etsy","ebay","shein","wish.com","overstock","bed bath","pottery barn","crate & barrel","williams sonoma","pier 1","michaels store","hobby lobby","joann fabric","petco","petsmart","paw","pet supplies","autozone","o'reilly auto","advance auto","napa auto","foot locker","finish line","dick's sporting","rei ","patagonia","lululemon","athleta","columbia sportswear","sephora","ulta beauty","bath & body","victoria secret"],healthcare:["cvs pharmacy","cvs ","walgreen","rite aid","united health","blue cross","aetna","cigna","humana","kaiser","bcbs ","anthem","express scripts","caremark","goodrx","mark cuban cost plus","pharmacy","drugstore","urgent care","hospital","clinic","medical center","health system","health clinic","dentist","dental ","orthodon","vision center","eyeglass","lenscrafters","warby parker","americas best","doctor ","physician","lab corp","quest diagn","therapy","counseling","chiropractic","physical therapy","dermatol","optometr","obgyn","planned parenthood","teladoc","mdlive","nurx","hims ","ro health","gym ","planet fitness","la fitness","anytime fitness","gold's gym","24 hour fitness","equinox","orangetheory","crunch fitness","barre3","pure barre","f45 training","ymca","classpass"],travel:["american airlines","delta air","southwest air","united airlines","jetblue","alaska airlines","spirit air","frontier air","allegiant","sun country","hawaiian air","air canada","marriott","hilton ","hyatt ","ihg ","best western","holiday inn","hampton inn","courtyard by marriott","fairfield inn","embassy suites","westin","sheraton","four seasons","ritz carlton","w hotel","airbnb","vrbo","booking.com","expedia","hotels.com","kayak ","priceline","hopper","google flights","travel insurance","trip protection","carnival cruise","royal caribbean","norwegian cruise","disney cruise","celebrity cruise","princess cruise","tsa precheck","global entry","clear lane","airport parking","hotel parking"],bills:["mortgage payment","mortgage ","rent payment","rent ","loan payment","auto loan","student loan","personal loan","state farm","allstate","geico ","progressive ins","farmers ins","liberty mutual","usaa ","nationwide ins","traveler","country financial","life insurance","health insurance","renters insurance","homeowners ins","flood insurance","credit card payment","card payment","prop tax","property tax","hoa ","homeowners assoc","utility payment","bill pay"],income:["direct deposit","payroll deposit","ach deposit","transfer from ","zelle from ","venmo from ","cashapp from ","paypal transfer in","stripe payout","square payout","freelance payment","consulting fee","tax refund","irs treas","state refund","stimulus ","economic impact","unemployment ins","social security","ssa treas","pension payment","dividend ","interest credit","interest earned","refund ","cashback reward","credit applied"]};function categorizeByKeyword(e){const a=[e.merchant_name||"",e.description||"",e.name||""].join(" ").toLowerCase();for(const[e,t]of Object.entries(MERCHANT_KEYWORDS))for(const r of t)if(a.includes(r))return{category:e,confidence:.85,source:"keyword"};return null}async function categorizeTransaction(e){try{const a=categorizeByKeyword(e);if(a)return debugLog(`[L1] Keyword match for "${e.merchant_name}": ${a.category}`),{...a,ai_generated:!1};const t=await checkLearnedPattern(e.merchant_name);return t?(debugLog(`[L2] Learned pattern for "${e.merchant_name}": ${t.category}`),{category:t.category,confidence:t.confidence,ai_generated:!1,source:"learned"}):(debugLog(`[L3] No match for "${e.merchant_name}" — uncategorized`),{category:"uncategorized",confidence:0,ai_generated:!1,source:"none"})}catch(e){return{category:"uncategorized",confidence:0,ai_generated:!1,source:"error"}}}async function categorizeTransactionsBatch(e){debugLog(`Categorizing ${e.length} transactions (batch mode)...`);const a=e.map(e=>{const a=categorizeByKeyword(e);return a?{...e,...a,ai_generated:!1}:{...e,category:"uncategorized",confidence:0,source:"none",ai_generated:!1}}),t=a.filter(e=>"uncategorized"===e.category);if(t.length>0&&"undefined"!=typeof sb)try{const e=await sb.auth.getUser();if(e?.data?.user){const a=t.map(e=>(e.merchant_name||e.name||"").toLowerCase().replace(/[^a-z0-9]/g,"")).filter(Boolean);if(a.length>0){const{data:r,error:n}=await sb.from("transaction_category_patterns").select("merchant_pattern, category, confidence").eq("user_id",e.data.user.id).in("merchant_pattern",a).order("confidence",{ascending:!1});if(!n&&r&&r.length>0)for(const e of t){const a=(e.merchant_name||e.name||"").toLowerCase().replace(/[^a-z0-9]/g,""),t=r.find(e=>e.merchant_pattern===a);t&&(e.category=t.category,e.confidence=t.confidence,e.source="learned")}}}}catch(e){debugLog("Layer 2 batch query failed (non-fatal):",e.message)}return debugLog(`Categorization complete: ${a.filter(e=>"uncategorized"!==e.category).length}/${a.length} categorized`),a}async function checkLearnedPattern(e){try{if("undefined"==typeof sb)return null;const a=await sb.auth.getUser();if(!a?.data?.user)return null;const t=(e||"").toLowerCase().replace(/[^a-z0-9]/g,"");if(!t)return null;const{data:r,error:n}=await sb.from("transaction_category_patterns").select("*").eq("user_id",a.data.user.id).eq("merchant_pattern",t).order("confidence",{ascending:!1}).limit(1);return n||!r||0===r.length?null:r[0]}catch(e){return debugLog("Pattern check error:",e),null}}async function learnCategoryPattern(e,a){try{if("undefined"==typeof sb)return;const t=await sb.auth.getUser();if(!t?.data?.user)return;const{data:r}=await sb.from("transactions").select("merchant_name, name").eq("id",e).single();if(!r)return;const n=(r.merchant_name||r.name||"").toLowerCase().replace(/[^a-z0-9]/g,"");if(!n)return;debugLog(`Learning pattern: "${n}" → ${a}`);const{data:o}=await sb.from("transaction_category_patterns").select("id, confidence, times_used").eq("user_id",t.data.user.id).eq("merchant_pattern",n).eq("category",a).maybeSingle();o?await sb.from("transaction_category_patterns").update({confidence:Math.min(1,o.confidence+.1),times_used:o.times_used+1,last_used:(new Date).toISOString()}).eq("id",o.id):await sb.from("transaction_category_patterns").insert({user_id:t.data.user.id,merchant_pattern:n,category:a,confidence:1,times_used:1,last_used:(new Date).toISOString()}),debugLog("Pattern learned successfully")}catch(e){}}