const SUBSCRIPTION_KEYWORDS=["netflix","hulu","disney","hbo","prime video","paramount","peacock","apple tv","youtube premium","crunchyroll","funimation","discovery+","spotify","apple music","youtube music","tidal","pandora","amazon music","soundcloud","planet fitness","la fitness","crunch","peloton","classpass","gym","fitness","adobe","microsoft 365","dropbox","icloud","google one","github","notion","evernote","canva","grammarly","zoom","nytimes","wsj","washington post","medium","substack","new york times","wall street","amazon prime","costco","sams club","patreon","onlyfans","subscription","monthly","membership"];function isLikelySubscription(t){if(!t)return!1;if("subscriptions"===t.type)return!0;if("monthly"!==t.frequency)return!1;const e=(t.name||"").toLowerCase();return SUBSCRIPTION_KEYWORDS.some(t=>e.includes(t))}async function detectAllSubscriptions(){return currentUser?(window.bills||[]).filter(t=>{const e=getBillFinancingInfo(t);return!(e.isFinancing&&"paid_off"===e.status)}).filter(isLikelySubscription):[]}async function calculateSubscriptionTotal(){return(await detectAllSubscriptions()).reduce((t,e)=>{const n=getShareInfoForBill(e.id),s=n&&"accepted"===n.status?n.owner_amount:e.amount;return t+getRaw(s)},0)}async function getTopSubscriptions(t=4){return(await detectAllSubscriptions()).sort((t,e)=>getRaw(e.amount)-getRaw(t.amount)).slice(0,t)}async function markAsSubscription(t,e){if(!currentUser||!t)return;try{"undefined"!=typeof CSRF&&CSRF.requireValidToken()}catch(t){return void alert(t.message)}const n=e?"subscriptions":"other",{error:s}=await sb.from("bills").update({type:n}).eq("id",t).eq("user_id",currentUser.id);s?alert("Failed to update subscription status. Please try again."):("function"==typeof clearCache&&clearCache(),"function"==typeof fetchAllDataFromSupabase&&await fetchAllDataFromSupabase(!0))}async function loadSubscriptionWidget(){if(document.getElementById("subscriptionsWidget"))try{const t=await detectAllSubscriptions(),e=await calculateSubscriptionTotal(),n=document.getElementById("subscriptionCount"),s=document.getElementById("subscriptionTotal");n&&(n.textContent=t.length),s&&(s.textContent=formatCurrency(e));const i=document.getElementById("subscriptionsList");if(!i)return;if(0===t.length)return void("function"==typeof generateEmptyStateHTML?i.innerHTML=generateEmptyStateHTML("subscriptions"):i.innerHTML='\n          <p class="text-muted text-center py-3">\n            <i class="bi bi-info-circle me-2"></i>\n            No subscriptions detected yet. Add monthly bills to track them here.\n          </p>\n        ');const a=t.sort((t,e)=>getRaw(e.amount)-getRaw(t.amount)).slice(0,4);i.innerHTML=a.map(t=>{const e=getShareInfoForBill(t.id),n=e&&"accepted"===e.status?e.owner_amount:t.amount;return`\n        <div class="d-flex justify-content-between align-items-center py-2" style="border-bottom: 1px solid var(--color-border-subtle);">\n          <div>\n            <strong>${escapeHtml(t.name)}</strong>\n            <small class="text-muted d-block">${formatCurrency(n)}/month</small>\n          </div>\n          <button class="btn btn-sm btn-link text-danger" onclick="removeSubscription('${escapeAttribute(t.id)}')" aria-label="Remove ${escapeAttribute(t.name)} from subscriptions">\n            <i class="bi bi-x-circle"></i>\n          </button>\n        </div>\n      `}).join("")}catch(t){const e=document.getElementById("subscriptionsList");e&&(e.innerHTML='\n        <p class="text-danger text-center py-3">\n          <i class="bi bi-exclamation-triangle me-2"></i>\n          Failed to load subscriptions\n        </p>\n      ')}}async function removeSubscription(t){showConfirmModal("Remove Subscription","Mark this as not a subscription?",async()=>{await markAsSubscription(t,!1),await loadSubscriptionWidget(),"function"==typeof updateDashboardCards&&updateDashboardCards(),"function"==typeof renderBills&&renderBills()},{confirmText:"Remove",confirmClass:"btn-warning"})}function filterBillsToSubscriptions(){const t=document.getElementById("billTableBody");if(!t)return;const e=(window.bills||[]).filter(isLikelySubscription),n=document.getElementById("showAllBillsBtn"),s=document.getElementById("showSubscriptionsBtn");n&&(n.classList.remove("active"),n.setAttribute("aria-pressed","false")),s&&(s.classList.add("active"),s.setAttribute("aria-pressed","true")),0!==e.length?t.innerHTML=e.map(t=>{const e=getShareInfoForBill(t.id),n=e&&"accepted"===e.status?e.owner_amount:t.amount,s=getCategoryBadgeClass(t.type);return`\n      <tr>\n        <td>${escapeHtml(t.name)}</td>\n        <td><span class="badge ${s}">${escapeHtml(toTitleCase(t.type))}</span></td>\n        <td>${formatCurrency(n)}</td>\n        <td>${escapeHtml(toTitleCase(t.frequency))}</td>\n        <td>${t.nextDueDate?escapeHtml(formatDate(t.nextDueDate)):"-"}</td>\n        <td>\n          <button class="btn btn-sm btn-outline-primary" onclick="openBillModal('${escapeAttribute(t.id)}')" aria-label="Edit ${escapeAttribute(t.name)}">\n            <i class="bi bi-pencil"></i>\n          </button>\n          <button class="btn btn-sm btn-outline-danger" onclick="confirmDeleteBill('${escapeAttribute(t.id)}', '${escapeAttribute(t.name)}')" aria-label="Delete ${escapeAttribute(t.name)}">\n            <i class="bi bi-trash"></i>\n          </button>\n        </td>\n      </tr>\n    `}).join(""):t.innerHTML='\n      <tr>\n        <td colspan="6" class="text-center py-5">\n          <div class="text-muted">\n            <i class="bi bi-inbox" style="font-size: 3rem; opacity: 0.3;"></i>\n            <p class="mt-3 mb-0">No subscriptions detected</p>\n            <small>Add monthly recurring bills to track subscriptions</small>\n          </div>\n        </td>\n      </tr>\n    '}function showAllBills(){const t=document.getElementById("showAllBillsBtn"),e=document.getElementById("showSubscriptionsBtn");t&&(t.classList.add("active"),t.setAttribute("aria-pressed","true")),e&&(e.classList.remove("active"),e.setAttribute("aria-pressed","false")),"function"==typeof renderBills&&renderBills()}async function renderSubscriptionInsights(){const t=document.getElementById("subscriptionInsights");if(!t)return;const e=await detectAllSubscriptions(),n=await calculateSubscriptionTotal();if(0===e.length)return void(t.innerHTML='\n      <div class="alert alert-info">\n        <i class="bi bi-info-circle me-2"></i>\n        No subscriptions detected. Add monthly recurring bills to track subscriptions.\n      </div>\n    ');const s=e.reduce((t,e)=>getRaw(e.amount)>getRaw(t.amount)?e:t,e[0]);t.innerHTML=`\n    <div class="row g-3">\n      <div class="col-md-4">\n        <div class="card">\n          <div class="card-body">\n            <h6 class="text-muted mb-2">Total Monthly Cost</h6>\n            <h3 class="mb-0">${formatCurrency(n)}</h3>\n            <small class="text-muted">${e.length} active subscription${1!==e.length?"s":""}</small>\n          </div>\n        </div>\n      </div>\n      <div class="col-md-4">\n        <div class="card">\n          <div class="card-body">\n            <h6 class="text-muted mb-2">Largest Subscription</h6>\n            <h4 class="mb-0">${escapeHtml(s.name)}</h4>\n            <small class="text-muted">${formatCurrency(s.amount)}/month</small>\n          </div>\n        </div>\n      </div>\n      <div class="col-md-4">\n        <div class="card">\n          <div class="card-body">\n            <h6 class="text-muted mb-2">Annual Cost</h6>\n            <h3 class="mb-0">${formatCurrency(12*n)}</h3>\n            <small class="text-muted">Based on current subscriptions</small>\n          </div>\n        </div>\n      </div>\n    </div>\n  `}"undefined"!=typeof document&&document.addEventListener("DOMContentLoaded",()=>{const t=setInterval(()=>{currentUser&&window.bills&&(clearInterval(t),document.getElementById("subscriptionsWidget")&&loadSubscriptionWidget(),document.getElementById("subscriptionInsights"))&&(renderSubscriptionInsights(),"subscriptions"===new URLSearchParams(window.location.search).get("filter")&&filterBillsToSubscriptions())},500);setTimeout(()=>clearInterval(t),1e4)});