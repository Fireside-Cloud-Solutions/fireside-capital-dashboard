<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>CSRF Protection Test</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
</head>
<body>
  <div class="container mt-5">
    <h1>CSRF Protection Test</h1>
    
    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Token Status</h5>
        <p><strong>Token:</strong> <code id="tokenDisplay">Not loaded</code></p>
        <p><strong>Expiry:</strong> <span id="expiryDisplay">Not set</span></p>
        <button class="btn btn-primary" onclick="displayToken()">Show Token</button>
        <button class="btn btn-secondary" onclick="refreshToken()">Refresh Token</button>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Test Form</h5>
        <form id="testForm">
          <div class="mb-3">
            <label for="testInput" class="form-label">Test Input</label>
            <input type="text" class="form-control" id="testInput" value="Test data">
          </div>
          <button type="button" class="btn btn-success" onclick="testValidation()">Test Validation</button>
        </form>
        <div id="validationResult" class="mt-3"></div>
      </div>
    </div>

    <div class="card mt-4">
      <div class="card-body">
        <h5 class="card-title">Test Results</h5>
        <div id="testResults">
          <p class="text-muted">Run tests to see results</p>
        </div>
      </div>
    </div>
  </div>

  <script src="assets/js/csrf.js"></script>
  <script>
    function displayToken() {
      const token = CSRF.getToken();
      document.getElementById('tokenDisplay').textContent = token ? token.substring(0, 16) + '...' : 'No token';
      
      const expiry = sessionStorage.getItem('csrfTokenExpiry');
      if (expiry) {
        const date = new Date(parseInt(expiry));
        document.getElementById('expiryDisplay').textContent = date.toLocaleString();
      }
    }

    function refreshToken() {
      const newToken = CSRF.refreshToken();
      displayToken();
      showResult('success', 'Token refreshed successfully!');
    }

    function testValidation() {
      const resultDiv = document.getElementById('validationResult');
      
      try {
        CSRF.requireValidToken();
        showResult('success', '✅ CSRF validation passed!');
      } catch (err) {
        showResult('danger', '❌ CSRF validation failed: ' + err.message);
      }
    }

    function showResult(type, message) {
      const resultDiv = document.getElementById('testResults');
      const alert = document.createElement('div');
      alert.className = `alert alert-${type}`;
      alert.textContent = message + ' (' + new Date().toLocaleTimeString() + ')';
      resultDiv.appendChild(alert);
    }

    // Run auto-tests on load
    window.addEventListener('load', () => {
      displayToken();
      
      // Test 1: Token generation
      const token1 = CSRF.getToken();
      if (token1 && token1.length === 64) {
        showResult('success', 'Test 1: Token generation - PASSED');
      } else {
        showResult('danger', 'Test 1: Token generation - FAILED');
      }

      // Test 2: Token validation
      try {
        CSRF.requireValidToken();
        showResult('success', 'Test 2: Token validation - PASSED');
      } catch (err) {
        showResult('danger', 'Test 2: Token validation - FAILED');
      }

      // Test 3: Form protection
      CSRF.protectAllForms();
      const testForm = document.getElementById('testForm');
      const tokenInput = testForm.querySelector('input[name="csrf_token"]');
      if (tokenInput && tokenInput.value === token1) {
        showResult('success', 'Test 3: Form protection - PASSED');
      } else {
        showResult('danger', 'Test 3: Form protection - FAILED');
      }

      // Test 4: Token persistence
      const token2 = CSRF.getToken();
      if (token1 === token2) {
        showResult('success', 'Test 4: Token persistence - PASSED');
      } else {
        showResult('danger', 'Test 4: Token persistence - FAILED');
      }
    });
  </script>
</body>
</html>

